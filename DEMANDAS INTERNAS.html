<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>CONSOLIDA - Dashboard de Demandas Internas</title>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700;800;900&family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

    <!-- Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

    <style>
        :root {
            --ip-blue: #0045B5;
            --ip-blue-dark: #00328A;
            --ip-yellow: #FFD100;
            --ip-yellow-dark: #E6BC00;
            --ip-orange: #FF6900;
            --ip-orange-dark: #E05E00;
            --ip-indigo: #0068FF;
            --ip-aqua: #00D9B8;
            --ip-green: #00C48C;
            --ip-purple: #7C3AED;
            --ip-chumbo: #58595B;
            --ip-asfalto: #939598;

            --bg-body: #F0F2F5;
            --bg-card: #FFFFFF;
            --bg-sidebar: #FFFFFF;
            --text-primary: #1A202C;
            --text-secondary: #64748B;
            --text-muted: #94A3B8;
            --border-light: #E2E8F0;
            --border-medium: #CBD5E1;

            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.08);
            --shadow-lg: 0 10px 25px rgba(0, 0, 0, 0.12);
            --shadow-xl: 0 20px 50px rgba(0, 0, 0, 0.15);

            --radius-sm: 6px;
            --radius-md: 10px;
            --radius-lg: 16px;
            --radius-xl: 20px;

            --transition: 0.25s cubic-bezier(0.4, 0, 0.2, 1);

            --header-height: 70px;
            --sidebar-width: 280px;
            --sidebar-collapsed: 80px;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: Inter, sans-serif;
            background: var(--bg-body);
            color: var(--text-primary);
            line-height: 1.6;
            overflow-x: hidden;
        }

        .main-header {
            height: var(--header-height);
            background: var(--ip-blue);
            color: white;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 30px;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            box-shadow: var(--shadow-lg);
            border-bottom: 4px solid var(--ip-yellow);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .header-logo {
            width: 44px;
            height: 44px;
            background: var(--ip-yellow);
            color: var(--ip-blue);
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 900;
            font-size: 22px;
            font-family: Montserrat, sans-serif;
            transition: var(--transition);
        }

        .header-logo:hover {
            transform: rotate(10deg) scale(1.05);
        }

        .header-titles {
            display: flex;
            flex-direction: column;
        }

        .header-title {
            font-weight: 800;
            font-size: 18px;
            letter-spacing: 0.3px;
            color: white;
            font-family: Montserrat, sans-serif;
        }

        .header-subtitle {
            font-size: 11px;
            opacity: 0.9;
            font-weight: 500;
            margin-top: 2px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: rgba(255, 255, 255, 0.9);
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .header-stats {
            display: flex;
            gap: 20px;
        }

        .stat-item {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.15);
            border-radius: var(--radius-sm);
            border: 1px solid rgba(255, 255, 255, 0.25);
            min-width: 100px;
            backdrop-filter: blur(10px);
            transition: var(--transition);
        }

        .stat-item:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }

        .stat-value {
            font-weight: 800;
            font-size: 18px;
            line-height: 1;
            font-family: Montserrat, sans-serif;
            color: white;
        }

        .stat-label {
            font-size: 10px;
            opacity: 0.9;
            font-weight: 600;
            margin-top: 4px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: white;
        }

        .header-actions {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .btn {
            border-radius: var(--radius-md);
            border: none;
            padding: 10px 16px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: linear-gradient(135deg, var(--ip-blue), var(--ip-indigo));
            color: white;
            box-shadow: var(--shadow-md);
            transition: var(--transition);
            font-family: Inter, sans-serif;
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-lg);
        }

        .btn-icon {
            border-radius: 999px;
            width: 38px;
            height: 38px;
            padding: 0;
            justify-content: center;
        }

        .btn-outline {
            background: transparent;
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.7);
            box-shadow: none;
        }

        .btn-outline:hover {
            background: rgba(255, 255, 255, 0.12);
            box-shadow: none;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #0F172A, #1E293B);
            color: white;
        }

        .btn-secondary:hover {
            background: linear-gradient(135deg, #111827, #020617);
        }

        .btn.w-full {
            width: 100%;
            justify-content: center;
        }

        .app-container {
            display: flex;
            min-height: 100vh;
            padding-top: var(--header-height);
        }

        .sidebar {
            width: var(--sidebar-collapsed);
            background: var(--bg-sidebar);
            border-right: 1px solid var(--border-light);
            position: fixed;
            left: 0;
            top: var(--header-height);
            bottom: 0;
            z-index: 900;
            overflow-y: auto;
            overflow-x: hidden;
            transition: var(--transition);
            padding-top: 25px;
            box-shadow: var(--shadow-md);
        }

        .sidebar:hover {
            width: var(--sidebar-width);
            box-shadow: 10px 0 40px rgba(0, 0, 0, 0.1);
        }

        .sidebar-icons {
            position: absolute;
            left: 0;
            top: 25px;
            width: var(--sidebar-collapsed);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 30px;
            pointer-events: none;
            transition: opacity var(--transition);
        }

        .sidebar-icon {
            font-size: 22px;
            color: var(--ip-blue);
            opacity: 0.7;
            transition: var(--transition);
            padding: 12px;
            background: rgba(0, 69, 181, 0.1);
            border-radius: var(--radius-md);
            width: 52px;
            height: 52px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .sidebar:hover .sidebar-icons {
            opacity: 0;
        }

        .sidebar-content {
            width: var(--sidebar-width);
            padding: 0 24px;
            opacity: 0;
            transform: translateX(-15px);
            transition: opacity 0.3s 0.1s, transform 0.3s 0.1s;
        }

        .sidebar:hover .sidebar-content {
            opacity: 1;
            transform: translateX(0);
        }

        .section-title {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            color: var(--ip-blue);
            font-weight: 700;
            margin-bottom: 18px;
            position: relative;
            padding-bottom: 12px;
            font-family: Montserrat, sans-serif;
        }

        .section-title::after {
            content: "";
            position: absolute;
            bottom: 0;
            left: 0;
            width: 30px;
            height: 3px;
            background: linear-gradient(90deg, var(--ip-blue), var(--ip-yellow));
            border-radius: 2px;
        }

        .filter-group {
            margin-bottom: 18px;
        }

        .filter-label {
            font-size: 11px;
            color: var(--text-secondary);
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            margin-bottom: 6px;
            display: block;
        }

        .form-control {
            width: 100%;
            padding: 8px 10px;
            border-radius: var(--radius-md);
            border: 1px solid var(--border-light);
            background: #F8FAFC;
            font-size: 13px;
            color: var(--text-primary);
            outline: none;
            transition: var(--transition);
        }

        .form-control:focus {
            border-color: var(--ip-blue);
            box-shadow: 0 0 0 1px rgba(0, 69, 181, 0.12);
            background: #FFFFFF;
        }

        .select-wrapper {
            position: relative;
        }

        .select-wrapper::after {
            content: "\f107";
            font-family: "Font Awesome 6 Free";
            font-weight: 900;
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 12px;
            color: var(--text-muted);
            pointer-events: none;
        }

        .main-content {
            flex: 1;
            padding: 30px;
            margin-left: var(--sidebar-collapsed);
            overflow-y: auto;
            transition: var(--transition);
            background: var(--bg-body);
        }

        .main-content::-webkit-scrollbar {
            width: 8px;
        }

        .main-content::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.05);
            border-radius: 4px;
        }

        .main-content::-webkit-scrollbar-thumb {
            background: var(--ip-blue);
            border-radius: 4px;
        }

        .main-content::-webkit-scrollbar-thumb:hover {
            background: var(--ip-indigo);
        }

        .filter-indicator {
            background: transparent;
            border-radius: var(--radius-md);
            padding: 0;
            margin-bottom: 20px;
            display: none;
            flex-direction: column;
            gap: 10px;
            animation: slideDown 0.3s ease;
        }

        .filter-indicator.has-filters {
            display: flex;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .filter-chips-container {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .filter-chip {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: linear-gradient(135deg, var(--ip-yellow), #FFE44D);
            color: var(--ip-blue);
            padding: 8px 10px 8px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 700;
            border: 1px solid rgba(0, 69, 181, 0.2);
            box-shadow: 0 2px 8px rgba(255, 209, 0, 0.3);
            animation: chipIn 0.25s ease;
            transition: var(--transition);
        }

        @keyframes chipIn {
            from {
                opacity: 0;
                transform: scale(0.8);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .filter-chip:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 209, 0, 0.4);
        }

        .filter-chip-icon {
            font-size: 11px;
            opacity: 0.9;
            color: var(--ip-blue);
        }

        .filter-chip-label {
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 700;
            color: var(--ip-blue-dark);
        }

        .filter-chip-value {
            font-weight: 900;
            max-width: 100px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            color: var(--ip-blue);
        }

        .filter-chip-close {
            background: rgba(0, 69, 181, 0.15);
            border: none;
            color: var(--ip-blue);
            width: 18px;
            height: 18px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 10px;
            transition: var(--transition);
            margin-left: 2px;
        }

        .filter-chip-close:hover {
            background: var(--ip-blue);
            color: white;
            transform: scale(1.1);
        }

        .clear-all-filters {
            background: transparent;
            border: 1px dashed var(--ip-blue);
            color: var(--ip-blue);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 700;
            cursor: pointer;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .clear-all-filters:hover {
            background: var(--ip-blue);
            color: white;
            border-style: solid;
        }

        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .kpi-card {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            padding: 24px;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border-light);
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: var(--transition);
            position: relative;
            overflow: hidden;
            min-height: 120px;
        }

        .kpi-card::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--ip-blue), var(--ip-indigo));
            opacity: 0;
            transition: opacity 0.3s;
        }

        .kpi-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-lg);
            border-color: var(--ip-blue);
        }

        .kpi-card:hover::before {
            opacity: 1;
        }

        .kpi-content {
            display: flex;
            flex-direction: column;
            flex: 1;
        }

        .kpi-value {
            font-size: clamp(24px, 3.5vw, 32px);
            font-weight: 900;
            color: var(--text-primary);
            line-height: 1.2;
            margin-bottom: 8px;
            font-family: Montserrat, sans-serif;
        }

        .kpi-label {
            font-size: 12px;
            color: var(--text-secondary);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .kpi-label i {
            color: var(--ip-blue);
        }

        .kpi-icon {
            font-size: 36px;
            opacity: 0.2;
            color: var(--ip-blue);
            margin-left: 15px;
            transition: var(--transition);
        }

        .kpi-card:hover .kpi-icon {
            opacity: 0.3;
            transform: scale(1.1);
        }

        .kpi-card.active-filter {
            border-color: var(--ip-yellow);
            background: linear-gradient(135deg, rgba(255, 209, 0, 0.05), rgba(255, 209, 0, 0.1));
        }

        .kpi-card.active-filter::before {
            opacity: 1;
            background: linear-gradient(90deg, var(--ip-yellow), var(--ip-orange));
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .chart-card {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            padding: 24px;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border-light);
            transition: var(--transition);
            position: relative;
            overflow: hidden;
            min-height: 400px;
            display: flex;
            flex-direction: column;
        }

        .chart-card:hover {
            box-shadow: var(--shadow-lg);
            border-color: var(--ip-blue);
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #F1F5F9;
        }

        .chart-title {
            font-size: 16px;
            font-weight: 700;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .chart-title i {
            color: var(--ip-blue);
        }

        .chart-subtitle {
            font-size: 13px;
            color: var(--text-secondary);
            margin-top: 5px;
            font-weight: 500;
        }

        .chart-badge {
            background: linear-gradient(135deg, rgba(0, 69, 181, 0.1), rgba(0, 104, 255, 0.1));
            color: var(--ip-blue);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
            background: var(--bg-card);
            border-radius: var(--radius-md);
            padding: 15px;
            flex: 1;
        }

        .chart-card.full-width {
            grid-column: 1 / -1;
        }

        .table-card {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            overflow: hidden;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border-light);
        }

        .table-header {
            padding: 20px;
            border-bottom: 2px solid #F1F5F9;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .table-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .table-badge {
            background: linear-gradient(135deg, var(--ip-green), #00A876);
            color: white;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 700;
            letter-spacing: 0.5px;
        }

        .table-wrapper {
            overflow-x: auto;
            max-height: 600px;
        }

        .table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            font-size: 14px;
            min-width: 1000px;
        }

        .table thead {
            background: linear-gradient(135deg, #F8FAFC, #F1F5F9);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .table th {
            color: var(--ip-blue);
            font-weight: 700;
            padding: 18px 16px;
            text-align: left;
            border-bottom: 3px solid var(--ip-yellow);
            font-family: Montserrat, sans-serif;
            font-size: 13px;
            white-space: nowrap;
            transition: var(--transition);
        }

        .table th:hover {
            background: rgba(0, 69, 181, 0.1);
        }

        .table td {
            padding: 16px;
            border-bottom: 1px solid var(--border-light);
            transition: var(--transition);
        }

        .table tr:nth-child(even) {
            background-color: rgba(0, 0, 0, 0.02);
        }

        .table tr:hover {
            background-color: rgba(0, 69, 181, 0.1);
            cursor: pointer;
        }

        .pill {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            display: inline-block;
        }

        .pill-categoria {
            background: linear-gradient(135deg, rgba(0, 69, 181, 0.1), rgba(0, 104, 255, 0.1));
            color: var(--ip-blue);
        }

        .pill-duracao {
            background: linear-gradient(135deg, rgba(255, 209, 0, 0.2), rgba(255, 105, 0, 0.2));
            color: #B36600;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            z-index: 2000;
            display: none;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }

        .loading-content {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            padding: 40px;
            box-shadow: var(--shadow-xl);
            text-align: center;
            width: 400px;
            max-width: 90vw;
            border: 1px solid var(--border-light);
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(0, 69, 181, 0.1);
            border-top-color: var(--ip-blue);
            border-radius: 50%;
            margin: 0 auto 20px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            font-size: 16px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 10px;
        }

        @media (max-width: 1200px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 900px) {
            .app-container {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                height: auto;
                position: relative;
                top: 0;
                margin-top: 0;
                order: 2;
                box-shadow: none;
                border-right: none;
                border-top: 1px solid var(--border-light);
                padding: 20px;
            }

            .sidebar:hover {
                width: 100%;
            }

            .sidebar-icons {
                display: none;
            }

            .sidebar-content {
                opacity: 1;
                transform: none;
                width: 100%;
                padding: 0;
            }

            .main-content {
                order: 1;
                padding: 20px;
                margin-left: 0;
            }

            .kpi-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .main-header {
                flex-direction: column;
                height: auto;
                padding: 15px;
                gap: 15px;
            }

            .header-left,
            .header-right {
                width: 100%;
                justify-content: center;
                flex-wrap: wrap;
            }

            .header-stats {
                display: none;
            }

            .kpi-grid {
                grid-template-columns: 1fr;
            }

            .charts-grid {
                grid-template-columns: 1fr;
            }

            .chart-container {
                height: 250px;
            }
        }

        .main-filter-area {
            display: none;
            margin-bottom: 20px;
            padding: 16px 20px;
            background: linear-gradient(135deg, rgba(0, 69, 181, 0.03), rgba(0, 104, 255, 0.03));
            border-radius: var(--radius-lg);
            border: 1px solid var(--border-light);
            animation: slideDown 0.3s ease;
        }

        .main-filter-area.has-filters {
            display: block;
        }

        .main-filter-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
        }

        .main-filter-label {
            font-size: 12px;
            font-weight: 900;
            color: var(--ip-blue-dark);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-right: 8px;
        }

        .toast {
            font-family: Inter, sans-serif;
        }

        body.dark-mode {
            --bg-body: #0F172A;
            --bg-card: #020617;
            --bg-sidebar: #020617;
            --text-primary: #E2E8F0;
            --text-secondary: #9CA3AF;
            --text-muted: #6B7280;
            --border-light: #1F2937;
            --border-medium: #374151;
        }

        body.dark-mode .main-header {
            background: linear-gradient(90deg, #020617, #0F172A);
            border-bottom-color: var(--ip-yellow);
        }

        body.dark-mode .stat-item {
            background: rgba(15, 23, 42, 0.8);
            border-color: rgba(148, 163, 184, 0.3);
        }

        body.dark-mode .sidebar {
            box-shadow: none;
        }

        body.dark-mode .kpi-card,
        body.dark-mode .chart-card,
        body.dark-mode .table-card,
        body.dark-mode .loading-content {
            background: #020617;
            border-color: #1F2937;
        }

        body.dark-mode .table thead {
            background: linear-gradient(135deg, #020617, #111827);
        }

        body.dark-mode .table tr:nth-child(even) {
            background-color: rgba(15, 23, 42, 0.6);
        }

        body.dark-mode .table tr:hover {
            background-color: rgba(30, 64, 175, 0.4);
        }

        body.dark-mode .form-control {
            background: #020617;
            border-color: #1F2937;
            color: var(--text-primary);
        }

        body.dark-mode .form-control:focus {
            border-color: var(--ip-blue);
            box-shadow: 0 0 0 1px rgba(59, 130, 246, 0.5);
        }

        body.dark-mode .filter-chip {
            background: linear-gradient(135deg, #FBBF24, #F97316);
            color: #111827;
        }

        body.dark-mode .chart-container {
            background: #020617;
        }
    </style>
</head>
<body>
    <header class="main-header">
        <div class="header-left">
            <div class="header-logo">C</div>
            <div class="header-titles">
                <div class="header-title">CONSOLIDA DEMANDAS INTERNAS</div>
                <div class="header-subtitle">Dashboard Interativo Gestão de Atividades</div>
            </div>
        </div>
        <div class="header-right">
            <div class="header-stats">
                <div class="stat-item">
                    <div class="stat-value" id="headerTotal">0</div>
                    <div class="stat-label">Total Demandas</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="headerTMR">0 min</div>
                    <div class="stat-label">TMR Geral</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="headerAnalistas">0</div>
                    <div class="stat-label">Analistas</div>
                </div>
            </div>
            <div class="header-actions">
                <!-- Botão Home modificado -->
                <button class="btn btn-icon" onclick="window.location.href='https://thiccoipp.github.io/backendipp/FINAL.html'" title="Voltar para Home">
                    <i class="fa-solid fa-house"></i>
                </button>
                <button class="btn btn-icon" onclick="toggleSidebar()" title="Alternar Sidebar">
                    <i class="fa-solid fa-bars"></i>
                </button>
                <button class="btn btn-icon" onclick="toggleDarkMode()" title="Modo Escuro">
                    <i class="fa-solid fa-moon"></i>
                </button>
            </div>
        </div>
    </header>

    <div class="loading-overlay" id="loading">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <div class="loading-text" id="loadingText">Processando seus dados...</div>
            <div style="margin-top: 20px; width: 100%; height: 6px; background: rgba(0,69,181,0.1); border-radius: 3px; overflow: hidden;">
                <div id="loadingProgress" style="width: 0; height: 100%; background: var(--ip-blue); transition: width 0.3s;"></div>
            </div>
        </div>
    </div>

    <div class="app-container">
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-icons">
                <i class="fa-solid fa-filter sidebar-icon"></i>
                <i class="fa-solid fa-chart-pie sidebar-icon"></i>
                <i class="fa-solid fa-users sidebar-icon"></i>
                <i class="fa-solid fa-cog sidebar-icon"></i>
            </div>
            <div class="sidebar-content">
                <div class="section-title">Filtros Rápidos</div>

                <div class="filter-indicator" id="filterIndicator">
                    <div class="filter-chips-container" id="filterChips"></div>
                </div>

                <div class="filter-group">
                    <label class="filter-label">Analista</label>
                    <div class="select-wrapper">
                        <select id="analistaSelect" class="form-control" onchange="applyFilters()">
                            <option value="">Todos os Analistas</option>
                        </select>
                    </div>
                </div>

                <div class="filter-group">
                    <label class="filter-label">Categoria</label>
                    <div class="select-wrapper">
                        <select id="categoriaSelect" class="form-control" onchange="applyFilters()">
                            <option value="">Todas as Categorias</option>
                        </select>
                    </div>
                </div>

                <div class="filter-group">
                    <label class="filter-label">Período</label>
                    <input type="date" id="dateStart" class="form-control" onchange="applyFilters()" style="margin-bottom: 8px;">
                    <input type="date" id="dateEnd" class="form-control" onchange="applyFilters()">
                </div>

                <div class="filter-group">
                    <label class="filter-label">Busca</label>
                    <input type="text" id="searchInput" class="form-control" placeholder="Pesquisar..." onkeyup="applyFilters()">
                </div>

                <div style="margin-top: 20px;">
                    <button class="btn w-full" onclick="clearFilters()">
                        <i class="fa-solid fa-rotate-left"></i> Limpar Filtros
                    </button>
                </div>

                <div style="margin-top: 20px;">
                    <button class="btn w-full" onclick="document.getElementById('fileInput').click()">
                        <i class="fa-solid fa-upload"></i> Carregar CSV/Excel
                    </button>
                </div>
            </div>
        </aside>

        <main class="main-content">
            <div class="main-filter-area" id="mainFilterArea">
                <div class="main-filter-chips" id="mainFilterChips"></div>
            </div>

            <div class="kpi-grid">
                <div class="kpi-card" id="kpiTotalCard" onclick="filterByKPI('total')">
                    <div class="kpi-content">
                        <div class="kpi-value" id="kTotal">0</div>
                        <div class="kpi-label">
                            <i class="fa-solid fa-list-check"></i> Total de Demandas
                        </div>
                    </div>
                    <div class="kpi-icon">
                        <i class="fa-solid fa-list"></i>
                    </div>
                </div>

                <div class="kpi-card" id="kTMRCard" onclick="filterByKPI('tmr')">
                    <div class="kpi-content">
                        <div class="kpi-value" id="kTMR">0 min</div>
                        <div class="kpi-label">
                            <i class="fa-solid fa-clock"></i> TMR Geral
                        </div>
                    </div>
                    <div class="kpi-icon">
                        <i class="fa-solid fa-stopwatch"></i>
                    </div>
                </div>

                <div class="kpi-card" id="kTopCatCard" onclick="filterByKPI('topcat')">
                    <div class="kpi-content">
                        <div class="kpi-value" id="kTopCat" style="font-size: 20px; line-height: 1.2;">-</div>
                        <div class="kpi-label">
                            <i class="fa-solid fa-star"></i> Top Categoria
                        </div>
                    </div>
                    <div class="kpi-icon">
                        <i class="fa-solid fa-chart-pie"></i>
                    </div>
                </div>

                <div class="kpi-card" id="kAnalistasCard" onclick="filterByKPI('analistas')">
                    <div class="kpi-content">
                        <div class="kpi-value" id="kAnalistas">0</div>
                        <div class="kpi-label">
                            <i class="fa-solid fa-users"></i> Analistas Ativos
                        </div>
                    </div>
                    <div class="kpi-icon">
                        <i class="fa-solid fa-users"></i>
                    </div>
                </div>
            </div>

            <div class="charts-grid">
                <div class="chart-card">
                    <div class="chart-header">
                        <div>
                            <div class="chart-title">
                                <i class="fa-solid fa-chart-pie"></i> Volumetria por Categoria
                            </div>
                            <div class="chart-subtitle">Clique em uma fatia para filtrar</div>
                        </div>
                        <span class="chart-badge">Interativo</span>
                    </div>
                    <div class="chart-container">
                        <canvas id="chartVol"></canvas>
                    </div>
                </div>

                <div class="chart-card">
                    <div class="chart-header">
                        <div>
                            <div class="chart-title">
                                <i class="fa-solid fa-hourglass-half"></i> TMR por Categoria
                            </div>
                            <div class="chart-subtitle">Tempo Médio de Resolução (minutos/horas)</div>
                        </div>
                        <span class="chart-badge">Performance</span>
                    </div>
                    <div class="chart-container">
                        <canvas id="chartTMRCat"></canvas>
                    </div>
                </div>

                <div class="chart-card">
                    <div class="chart-header">
                        <div>
                            <div class="chart-title">
                                <i class="fa-solid fa-user-tie"></i> Volume por Analista
                            </div>
                            <div class="chart-subtitle">Clique em uma barra para filtrar</div>
                        </div>
                        <span class="chart-badge">Interativo</span>
                    </div>
                    <div class="chart-container">
                        <canvas id="chartAnalistaVol"></canvas>
                    </div>
                </div>

                <div class="chart-card">
                    <div class="chart-header">
                        <div>
                            <div class="chart-title">
                                <i class="fa-solid fa-gauge-high"></i> TMR por Analista
                            </div>
                            <div class="chart-subtitle">Tempo Médio de Resolução (minutos/horas)</div>
                        </div>
                        <span class="chart-badge">Performance</span>
                    </div>
                    <div class="chart-container">
                        <canvas id="chartAnalistaTMR"></canvas>
                    </div>
                </div>

                <div class="chart-card full-width">
                    <div class="chart-header">
                        <div>
                            <div class="chart-title">
                                <i class="fa-solid fa-chart-line"></i> Evolução Diária de Demandas
                            </div>
                            <div class="chart-subtitle">Distribuição temporal das atividades</div>
                        </div>
                        <span class="chart-badge">Timeline</span>
                    </div>
                    <div class="chart-container" style="height: 250px;">
                        <canvas id="chartTimeline"></canvas>
                    </div>
                </div>
            </div>

            <div class="table-card">
                <div class="table-header">
                    <div class="table-info">
                        <div class="chart-title">
                            <i class="fa-solid fa-table"></i> Detalhamento das Demandas
                        </div>
                        <span class="table-badge" id="tableCount">0 registros</span>
                    </div>
                    <button class="btn btn-secondary" onclick="exportTableToCSV()">
                        <i class="fa-solid fa-download"></i> Exportar CSV
                    </button>
                </div>
                <div class="table-wrapper">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Data Início</th>
                                <th>Data Fim</th>
                                <th>Analista</th>
                                <th>Categoria</th>
                                <th>Descrição</th>
                                <th>Duração</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody">
                            <tr>
                                <td colspan="6" style="text-align: center; padding: 40px; color: var(--text-muted);">
                                    <i class="fa-solid fa-spinner fa-spin" style="margin-right: 10px;"></i>
                                    Carregando dados do repositório...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <input type="file" id="fileInput" accept=".csv, .xlsx" style="display: none;" onchange="handleFileUpload(this)">

    <script>
        Chart.register(ChartDataLabels);
        Chart.defaults.font.family = "Inter, sans-serif";
        Chart.defaults.color = "#64748B";
        Chart.defaults.responsive = true;
        Chart.defaults.maintainAspectRatio = false;

        const COLORS = {
            blue: "#0045B5",
            yellow: "#FFD100",
            orange: "#FF6900",
            indigo: "#0068FF",
            aqua: "#00D9B8",
            green: "#00C48C",
            purple: "#7C3AED",
            palette: [
                "#0045B5",
                "#FFD100",
                "#FF6900",
                "#0068FF",
                "#00D9B8",
                "#00C48C",
                "#7C3AED",
                "#EC4899",
                "#F59E0B",
                "#10B981"
            ]
        };

        let RAWDATA = [];
        let FILTEREDDATA = [];
        let CHARTS = {};
        let CHARTFILTERS = { analista: null, categoria: null, data: null };
        let KPI_ACTIVE_FILTER = null;
        let sidebarExpanded = false;

        function showLoading(show, text = "Processando...") {
            const loading = document.getElementById("loading");
            const loadingText = document.getElementById("loadingText");
            if (show) {
                loading.style.display = "flex";
                loadingText.textContent = text;
                let progress = 0;
                const interval = setInterval(() => {
                    if (!loading || loading.style.display === "none") {
                        clearInterval(interval);
                        return;
                    }
                    progress = Math.min(90, progress + Math.random() * 10 + 5);
                    document.getElementById("loadingProgress").style.width = progress + "%";
                }, 200);
            } else {
                loading.style.display = "none";
                document.getElementById("loadingProgress").style.width = "0";
            }
        }

        function showToast(message, type = "info") {
            document.querySelectorAll(".toast").forEach(t => t.remove());
            const toast = document.createElement("div");
            toast.className = `toast ${type}`;
            toast.style.cssText = `
                position: fixed;
                top: 90px;
                right: 20px;
                background: ${type === "success" ? "#10B981" : type === "error" ? "#EF4444" : type === "warning" ? "#F59E0B" : "#3B82F6"};
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
                z-index: 2000;
                display: flex;
                align-items: center;
                gap: 10px;
                font-weight: 600;
                transform: translateX(400px);
                transition: transform 0.3s ease;
                font-family: Inter, sans-serif;
            `;
            toast.innerHTML = `
                <i class="fa-solid ${type === "success" ? "fa-check-circle" : type === "error" ? "fa-exclamation-circle" : type === "warning" ? "fa-triangle-exclamation" : "fa-info-circle"}"></i>
                <span>${message}</span>
            `;
            document.body.appendChild(toast);
            setTimeout(() => { toast.style.transform = "translateX(0)"; }, 10);
            setTimeout(() => {
                toast.style.transform = "translateX(400px)";
                setTimeout(() => toast.remove(), 300);
            }, 4000);
        }

        function toggleDarkMode() {
            document.body.classList.toggle("dark-mode");
            const isDark = document.body.classList.contains("dark-mode");
            localStorage.setItem("dashboard-dark-mode", isDark ? "true" : "false");
            showToast(`Modo ${isDark ? "escuro" : "claro"} ativado`, "info");
        }

        function toggleSidebar() {
            const sidebar = document.getElementById("sidebar");
            sidebarExpanded = !sidebarExpanded;
            if (sidebarExpanded) {
                sidebar.style.width = "var(--sidebar-width)";
                sidebar.style.boxShadow = "10px 0 40px rgba(0, 0, 0, 0.1)";
                sidebar.querySelector(".sidebar-icons").style.opacity = "0";
                sidebar.querySelector(".sidebar-content").style.opacity = "1";
                sidebar.querySelector(".sidebar-content").style.transform = "translateX(0)";
            } else {
                sidebar.style.width = "var(--sidebar-collapsed)";
                sidebar.style.boxShadow = "var(--shadow-md)";
                sidebar.querySelector(".sidebar-icons").style.opacity = "1";
                sidebar.querySelector(".sidebar-content").style.opacity = "0";
                sidebar.querySelector(".sidebar-content").style.transform = "translateX(-15px)";
            }
        }

        function handleFileUpload(input) {
            const file = input.files[0];
            if (!file) return;
            showLoading(true, "Processando arquivo local...");

            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    const ext = file.name.split(".").pop().toLowerCase();
                    let jsonData;
                    if (ext === "csv") {
                        const results = Papa.parse(e.target.result, {
                            header: true,
                            skipEmptyLines: true,
                            encoding: "UTF-8"
                        });
                        jsonData = results.data;
                    } else if (ext === "xlsx" || ext === "xls") {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: "array" });
                        const firstSheet = workbook.SheetNames[0];
                        jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[firstSheet], { defval: "" });
                    } else {
                        showToast("Formato não suportado. Use CSV ou Excel.", "error");
                        return;
                    }

                    if (!jsonData || jsonData.length === 0) {
                        showToast("O arquivo não contém dados válidos.", "error");
                        return;
                    }

                    RAWDATA = processData(jsonData);
                    if (!RAWDATA || RAWDATA.length === 0) {
                        showToast("Nenhum dado válido encontrado. Verifique as colunas de data no arquivo.", "error");
                    } else {
                        initDashboard();
                        showToast("Arquivo local processado com sucesso!", "success");
                    }
                } catch (error) {
                    console.error(error);
                    showToast("Erro ao processar o arquivo: " + error.message, "error");
                } finally {
                    showLoading(false);
                }
            };

            if (file.name.toLowerCase().endsWith(".csv")) {
                reader.readAsText(file, "UTF-8");
            } else {
                reader.readAsArrayBuffer(file);
            }
        }

        function loadDemoData() {
            showLoading(true, "Carregando dados de exemplo...");
            const categorias = [
                "Suporte Técnico",
                "Desenvolvimento",
                "Análise de Dados",
                "Reuniões",
                "Treinamento",
                "Documentação",
                "Infraestrutura"
            ];
            const analistas = [
                "João Silva",
                "Maria Santos",
                "Carlos Oliveira",
                "Ana Costa",
                "Pedro Alves",
                "Fernanda Lima"
            ];
            const descricoes = [
                "Análise de relatório mensal de performance",
                "Correção de bug no sistema de autenticação",
                "Reunião de alinhamento com equipe de desenvolvimento",
                "Atualização da documentação técnica",
                "Configuração de servidor de homologação",
                "Treinamento de novos colaboradores",
                "Monitoramento de performance do sistema",
                "Análise de vulnerabilidades de segurança",
                "Desenvolvimento de nova feature",
                "Migração de banco de dados"
            ];

            const demoData = [];
            const startDate = new Date();
            startDate.setDate(startDate.getDate() - 30);

            for (let i = 0; i < 150; i++) {
                const dataAtividade = new Date(startDate);
                dataAtividade.setDate(dataAtividade.getDate() + Math.floor(Math.random() * 30));
                dataAtividade.setHours(8 + Math.floor(Math.random() * 8));
                dataAtividade.setMinutes(Math.floor(Math.random() * 60));

                const duracao = 15 + Math.floor(Math.random() * 240);
                const dataFim = new Date(dataAtividade);
                dataFim.setMinutes(dataFim.getMinutes() + duracao);

                demoData.push({
                    analista: analistas[Math.floor(Math.random() * analistas.length)],
                    descricao: descricoes[Math.floor(Math.random() * descricoes.length)],
                    categoria: categorias[Math.floor(Math.random() * categorias.length)],
                    start: dataAtividade,
                    end: dataFim,
                    duration: duracao
                });
            }

            RAWDATA = demoData;
            setTimeout(() => {
                initDashboard();
                showLoading(false);
                showToast("Dados de exemplo carregados com sucesso!", "success");
            }, 800);
        }

        function processData(jsonData) {
            const processed = [];
            jsonData.forEach((row, index) => {
                try {
                    const normalized = {};
                    for (let key in row) {
                        if (row.hasOwnProperty(key)) {
                            normalized[key.trim().toLowerCase()] = row[key];
                        }
                    }
                    const keys = Object.keys(normalized);

                    const analistaKey = keys.find(k => k.includes("analista"));
                    const categoriaKey = keys.find(k => k.includes("categoria") || k.includes("tipo"));
                    const descricaoKey = keys.find(k => k.includes("descri") || k.includes("descricao") || k.includes("assunto"));
                    const inicioKey = keys.find(k => k.includes("início") || k.includes("inicio") || k.includes("data"));
                    const fimKey = keys.find(k => k.includes("fim"));

                    const analista = analistaKey ? String(normalized[analistaKey] || "Não Identificado").trim() : "Não Identificado";
                    const categoria = categoriaKey ? String(normalized[categoriaKey] || "Geral").trim() : "Geral";
                    const descricao = descricaoKey ? String(normalized[descricaoKey] || "").trim() : "";

                    const dtStart = inicioKey ? normalized[inicioKey] : null;
                    const dtEnd = fimKey ? normalized[fimKey] : null;

                    const dStart = parseDate(dtStart);
                    const dEnd = parseDate(dtEnd);

                    let duration = 0;
                    if (dStart && dEnd) {
                        const diff = dEnd.getTime() - dStart.getTime();
                        duration = Math.max(0, diff / (1000 * 60));
                    }

                    if (dStart && !isNaN(dStart.getTime())) {
                        processed.push({
                            analista,
                            descricao,
                            categoria,
                            start: dStart,
                            end: dEnd,
                            duration
                        });
                    }
                } catch (err) {
                    console.warn("Erro ao processar linha", index, err);
                }
            });
            return processed;
        }

        function parseDate(dateValue) {
            if (!dateValue) return null;
            try {
                if (typeof dateValue === "number") {
                    const date = new Date(Math.round((dateValue - 25569) * 86400 * 1000));
                    return isNaN(date.getTime()) ? null : date;
                }
                if (typeof dateValue === "string") {
                    const trimmed = dateValue.trim();
                    if (!trimmed) return null;
                    const m = moment(trimmed, [
                        "DD/MM/YYYY HH:mm:ss",
                        "DD/MM/YYYY HH:mm",
                        "DD/MM/YYYY",
                        "YYYY-MM-DD HH:mm:ss",
                        "YYYY-MM-DD HH:mm",
                        "YYYY-MM-DD",
                        moment.ISO_8601
                    ], true);
                    if (m.isValid()) return m.toDate();
                    const d = new Date(trimmed);
                    if (!isNaN(d.getTime())) return d;
                    return null;
                }
                if (dateValue instanceof Date) {
                    return isNaN(dateValue.getTime()) ? null : dateValue;
                }
            } catch (err) {
                console.warn("Erro ao parsear data", dateValue, err);
            }
            return null;
        }

        function initDashboard() {
            populateFilters();
            applyFilters();
        }

        function populateFilters() {
            const analistas = [...new Set(RAWDATA.map(d => d.analista))].sort();
            const categorias = [...new Set(RAWDATA.map(d => d.categoria))].sort();

            const populateSelect = (id, values) => {
                const select = document.getElementById(id);
                if (!select) return;
                const first = select.options[0];
                select.innerHTML = "";
                if (first) select.appendChild(first);
                values.forEach(value => {
                    const option = document.createElement("option");
                    option.value = value;
                    option.textContent = value;
                    select.appendChild(option);
                });
            };

            populateSelect("analistaSelect", analistas);
            populateSelect("categoriaSelect", categorias);
        }

        function filterByKPI(type) {
            // Remove classe ativa de todos os cards KPI
            document.querySelectorAll('.kpi-card').forEach(card => {
                card.classList.remove('active-filter');
            });

            // Ativa o card clicado
            const card = document.getElementById(`${type}Card` || `k${type.charAt(0).toUpperCase() + type.slice(1)}Card`);
            if (card) card.classList.add('active-filter');

            KPI_ACTIVE_FILTER = type;

            switch(type) {
                case 'total':
                    // Limpa todos os filtros
                    clearFilters();
                    showToast("Todos os filtros foram limpos", "info");
                    break;
                case 'tmr':
                    // Filtra pelas demandas com maior duração (top 20%)
                    const sortedByDuration = [...FILTEREDDATA].sort((a, b) => b.duration - a.duration);
                    const cutoffIndex = Math.floor(sortedByDuration.length * 0.2);
                    const topDurationDemands = sortedByDuration.slice(0, cutoffIndex);
                    
                    // Cria filtro para mostrar apenas essas demandas
                    document.getElementById("analistaSelect").value = "";
                    document.getElementById("categoriaSelect").value = "";
                    document.getElementById("searchInput").value = "";
                    document.getElementById("dateStart").value = "";
                    document.getElementById("dateEnd").value = "";
                    
                    // Atualiza dados filtrados
                    FILTEREDDATA = topDurationDemands;
                    updateKPIs();
                    renderCharts();
                    renderTable();
                    updateHeaderStats();
                    showToast("Filtrado: Demandas com maior TMR (top 20%)", "success");
                    break;
                case 'topcat':
                    // Filtra pela categoria mais frequente
                    const counts = {};
                    FILTEREDDATA.forEach(d => {
                        counts[d.categoria] = (counts[d.categoria] || 0) + 1;
                    });
                    const topCat = Object.entries(counts)
                        .sort((a, b) => b[1] - a[1])[0]?.[0];
                    
                    if (topCat) {
                        document.getElementById("categoriaSelect").value = topCat;
                        CHARTFILTERS.categoria = topCat;
                        applyFilters();
                        showToast(`Filtrado pela categoria: ${topCat}`, "success");
                    }
                    break;
                case 'analistas':
                    // Filtra pelo analista com mais demandas
                    const analistaCounts = {};
                    FILTEREDDATA.forEach(d => {
                        analistaCounts[d.analista] = (analistaCounts[d.analista] || 0) + 1;
                    });
                    const topAnalista = Object.entries(analistaCounts)
                        .sort((a, b) => b[1] - a[1])[0]?.[0];
                    
                    if (topAnalista) {
                        document.getElementById("analistaSelect").value = topAnalista;
                        CHARTFILTERS.analista = topAnalista;
                        applyFilters();
                        showToast(`Filtrado pelo analista: ${topAnalista}`, "success");
                    }
                    break;
            }
        }

        function applyFilters() {
            const fAnalista = document.getElementById("analistaSelect").value;
            const fCat = document.getElementById("categoriaSelect").value;
            const fSearch = document.getElementById("searchInput").value.toLowerCase();
            const fStart = document.getElementById("dateStart").value ? new Date(document.getElementById("dateStart").value) : null;
            const fEnd = document.getElementById("dateEnd").value ? new Date(document.getElementById("dateEnd").value) : null;
            if (fEnd) fEnd.setHours(23, 59, 59, 999);

            FILTEREDDATA = RAWDATA.filter(d => {
                const matchAnalista = !fAnalista || d.analista === fAnalista;
                const matchCat = !fCat || d.categoria === fCat;
                const matchSearch =
                    !fSearch ||
                    (d.descricao && d.descricao.toLowerCase().includes(fSearch)) ||
                    (d.analista && d.analista.toLowerCase().includes(fSearch)) ||
                    (d.categoria && d.categoria.toLowerCase().includes(fSearch));

                let matchDate = true;
                if (fStart && d.start < fStart) matchDate = false;
                if (fEnd && d.start > fEnd) matchDate = false;

                let matchChart = true;
                if (CHARTFILTERS.analista && d.analista !== CHARTFILTERS.analista) matchChart = false;
                if (CHARTFILTERS.categoria && d.categoria !== CHARTFILTERS.categoria) matchChart = false;
                if (CHARTFILTERS.data) {
                    const dayKey = moment(d.start).format("YYYY-MM-DD");
                    if (dayKey !== CHARTFILTERS.data) matchChart = false;
                }

                return matchAnalista && matchCat && matchSearch && matchDate && matchChart;
            });

            updateKPIs();
            renderCharts();
            renderTable();
            updateFilterIndicator();
            updateHeaderStats();
        }

        function clearFilters() {
            document.getElementById("analistaSelect").value = "";
            document.getElementById("categoriaSelect").value = "";
            document.getElementById("searchInput").value = "";
            document.getElementById("dateStart").value = "";
            document.getElementById("dateEnd").value = "";
            CHARTFILTERS.analista = null;
            CHARTFILTERS.categoria = null;
            CHARTFILTERS.data = null;
            KPI_ACTIVE_FILTER = null;
            
            // Remove classe ativa dos cards KPI
            document.querySelectorAll('.kpi-card').forEach(card => {
                card.classList.remove('active-filter');
            });
            
            applyFilters();
            showToast("Filtros limpos", "info");
        }

        function setChartFilter(type, value) {
            if (!["analista", "categoria", "data"].includes(type)) return;
            CHARTFILTERS[type] = CHARTFILTERS[type] === value ? null : value;

            if (type === "analista") {
                document.getElementById("analistaSelect").value = CHARTFILTERS.analista || "";
            }
            if (type === "categoria") {
                document.getElementById("categoriaSelect").value = CHARTFILTERS.categoria || "";
            }

            applyFilters();

            if (CHARTFILTERS[type]) {
                const label = type === "data"
                    ? "Dia " + moment(value, "YYYY-MM-DD").format("DD/MM/YYYY")
                    : type === "analista"
                        ? "Analista " + value
                        : "Categoria " + value;
                showToast(`Filtro aplicado: ${label}`, "success");
            } else {
                showToast(`Filtro de ${type} removido`, "info");
            }
        }

        function clearChartFilter() {
            CHARTFILTERS.analista = null;
            CHARTFILTERS.categoria = null;
            CHARTFILTERS.data = null;
            document.getElementById("analistaSelect").value = "";
            document.getElementById("categoriaSelect").value = "";
            applyFilters();
            showToast("Filtros de gráfico removidos", "info");
        }

        function updateFilterIndicator() {
            const indicator = document.getElementById("filterIndicator");
            const chipsContainer = document.getElementById("filterChips");
            const mainFilterArea = document.getElementById("mainFilterArea");
            const mainFilterChips = document.getElementById("mainFilterChips");

            const filters = [];
            if (CHARTFILTERS.analista) filters.push({ type: "analista", value: CHARTFILTERS.analista, icon: "fa-user", label: "Analista" });
            if (CHARTFILTERS.categoria) filters.push({ type: "categoria", value: CHARTFILTERS.categoria, icon: "fa-tag", label: "Categoria" });
            if (CHARTFILTERS.data) filters.push({ type: "data", value: moment(CHARTFILTERS.data, "YYYY-MM-DD").format("DD/MM/YYYY"), icon: "fa-calendar-day", label: "Dia" });

            if (filters.length) {
                indicator.classList.add("has-filters");
                mainFilterArea.classList.add("has-filters");
                let chipsHTML = "";
                filters.forEach(f => {
                    const displayValue = f.value.length > 18 ? f.value.substring(0, 18) + "..." : f.value;
                    chipsHTML += `
                        <div class="filter-chip" data-type="${f.type}">
                            <i class="fa-solid ${f.icon} filter-chip-icon"></i>
                            <span class="filter-chip-label">${f.label}</span>
                            <span class="filter-chip-value" title="${f.value}">${displayValue}</span>
                            <button class="filter-chip-close" onclick="removeChartFilter('${f.type}')" title="Remover filtro">
                                <i class="fa-solid fa-xmark"></i>
                            </button>
                        </div>
                    `;
                });
                chipsHTML += `
                    <button class="clear-all-filters" onclick="clearChartFilter()">
                        <i class="fa-solid fa-trash-can"></i> Limpar todos
                    </button>
                `;
                chipsContainer.innerHTML = chipsHTML;
                mainFilterChips.innerHTML = `
                    <span class="main-filter-label">
                        <i class="fa-solid fa-filter"></i> Filtros ativos
                    </span>
                    ${chipsHTML}
                `;
            } else {
                indicator.classList.remove("has-filters");
                mainFilterArea.classList.remove("has-filters");
                chipsContainer.innerHTML = "";
                mainFilterChips.innerHTML = "";
            }
        }

        function removeChartFilter(type) {
            if (type === "analista") {
                CHARTFILTERS.analista = null;
                document.getElementById("analistaSelect").value = "";
            } else if (type === "categoria") {
                CHARTFILTERS.categoria = null;
                document.getElementById("categoriaSelect").value = "";
            } else if (type === "data") {
                CHARTFILTERS.data = null;
            }
            applyFilters();
            showToast(`Filtro de ${type} removido`, "info");
        }

        function updateKPIs() {
            const total = FILTEREDDATA.length;
            const validDurations = FILTEREDDATA.filter(d => d.duration > 0);
            const totalDuration = validDurations.reduce((acc, curr) => acc + curr.duration, 0);
            const avgDuration = validDurations.length === 0 ? 0 : totalDuration / validDurations.length;

            let tmrDisplay = avgDuration >= 60 ? (avgDuration / 60).toFixed(1) + " h" : Math.round(avgDuration) + " min";

            const counts = {};
            FILTEREDDATA.forEach(d => {
                counts[d.categoria] = (counts[d.categoria] || 0) + 1;
            });

            const topCat = Object.entries(counts)
                .sort((a, b) => b[1] - a[1])[0]?.[0] || "-";

            const uniqueAnalistas = new Set(FILTEREDDATA.map(d => d.analista)).size;

            document.getElementById("kTotal").innerText = total.toLocaleString("pt-BR");
            document.getElementById("kTMR").innerText = tmrDisplay;
            document.getElementById("kTopCat").innerText = topCat ? (topCat.length > 15 ? topCat.substring(0, 15) + "..." : topCat) : "-";
            document.getElementById("kAnalistas").innerText = uniqueAnalistas;
        }

        function updateHeaderStats() {
            const total = FILTEREDDATA.length;
            const validDurations = FILTEREDDATA.filter(d => d.duration > 0);
            const totalDuration = validDurations.reduce((acc, curr) => acc + curr.duration, 0);
            const avgDuration = validDurations.length === 0 ? 0 : totalDuration / validDurations.length;

            let tmrDisplay = avgDuration >= 60 ? (avgDuration / 60).toFixed(1) + " h" : Math.round(avgDuration) + " min";

            const uniqueAnalistas = new Set(FILTEREDDATA.map(d => d.analista)).size;

            document.getElementById("headerTotal").innerText = total;
            document.getElementById("headerTMR").innerText = tmrDisplay;
            document.getElementById("headerAnalistas").innerText = uniqueAnalistas;
        }

        function renderCharts() {
            Object.values(CHARTS).forEach(chart => {
                if (chart && chart.destroy) chart.destroy();
            });
            CHARTS = {};

            const analistaGroups = {};
            const catGroups = {};
            const timeline = {};

            FILTEREDDATA.forEach(d => {
                if (!catGroups[d.categoria]) catGroups[d.categoria] = { count: 0, time: 0 };
                catGroups[d.categoria].count++;
                catGroups[d.categoria].time += d.duration;

                if (!analistaGroups[d.analista]) analistaGroups[d.analista] = { count: 0, time: 0, validcount: 0 };
                analistaGroups[d.analista].count++;
                if (d.duration > 0) {
                    analistaGroups[d.analista].time += d.duration;
                    analistaGroups[d.analista].validcount++;
                }

                const dateKey = moment(d.start).format("YYYY-MM-DD");
                timeline[dateKey] = (timeline[dateKey] || 0) + 1;
            });

            const sortedVolCat = Object.entries(catGroups)
                .map(([k, v]) => ({ label: k, val: v.count }))
                .sort((a, b) => b.val - a.val)
                .slice(0, 8);
            createChart("chartVol", "doughnut",
                sortedVolCat.map(x => x.label),
                sortedVolCat.map(x => x.val),
                "",
                false,
                "categoria"
            );

            const sortedTMRCat = Object.entries(catGroups)
                .map(([k, v]) => ({ label: k, val: v.time / v.count }))
                .filter(x => x.val > 0)
                .sort((a, b) => b.val - a.val)
                .slice(0, 8);
            createChart("chartTMRCat", "bar",
                sortedTMRCat.map(x => x.label),
                sortedTMRCat.map(x => x.val),
                "min",
                false,
                "categoria"
            );

            const sortedAnalistasVol = Object.entries(analistaGroups)
                .map(([k, v]) => ({ label: k, val: v.count }))
                .sort((a, b) => b.val - a.val)
                .slice(0, 10);
            createChart("chartAnalistaVol", "bar",
                sortedAnalistasVol.map(x => x.label),
                sortedAnalistasVol.map(x => x.val),
                "",
                false,
                "analista"
            );

            const sortedAnalistasTMR = Object.entries(analistaGroups)
                .map(([k, v]) => ({ label: k, val: v.validcount === 0 ? 0 : v.time / v.validcount }))
                .filter(x => x.val > 0)
                .sort((a, b) => b.val - a.val)
                .slice(0, 10);
            createChart("chartAnalistaTMR", "bar",
                sortedAnalistasTMR.map(x => x.label),
                sortedAnalistasTMR.map(x => x.val),
                "min",
                false,
                "analista"
            );

            const sortedDates = Object.keys(timeline).sort();
            createChart("chartTimeline", "line",
                sortedDates,
                sortedDates.map(d => timeline[d]),
                "",
                false,
                "data"
            );
        }

        function createChart(canvasId, type, labels, data, unit, indexAxisY, filterType = null) {
            const ctx = document.getElementById(canvasId);
            if (!ctx) return;

            if (CHARTS[canvasId]) CHARTS[canvasId].destroy();

            const bgColors = labels.map((_, i) => COLORS.palette[i % COLORS.palette.length]);

            const isSelected = (label, idx) => {
                if (!filterType) return false;
                const active = CHARTFILTERS[filterType];
                return active && active === labels[idx];
            };

            CHARTS[canvasId] = new Chart(ctx, {
                type,
                data: {
                    labels,
                    datasets: [{
                        data,
                        backgroundColor: type === "line"
                            ? "rgba(0, 69, 181, 0.1)"
                            : bgColors.map((c, i) => isSelected(labels[i], i) ? c + "CC" : c),
                        borderColor: type === "line"
                            ? COLORS.blue
                            : bgColors.map((c, i) => isSelected(labels[i], i) ? COLORS.blue : c),
                        borderWidth: type === "line" ? 3 : 2,
                        borderRadius: 6,
                        fill: type === "line",
                        tension: 0.4,
                        pointBackgroundColor: type === "line" ? COLORS.blue : undefined,
                        pointBorderColor: type === "line" ? "#fff" : undefined,
                        pointBorderWidth: type === "line" ? 2 : undefined,
                        pointRadius: type === "line" ? 5 : undefined,
                        pointHoverRadius: type === "line" ? 8 : undefined
                    }]
                },
                options: {
                    indexAxis: indexAxisY ? "y" : "x",
                    responsive: true,
                    maintainAspectRatio: false,
                    onClick: (event, elements) => {
                        if (!filterType || !elements || !elements.length) return;
                        const label = labels[elements[0].index];
                        if (filterType === "data") {
                            const dayKey = label;
                            setChartFilter(filterType, dayKey);
                        } else {
                            setChartFilter(filterType, label);
                        }
                    },
                    onHover: (event, elements) => {
                        event.native.target.style.cursor = elements && elements.length && filterType ? "pointer" : "default";
                    },
                    plugins: {
                        legend: {
                            display: type === "doughnut",
                            position: "right",
                            labels: {
                                padding: 15,
                                usePointStyle: true,
                                font: { size: 12, family: "Inter, sans-serif" }
                            }
                        },
                        tooltip: {
                            backgroundColor: "rgba(0,0,0,0.85)",
                            padding: 12,
                            cornerRadius: 8,
                            titleFont: { family: "Inter, sans-serif", size: 13 },
                            bodyFont: { family: "Inter, sans-serif", size: 13 },
                            callbacks: {
                                label: function (context) {
                                    let lbl = context.label;
                                    if (filterType === "data") {
                                        lbl = moment(lbl, "YYYY-MM-DD").format("DD/MM/YYYY");
                                    }
                                    const v = context.raw;
                                    if (unit === "min") {
                                        const txt = v >= 60 ? (v / 60).toFixed(1) + " h" : Math.round(v) + " min";
                                        return lbl + ": " + txt;
                                    }
                                    return lbl + ": " + Math.round(v) + (unit ? " " + unit : "");
                                }
                            }
                        },
                        datalabels: {
                            color: type === "doughnut" ? "#fff" : "#555",
                            anchor: type === "doughnut" ? "center" : (indexAxisY ? "end" : "start"),
                            align: type === "doughnut" ? "center" : (indexAxisY ? "right" : "top"),
                            offset: type === "doughnut" ? 0 : 4,
                            formatter: (val) => {
                                if (!val) return "";
                                if (unit === "min") {
                                    return val >= 60 ? (val / 60).toFixed(1) + " h" : Math.round(val) + " min";
                                }
                                return Math.round(val) + (unit ? " " + unit : "");
                            },
                            font: {
                                weight: "bold",
                                size: type === "doughnut" ? 13 : 11,
                                family: "Inter, sans-serif"
                            },
                            display: (ctx) => {
                                const value = ctx.dataset.data[ctx.dataIndex];
                                return value > 0;
                            }
                        }
                    },
                    scales: type === "doughnut" ? {} : {
                        y: {
                            beginAtZero: true,
                            grid: { color: "rgba(0,0,0,0.05)", drawBorder: false },
                            ticks: {
                                font: { family: "Inter, sans-serif" },
                                callback: function (value) {
                                    if (unit === "min") {
                                        return value >= 60 ? (value / 60).toFixed(1) + " h" : value + " min";
                                    }
                                    return value;
                                }
                            }
                        },
                        x: {
                            grid: { display: false, drawBorder: false },
                            ticks: {
                                font: { family: "Inter, sans-serif" },
                                maxRotation: 45,
                                minRotation: 0,
                                callback: function (value) {
                                    const lbl = this.getLabelForValue(value);
                                    if (filterType === "data") {
                                        return moment(lbl, "YYYY-MM-DD").format("DD/MM");
                                    }
                                    return lbl;
                                }
                            }
                        }
                    }
                }
            });
        }

        function renderTable() {
            const tbody = document.getElementById("tableBody");
            tbody.innerHTML = "";
            const displayData = FILTEREDDATA.slice(0, 100);
            document.getElementById("tableCount").innerText = `${displayData.length} de ${FILTEREDDATA.length} registros`;

            if (displayData.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 40px; color: var(--text-muted);">
                            Nenhum registro encontrado com os filtros atuais
                        </td>
                    </tr>
                `;
                return;
            }

            displayData.forEach(row => {
                const tr = document.createElement("tr");
                const startStr = moment(row.start).format("DD/MM/YYYY HH:mm");
                const endStr = row.end ? moment(row.end).format("DD/MM/YYYY HH:mm") : "-";
                const durationFormatted = row.duration >= 60 ? (row.duration / 60).toFixed(1) + " h" : Math.round(row.duration) + " min";
                const descShort = row.descricao.length > 60 ? row.descricao.substring(0, 60) + "..." : row.descricao;

                tr.innerHTML = `
                    <td style="font-weight: 600;">${startStr}</td>
                    <td>${endStr}</td>
                    <td style="color: var(--ip-blue); font-weight: 600;">${row.analista}</td>
                    <td><span class="pill pill-categoria">${row.categoria}</span></td>
                    <td title="${row.descricao.replace(/"/g, "&quot;")}">${descShort}</td>
                    <td><span class="pill pill-duracao">${durationFormatted}</span></td>
                `;
                tbody.appendChild(tr);
            });
        }

        function exportTableToCSV() {
            if (FILTEREDDATA.length === 0) {
                showToast("Sem dados para exportar", "warning");
                return;
            }
            let csv = "Data Início,Data Fim,Analista,Categoria,Duração (min),Descrição\n";
            FILTEREDDATA.forEach(row => {
                const startStr = moment(row.start).format("YYYY-MM-DD HH:mm");
                const endStr = row.end ? moment(row.end).format("YYYY-MM-DD HH:mm") : "";
                const descSafe = (row.descricao || "").replace(/"/g, '""');
                csv += `"${startStr}","${endStr}","${row.analista}","${row.categoria}",${row.duration.toFixed(2)},"${descSafe}"\n`;
            });
            const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.href = url;
            link.download = `consolida_demandas_${moment().format("YYYY-MM-DD_HHmmss")}.csv`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            showToast("CSV exportado com sucesso!", "success");
        }

        // Carrega sempre do link GitHub (internas.xlsx) ao abrir a página
        function loadRemoteExcel() {
            const url = "https://raw.githubusercontent.com/thiccoipp/Ipp/main/internas.xlsx";
            
            showLoading(true, "Carregando base interna (internas.xlsx)...");
            fetch(url)
                .then(response => {
                    if (!response.ok) {
                        throw new Error("Não foi possível baixar o arquivo remoto.");
                    }
                    return response.arrayBuffer();
                })
                .then(arrayBuffer => {
                    const data = new Uint8Array(arrayBuffer);
                    const workbook = XLSX.read(data, { type: "array" });
                    const firstSheet = workbook.SheetNames[0];
                    const jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[firstSheet], { defval: "" });
                    if (!jsonData || jsonData.length === 0) {
                        throw new Error("Arquivo remoto sem dados válidos.");
                    }
                    RAWDATA = processData(jsonData);
                    if (!RAWDATA || RAWDATA.length === 0) {
                        throw new Error("Nenhuma linha válida foi encontrada na base remota.");
                    }
                    initDashboard();
                    showToast("Base interna carregada com sucesso!", "success");
                })
                .catch(err => {
                    console.error(err);
                    showToast("Falha ao carregar a base interna: " + err.message, "error");
                    // Muda a mensagem da tabela para indicar que não foi possível carregar
                    document.getElementById("tableBody").innerHTML = `
                        <tr>
                            <td colspan="6" style="text-align: center; padding: 40px; color: var(--text-muted);">
                                <i class="fa-solid fa-exclamation-triangle" style="margin-right: 10px;"></i>
                                Não foi possível carregar os dados. Use o botão "Carregar CSV/Excel" no menu lateral.
                            </td>
                        </tr>
                    `;
                })
                .finally(() => {
                    showLoading(false);
                });
        }

        window.onload = function () {
            if (localStorage.getItem("dashboard-dark-mode") === "true") {
                document.body.classList.add("dark-mode");
            }

            document.getElementById("searchInput").addEventListener("input", applyFilters);
            document.getElementById("analistaSelect").addEventListener("change", applyFilters);
            document.getElementById("categoriaSelect").addEventListener("change", applyFilters);
            document.getElementById("dateStart").addEventListener("change", applyFilters);
            document.getElementById("dateEnd").addEventListener("change", applyFilters);

            document.addEventListener("keydown", (e) => {
                if (e.ctrlKey && e.key.toLowerCase() === "e") {
                    e.preventDefault();
                    exportTableToCSV();
                }
                if (e.ctrlKey && e.key.toLowerCase() === "f") {
                    e.preventDefault();
                    document.getElementById("searchInput").focus();
                }
            });

            // Carrega automaticamente a base remota SEM TELA INICIAL
            loadRemoteExcel();
        };
    </script>
</body>
</html>