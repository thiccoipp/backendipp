<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Consolida Torre | Mapeamento de Contatos</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700;800;900&family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-moment@1.0.1/dist/chartjs-adapter-moment.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js"></script>
<script>
moment.locale('pt-br', {
    weekdaysShort : ["Dom", "Seg", "Ter", "Qua", "Qui", "Sex", "Sáb"]
});
</script>
<style>
/* ===== CSS REFATORADO - Design Premium 2025 ===== */
/* ===== VARIÁVEIS E RESET ===== */
:root {
    /* Cores da marca - Versão Dark Modern */
    --brand-blue: #3D8DFF;
    --brand-blue-light: #6CABFF;
    --brand-blue-dark: #1A5CE0;
    --brand-yellow: #FFD166;
    --brand-yellow-light: #FFE4A1;
    --brand-orange: #FF7A45;
    --brand-orange-light: #FF9E76;
    --success-green: #00C9A7;
    --success-green-light: #4CE4C9;
    --error-red: #FF4757;
    --warning: #FFA93D;
    --purple: #9D4EDD;
    --purple-light: #BB86FC;
    --purple-dark: #7B2CBF;
    
    /* Gradientes Premium */
    --gradient-primary: linear-gradient(135deg, #3D8DFF 0%, #1A5CE0 100%);
    --gradient-secondary: linear-gradient(135deg, #FF7A45 0%, #FF3E00 100%);
    --gradient-success: linear-gradient(135deg, #00C9A7 0%, #008B74 100%);
    --gradient-warning: linear-gradient(135deg, #FFD166 0%, #FFB347 100%);
    --gradient-purple: linear-gradient(135deg, #9D4EDD 0%, #7B2CBF 100%);
    --gradient-dark: linear-gradient(135deg, #1A1B2E 0%, #12131F 100%);
    --gradient-glass: linear-gradient(135deg, rgba(255, 255, 255, 0.15) 0%, rgba(255, 255, 255, 0.05) 100%);
    
    /* Backgrounds */
    --bg-primary: #0F0F1A;
    --bg-card: #1A1B2E;
    --bg-card-hover: #212238;
    --bg-sidebar: #151626;
    --bg-header: var(--gradient-dark);
    --bg-overlay: rgba(15, 15, 26, 0.95);
    
    /* Textos */
    --text-primary: #FFFFFF;
    --text-secondary: #B8B9C7;
    --text-muted: #8B8D9E;
    --text-light: #A0AEC0;
    
    /* Bordas */
    --border-primary: rgba(255, 255, 255, 0.08);
    --border-light: rgba(255, 255, 255, 0.12);
    --border-accent: rgba(61, 141, 255, 0.25);
    --border-glass: rgba(255, 255, 255, 0.1);
    
    /* Sombras */
    --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.3);
    --shadow-md: 0 4px 20px rgba(0, 0, 0, 0.4);
    --shadow-lg: 0 8px 30px rgba(0, 0, 0, 0.5);
    --shadow-xl: 0 15px 50px rgba(0, 0, 0, 0.6);
    --shadow-glow: 0 0 20px rgba(61, 141, 255, 0.3);
    --shadow-card: 0 8px 25px rgba(0, 0, 0, 0.4);
    
    /* Glassmorphism */
    --glass-bg: rgba(26, 27, 46, 0.7);
    --glass-border: rgba(255, 255, 255, 0.15);
    --glass-shadow: 0 8px 32px rgba(31, 38, 135, 0.2);
    
    /* Layout */
    --sidebar-collapsed: 80px;
    --sidebar-expanded: 320px;
    --header-height: 70px;
    --kpi-sticky-height: 190px;
    --radius-sm: 12px;
    --radius-md: 16px;
    --radius-lg: 20px;
    --radius-xl: 24px;
    --radius-full: 999px;
    
    /* Transições */
    --transition-fast: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    --transition-normal: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    --transition-slow: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
    
    /* Tipografia */
    --font-primary: 'Inter', sans-serif;
    --font-secondary: 'Montserrat', sans-serif;
}

/* Tema claro (opcional) */
.light-theme {
    --bg-primary: #F8FAFF;
    --bg-card: #FFFFFF;
    --bg-card-hover: #F8FAFF;
    --bg-sidebar: #FFFFFF;
    --bg-header: var(--gradient-primary);
    --text-primary: #1A1B2E;
    --text-secondary: #5A5D72;
    --text-muted: #8B8D9E;
    --border-primary: rgba(0, 0, 0, 0.08);
    --border-light: rgba(0, 0, 0, 0.12);
    --glass-bg: rgba(255, 255, 255, 0.7);
    --glass-border: rgba(0, 0, 0, 0.1);
}

/* Reset e estilos base */
* {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
}

html {
    scroll-behavior: smooth;
    scroll-padding-top: 80px;
}

body {
    background: var(--bg-primary);
    color: var(--text-primary);
    font-family: var(--font-primary);
    font-weight: 400;
    line-height: 1.6;
    overflow-x: hidden;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
    min-width: 1000px;
    background-image: 
        radial-gradient(circle at 15% 50%, rgba(61, 141, 255, 0.05) 0%, transparent 55%),
        radial-gradient(circle at 85% 30%, rgba(157, 78, 221, 0.05) 0%, transparent 55%);
}

/* ===== UTILITÁRIOS ===== */
.flex { display: flex; }
.flex-col { flex-direction: column; }
.items-center { align-items: center; }
.justify-between { justify-content: space-between; }
.gap-xs { gap: 8px; }
.gap-sm { gap: 16px; }
.gap-md { gap: 24px; }
.gap-lg { gap: 32px; }
.w-full { width: 100%; }
.h-full { height: 100%; }
.text-center { text-align: center; }
.text-right { text-align: right; }
.font-bold { font-weight: 700; }
.font-semibold { font-weight: 600; }
.text-sm { font-size: 13px; }
.text-xs { font-size: 11px; }
.mb-sm { margin-bottom: 16px; }
.mb-md { margin-bottom: 24px; }
.mb-lg { margin-bottom: 32px; }
.p-sm { padding: 16px; }
.p-md { padding: 24px; }
.rounded-sm { border-radius: var(--radius-sm); }
.rounded-md { border-radius: var(--radius-md); }
.rounded-lg { border-radius: var(--radius-lg); }
.shadow-card { box-shadow: var(--shadow-card); }
.glass {
    background: var(--glass-bg);
    backdrop-filter: blur(20px);
    border: 1px solid var(--glass-border);
    box-shadow: var(--glass-shadow);
}

/* ===== LAYOUT ===== */
.layout {
    display: flex;
    min-height: 100vh;
    position: relative;
    padding-top: var(--header-height);
}

/* ===== HEADER MODERNO 2025 ===== */
.header {
    height: var(--header-height);
    background: var(--bg-header);
    color: #fff;
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 30px;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    z-index: 1000;
    box-shadow: var(--shadow-lg);
    overflow: hidden;
    backdrop-filter: blur(20px);
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.header::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: linear-gradient(90deg, var(--brand-blue), var(--brand-orange), var(--purple));
    background-size: 200% 100%;
    animation: gradientShift 3s ease infinite;
    z-index: 1;
}

@keyframes gradientShift {
    0% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
    100% { background-position: 0% 50%; }
}

.header-left {
    display: flex;
    align-items: center;
    gap: 15px;
}

.header-logo {
    background: var(--gradient-primary);
    color: white;
    width: 42px;
    height: 42px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 900;
    font-size: 20px;
    position: relative;
    overflow: hidden;
    z-index: 2;
    box-shadow: var(--shadow-glow);
    transition: var(--transition-normal);
}

.header-logo:hover {
    transform: rotate(15deg) scale(1.1);
}

.header-logo::after {
    content: '';
    position: absolute;
    inset: 0;
    background: linear-gradient(135deg, rgba(255,255,255,0.2) 0%, rgba(255,255,255,0) 100%);
}

.header-titles {
    display: flex;
    flex-direction: column;
}

.header-title {
    font-weight: 800;
    font-size: 18px;
    letter-spacing: 0.5px;
    background: linear-gradient(90deg, #fff, var(--brand-blue-light));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    font-family: var(--font-secondary);
}

.header-subtitle {
    font-size: 11px;
    opacity: 0.7;
    font-weight: 500;
    margin-top: 2px;
    letter-spacing: 0.5px;
    text-transform: uppercase;
}

.header-right {
    display: flex;
    align-items: center;
    gap: 20px;
}

.header-stats {
    display: flex;
    gap: 20px;
}

.stat-item {
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    padding: 8px 12px;
    background: rgba(255, 255, 255, 0.05);
    border-radius: var(--radius-sm);
    border: 1px solid rgba(255, 255, 255, 0.1);
    min-width: 80px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
}

.stat-value {
    font-weight: 800;
    font-size: 16px;
    line-height: 1;
    font-family: var(--font-secondary);
}

.stat-label {
    font-size: 10px;
    opacity: 0.7;
    font-weight: 500;
    margin-top: 4px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.header-actions {
    display: flex;
    gap: 10px;
}
.header-logo-img {
    height: 42px;
    width: auto;
    border-radius: 10px;
    object-fit: contain;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    border: none;
    background-color: transparent;
    padding: 0;
    transition: var(--transition-normal);
}

.header-logo-img:hover {
    transform: scale(1.05);
    box-shadow: 0 6px 20px rgba(0, 69, 181, 0.4);
}
/* ===== SIDEBAR MODERNA ===== */
.sidebar {
    width: var(--sidebar-collapsed);
    background: var(--bg-sidebar);
    border-right: 1px solid var(--border-primary);
    position: fixed;
    left: 0;
    top: var(--header-height);
    bottom: 0;
    z-index: 900;
    overflow-y: auto;
    overflow-x: hidden;
    transition: var(--transition-normal);
    padding-top: 25px;
    backdrop-filter: blur(20px);
}

.sidebar:hover {
    width: var(--sidebar-expanded);
    box-shadow: 10px 0 40px rgba(0, 0, 0, 0.3);
}

.sidebar::before {
    content: '';
    position: absolute;
    top: 0;
    right: 0;
    width: 1px;
    height: 100%;
    background: linear-gradient(to bottom, transparent, var(--brand-blue), transparent);
    opacity: 0.3;
}

.sb-icons {
    position: absolute;
    left: 0;
    top: 25px;
    width: var(--sidebar-collapsed);
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 30px;
    pointer-events: none;
    transition: opacity var(--transition-fast);
}

.sb-icon {
    font-size: 24px;
    color: var(--brand-blue);
    opacity: 0.6;
    transition: var(--transition-fast);
    padding: 12px;
    background: rgba(61, 141, 255, 0.1);
    border-radius: var(--radius-sm);
    width: 48px;
    height: 48px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.sidebar:hover .sb-icons {
    opacity: 0;
}

.sb-content {
    width: var(--sidebar-expanded);
    padding: 0 24px;
    opacity: 0;
    transform: translateX(-15px);
    transition: opacity 0.3s 0.1s, transform 0.3s 0.1s;
}

.sidebar:hover .sb-content {
    opacity: 1;
    transform: translateX(0);
}

.section-title {
    font-size: 12px;
    text-transform: uppercase;
    letter-spacing: 1.5px;
    color: var(--brand-blue);
    font-weight: 700;
    margin-bottom: 18px;
    position: relative;
    padding-bottom: 12px;
    font-family: var(--font-secondary);
}

.section-title::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 0;
    width: 30px;
    height: 2px;
    background: linear-gradient(90deg, var(--brand-blue), var(--purple));
    border-radius: 2px;
}

/* ===== MAIN CONTENT ===== */
.main {
    flex: 1;
    padding: 35px;
    margin-left: var(--sidebar-collapsed);
    overflow-y: auto;
    position: relative;
    transition: var(--transition-normal);
}

.main::-webkit-scrollbar {
    width: 8px;
}

.main::-webkit-scrollbar-track {
    background: rgba(255, 255, 255, 0.05);
    border-radius: 4px;
}

.main::-webkit-scrollbar-thumb {
    background: var(--brand-blue);
    border-radius: 4px;
}

.main::-webkit-scrollbar-thumb:hover {
    background: var(--brand-blue-light);
}

/* ===== CONTEXT BAR MODERNA ===== */
.context-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 15px;
    padding: 16px 24px;
    background: var(--glass-bg);
    backdrop-filter: blur(20px);
    border-radius: var(--radius-md);
    box-shadow: var(--shadow-card);
    border: 1px solid var(--glass-border);
    margin-bottom: 20px;
    flex-wrap: wrap;
}

.context-text {
    font-size: 13px;
    color: var(--text-secondary);
    font-weight: 500;
    flex: 1;
    min-width: 200px;
}

.context-text span {
    font-weight: 700;
    color: var(--text-primary);
    background: rgba(61, 141, 255, 0.15);
    padding: 6px 12px;
    border-radius: var(--radius-sm);
    margin: 0 4px;
    border: 1px solid rgba(61, 141, 255, 0.3);
}

.context-actions {
    display: flex;
    gap: 10px;
    align-items: center;
    flex-wrap: wrap;
}

.context-hint {
    font-size: 11px;
    color: var(--text-muted);
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 8px 12px;
    background: rgba(61, 141, 255, 0.1);
    border-radius: var(--radius-sm);
    font-weight: 500;
    border: 1px solid rgba(61, 141, 255, 0.2);
}

.context-hint i {
    color: var(--brand-blue);
}

/* ===== KPI GRID STICKY ===== */
.kpi-sticky-container {
    position: sticky;
    top: 20px;
    z-index: 800;
    margin-bottom: 25px;
}

.kpi-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 16px;
}

.kpi-card {
    border-radius: var(--radius-lg);
    padding: 20px;
    background: var(--bg-card);
    box-shadow: 0 12px 40px rgba(0, 0, 0, 0.4);
    border: 1px solid var(--border-primary);
    display: flex;
    justify-content: space-between;
    align-items: center;
    cursor: pointer;
    transition: var(--transition-normal);
    position: relative;
    overflow: hidden;
    min-height: 120px;
    height: 100%;
}

.kpi-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: linear-gradient(90deg, var(--brand-blue), var(--brand-blue-light));
    opacity: 0;
    transition: opacity 0.3s;
}

.kpi-card:hover {
    transform: translateY(-8px);
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.6);
    border-color: var(--brand-blue);
    background: var(--bg-card-hover);
}

.kpi-card:hover::before {
    opacity: 1;
}

.kpi-card.active-filter {
    border: 1px solid var(--brand-orange);
    box-shadow: 0 0 0 3px rgba(255, 122, 69, 0.3), 0 12px 40px rgba(0, 0, 0, 0.4);
}

.kpi-card.active-filter::before {
    background: linear-gradient(90deg, var(--brand-orange), var(--brand-orange-light));
    opacity: 1;
}

.kpi-content {
    display: flex;
    flex-direction: column;
    flex: 1;
    z-index: 1;
    min-width: 0;
}

.kpi-val {
    font-size: clamp(20px, 3.5vw, 28px);
    font-weight: 900;
    color: var(--text-primary);
    line-height: 1.2;
    margin-bottom: 8px;
    font-family: var(--font-secondary);
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
    text-overflow: ellipsis;
    max-height: 2.4em;
    word-break: break-word;
    hyphens: auto;
}

.kpi-val .unit {
    font-size: 16px;
    font-weight: 600;
    margin-left: 4px;
    color: var(--text-secondary);
}

.kpi-lbl {
    font-size: 12px;
    color: var(--text-secondary);
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 1px;
    margin-bottom: 4px;
    display: flex;
    align-items: center;
    gap: 6px;
}

.kpi-helper {
    font-size: 10px;
    color: var(--text-muted);
    font-weight: 400;
    line-height: 1.3;
}

/* === KPI TRENDS === */
.kpi-trend {
    font-size: 11px;
    font-weight: 700;
    padding: 4px 10px;
    border-radius: 20px;
    display: inline-flex;
    align-items: center;
    gap: 4px;
    margin-top: 8px;
    width: fit-content;
}

.kpi-trend.up {
    background: rgba(0, 201, 167, 0.15);
    color: var(--success-green);
}

.kpi-trend.down {
    background: rgba(255, 71, 87, 0.15);
    color: var(--error-red);
}

.kpi-trend.neutral {
    background: rgba(139, 141, 158, 0.15);
    color: var(--text-muted);
}



.kpi-icon {
    font-size: 36px;
    opacity: 0.2;
    color: var(--brand-blue);
    margin-left: 15px;
    transition: var(--transition-normal);
    z-index: 0;
}

.kpi-card:hover .kpi-icon {
    opacity: 0.3;
    transform: scale(1.1);
}

/* ===== FILTER TAGS MODERNAS ===== */
#activeFilters {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    margin-bottom: 20px;
    min-height: 0;
    padding: 5px 0;
}

.filter-tag {
    background: var(--gradient-primary);
    color: #fff;
    padding: 8px 16px;
    border-radius: var(--radius-full);
    font-size: 12px;
    font-weight: 600;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    box-shadow: var(--shadow-sm);
    cursor: pointer;
    transition: var(--transition-fast);
    border: 1px solid rgba(255, 255, 255, 0.2);
    animation: slideUp 0.3s ease-out forwards;
    transform: translateY(10px);
    opacity: 0;
}

@keyframes slideUp {
    to {
        transform: translateY(0);
        opacity: 1;
    }
}

.filter-tag:hover {
    transform: translateY(-2px) scale(1.05);
    box-shadow: var(--shadow-glow);
    border-color: rgba(255, 255, 255, 0.3);
}

.filter-tag i {
    font-size: 13px;
}

.filter-tag .fa-xmark {
    margin-left: 4px;
    color: rgba(255, 255, 255, 0.9);
    opacity: 0.8;
    transition: var(--transition-fast);
}

.filter-tag .fa-xmark:hover {
    opacity: 1;
    transform: rotate(90deg);
}

/* ===== CARDS E GRÁFICOS PREMIUM ===== */
.card {
    background: var(--bg-card);
    border-radius: var(--radius-lg);
    padding: 24px;
    box-shadow: var(--shadow-card);
    border: 1px solid var(--border-primary);
    transition: var(--transition-normal);
    position: relative;
    overflow: hidden;
    backdrop-filter: blur(10px);
    min-height: 400px;
    display: flex;
    flex-direction: column;
}

.card:hover {
    box-shadow: var(--shadow-lg);
    border-color: var(--border-light);
    transform: translateY(-2px);
}

.card::before {
    content: '';
    position: absolute;
    inset: 0;
    background: linear-gradient(135deg, rgba(61, 141, 255, 0.05) 0%, transparent 100%);
    opacity: 0;
    transition: var(--transition-normal);
}

.card:hover::before {
    opacity: 1;
}

.card-header-row {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: 15px;
    margin-bottom: 20px;
}

.card-title {
    margin: 0;
    font-size: 18px;
    color: var(--text-primary);
    font-weight: 700;
    display: flex;
    align-items: center;
    gap: 10px;
    font-family: var(--font-secondary);
}

.card-title i {
    background: var(--gradient-primary);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.card-subtitle {
    font-size: 13px;
    color: var(--text-secondary);
    margin-top: 5px;
    font-weight: 500;
}

.charts-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
    gap: 24px;
    margin-bottom: 24px;
}

.wide-chart {
    grid-column: span 2;
}

@media (max-width: 1200px) {
    .wide-chart {
        grid-column: span 1;
    }
}

.chart-container {
    position: relative;
    height: 300px;
    width: 100%;
    background: rgba(255, 255, 255, 0.02);
    border-radius: var(--radius-md);
    border: 1px solid var(--border-primary);
    padding: 15px;
    flex: 1;
}

.chart-scroll-container {
    overflow-y: auto;
    max-height: 500px;
    height: auto;
    min-height: 300px;
    padding: 15px;
    background: rgba(255, 255, 255, 0.02);
    border-radius: var(--radius-md);
    border: 1px solid var(--border-primary);
    flex: 1;
}

.chart-scroll-container::-webkit-scrollbar {
    width: 6px;
}

.chart-scroll-container::-webkit-scrollbar-track {
    background: rgba(255, 255, 255, 0.05);
    border-radius: 3px;
}

.chart-scroll-container::-webkit-scrollbar-thumb {
    background: var(--brand-blue);
    border-radius: 3px;
}

/* Doughnut center info */
.doughnut-center-info {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    text-align: center;
    pointer-events: none;
    width: 100%;
}

.doughnut-center-name {
    font-size: 14px;
    font-weight: 600;
    color: var(--text-secondary);
    margin-bottom: 5px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 80%;
    margin: 0 auto;
}

.doughnut-center-value {
    font-size: 24px;
    font-weight: 900;
    color: var(--brand-blue);
    font-family: var(--font-secondary);
}

.bar-chart-mini-container {
    height: 200px;
    width: 100%;
    position: relative;
    margin-top: 10px;
    background: rgba(255, 255, 255, 0.02);
    border-radius: var(--radius-md);
    border: 1px solid var(--border-primary);
    padding: 15px;
}

/* ===== FORM CONTROLS COM GLASSMORPHISM ===== */
.form-control {
    width: 100%;
    padding: 12px 16px;
    border: 1px solid var(--border-primary);
    border-radius: var(--radius-sm);
    font-family: inherit;
    font-size: 13px;
    margin-bottom: 12px;
    outline: none;
    background: rgba(255, 255, 255, 0.05);
    transition: var(--transition-fast);
    color: var(--text-primary);
    backdrop-filter: blur(10px);
}

.form-control:focus {
    border-color: var(--brand-blue);
    box-shadow: 0 0 0 3px rgba(61, 141, 255, 0.15);
    background: rgba(255, 255, 255, 0.08);
}

.form-control::placeholder {
    color: var(--text-muted);
}

.select-wrapper {
    position: relative;
    margin-bottom: 12px;
}

.select-wrapper::after {
    content: '\f078';
    font-family: 'Font Awesome 6 Free';
    font-weight: 900;
    position: absolute;
    right: 16px;
    top: 50%;
    transform: translateY(-50%);
    color: var(--text-muted);
    pointer-events: none;
    font-size: 12px;
}

.select-wrapper select {
    appearance: none;
    cursor: pointer;
    padding-right: 40px;
    background: rgba(255, 255, 255, 0.05);
}

/* ===== BOTÕES PREMIUM ===== */
.btn {
    border: none;
    border-radius: var(--radius-sm);
    padding: 10px 18px;
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    transition: var(--transition-normal);
    font-family: var(--font-primary);
    position: relative;
    overflow: hidden;
    outline: none;
    background: rgba(255, 255, 255, 0.1);
    color: var(--text-primary);
    border: 1px solid rgba(255, 255, 255, 0.2);
    backdrop-filter: blur(10px);
}

.btn::after {
    content: '';
    position: absolute;
    inset: 0;
    background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0) 100%);
    opacity: 0;
    transition: opacity 0.3s;
}

.btn:hover::after {
    opacity: 1;
}

.btn-primary {
    background: var(--gradient-secondary);
    color: #fff;
    border: none;
    box-shadow: 0 5px 15px rgba(255, 122, 69, 0.3);
}

.btn-primary:hover {
    transform: translateY(-3px) scale(1.05);
    box-shadow: 0 8px 25px rgba(255, 122, 69, 0.4);
}

.btn-secondary {
    background: var(--gradient-primary);
    color: #fff;
    border: none;
    box-shadow: 0 5px 15px rgba(61, 141, 255, 0.3);
}

.btn-secondary:hover {
    transform: translateY(-3px) scale(1.05);
    box-shadow: 0 8px 25px rgba(61, 141, 255, 0.4);
}

.btn-ghost {
    background: transparent;
    border: 1px solid var(--border-primary);
    color: var(--text-secondary);
    backdrop-filter: none;
}

.btn-ghost:hover {
    background: rgba(61, 141, 255, 0.1);
    color: var(--brand-blue);
    border-color: var(--brand-blue);
    transform: translateY(-2px);
}

.btn-icon {
    width: 40px;
    height: 40px;
    padding: 0;
    justify-content: center;
    border-radius: var(--radius-sm);
}

.btn-purple {
    background: var(--gradient-purple);
    color: #fff;
    border: none;
    box-shadow: 0 5px 15px rgba(157, 78, 221, 0.3);
}

.btn-purple:hover {
    transform: translateY(-3px) scale(1.05);
    box-shadow: 0 8px 25px rgba(157, 78, 221, 0.4);
}

/* Botão de automação */
.btn-automation {
    background: var(--gradient-purple);
    color: #fff;
    box-shadow: 0 5px 15px rgba(157, 78, 221, 0.3);
    border: none;
    border-radius: var(--radius-sm);
    padding: 8px 12px;
    font-size: 12px;
    font-weight: 600;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 6px;
    transition: var(--transition-normal);
    font-family: var(--font-primary);
    position: relative;
    overflow: hidden;
    outline: none;
    backdrop-filter: blur(10px);
}

.btn-automation:hover {
    transform: translateY(-2px) scale(1.05);
    box-shadow: 0 8px 25px rgba(157, 78, 221, 0.4);
}

/* ===== POPUPS MODERNOS - CORRIGIDOS ===== */
.notification-popup,
.development-popup,
.automation-popup {
    position: fixed;
    z-index: 2000;
    background: var(--bg-card);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-xl);
    border: 1px solid var(--border-primary);
    backdrop-filter: blur(30px);
    overflow: hidden;
    display: none;
    max-width: 90vw;
}

.notification-popup.show,
.development-popup.show,
.automation-popup.show {
    display: block;
}

/* Notificações */
.notification-popup {
    top: calc(var(--header-height) + 20px);
    right: 30px;
    width: 380px;
    max-height: 80vh;
    overflow-y: auto;
}

.notification-header {
    padding: 24px;
    border-bottom: 1px solid var(--border-primary);
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: 15px;
}

.notification-title {
    font-size: 18px;
    font-weight: 700;
    color: var(--text-primary);
    display: flex;
    align-items: center;
    gap: 10px;
    font-family: var(--font-secondary);
}

.notification-title i {
    color: var(--purple);
}

.notification-subtitle {
    font-size: 13px;
    color: var(--text-secondary);
    margin-top: 5px;
}

.notification-close {
    background: none;
    border: none;
    color: var(--text-secondary);
    font-size: 16px;
    cursor: pointer;
    padding: 5px;
    border-radius: var(--radius-sm);
    transition: var(--transition-fast);
}

.notification-close:hover {
    background: rgba(255, 255, 255, 0.1);
    color: var(--text-primary);
}

.notification-content {
    padding: 20px;
}

.notification-item {
    background: rgba(255, 255, 255, 0.05);
    border-radius: var(--radius-md);
    padding: 20px;
    margin-bottom: 15px;
    border: 1px solid var(--border-primary);
    transition: var(--transition-fast);
}

.notification-item:hover {
    background: rgba(255, 255, 255, 0.08);
    border-color: var(--border-light);
}

.notification-item-title {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
    font-weight: 600;
    color: var(--text-primary);
}

.notification-item-date {
    font-size: 11px;
    color: var(--text-muted);
    font-weight: 500;
}

.notification-item-content {
    font-size: 13px;
    color: var(--text-secondary);
    line-height: 1.5;
    margin-bottom: 15px;
}

.notification-item-stats {
    display: flex;
    gap: 15px;
    background: rgba(0, 0, 0, 0.2);
    padding: 15px;
    border-radius: var(--radius-sm);
}

.notification-item-stats > div {
    flex: 1;
    text-align: center;
}

.notification-item-stats .stat-number {
    font-size: 24px;
    font-weight: 800;
    font-family: var(--font-secondary);
    color: var(--text-primary);
}

.notification-item-stats .stat-label {
    font-size: 11px;
    color: var(--text-muted);
    margin-top: 5px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.notification-empty {
    text-align: center;
    padding: 40px 20px;
    color: var(--text-muted);
}

.notification-empty i {
    font-size: 48px;
    margin-bottom: 15px;
    opacity: 0.5;
}

.notification-empty h3 {
    font-size: 16px;
    margin-bottom: 10px;
    color: var(--text-secondary);
}

.notification-empty p {
    font-size: 13px;
}

.notification-footer {
    display: flex;
    gap: 10px;
    padding: 20px;
    border-top: 1px solid var(--border-primary);
}

/* Desenvolvimento e Automação */
.development-popup,
.automation-popup {
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 400px;
}

.development-header,
.automation-header {
    padding: 30px;
    text-align: center;
    border-bottom: 1px solid var(--border-primary);
}

.development-icon,
.automation-icon {
    font-size: 48px;
    margin-bottom: 20px;
    color: var(--brand-blue);
}

.development-title,
.automation-title {
    font-size: 22px;
    font-weight: 800;
    color: var(--text-primary);
    margin-bottom: 10px;
    font-family: var(--font-secondary);
}

.development-subtitle,
.automation-subtitle {
    font-size: 14px;
    color: var(--text-secondary);
}

.development-content,
.automation-content {
    padding: 30px;
    text-align: center;
}

.development-text,
.automation-text {
    font-size: 14px;
    color: var(--text-secondary);
    line-height: 1.6;
    margin-bottom: 25px;
}

.development-close,
.automation-close-btn {
    min-width: 150px;
    justify-content: center;
}

.automation-close {
    position: absolute;
    top: 20px;
    right: 20px;
    background: none;
    border: none;
    color: var(--text-secondary);
    font-size: 16px;
    cursor: pointer;
    padding: 5px;
    border-radius: var(--radius-sm);
    transition: var(--transition-fast);
}

.automation-close:hover {
    background: rgba(255, 255, 255, 0.1);
    color: var(--text-primary);
}

/* ===== TOAST MODERNO ===== */
.toast {
    position: fixed;
    top: 100px;
    right: 30px;
    background: linear-gradient(135deg, #1A1B2E 0%, #12131F 100%);
    color: white;
    padding: 16px 20px;
    border-radius: var(--radius-md);
    box-shadow: var(--shadow-xl);
    z-index: 3000;
    display: flex;
    align-items: center;
    gap: 12px;
    border-left: 4px solid var(--brand-blue);
    border: 1px solid rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(20px);
    max-width: 350px;
    animation: slideInRight 0.3s ease-out forwards;
    transform: translateX(400px);
}

@keyframes slideInRight {
    to {
        transform: translateX(0);
    }
}

.toast.success { border-left-color: var(--success-green); }
.toast.error { border-left-color: var(--error-red); }
.toast.info { border-left-color: var(--brand-blue); }
.toast.warning { border-left-color: var(--warning); }
.toast.purple { border-left-color: var(--purple); }

/* ===== GRÁFICO COM EFEITOS PREMIUM ===== */
.chart-container canvas,
.bar-chart-mini-container canvas,
.chart-scroll-container canvas {
    filter: drop-shadow(0 4px 12px rgba(0, 0, 0, 0.2));
}

/* Estilização dos pontos do gráfico */
.chartjs-render-monitor .chartjs-tooltip {
    background: var(--bg-card) !important;
    border: 1px solid var(--border-primary) !important;
    border-radius: var(--radius-sm) !important;
    box-shadow: var(--shadow-lg) !important;
    backdrop-filter: blur(20px);
}

.chartjs-render-monitor .chartjs-tooltip-key {
    background: var(--brand-blue) !important;
}

/* Pontos com glow no hover */
.chartjs-render-monitor .point {
    transition: all 0.3s ease;
}

.chartjs-render-monitor .point:hover {
    box-shadow: 0 0 15px var(--brand-blue);
    border: 2px solid white !important;
}

/* ===== TABELA MODERNA ===== */
.table-container {
    max-height: 400px;
    overflow: auto;
    border-radius: var(--radius-md);
    border: 1px solid var(--border-primary);
    box-shadow: inset 0 2px 10px rgba(0, 0, 0, 0.1);
    backdrop-filter: blur(10px);
}

.table-container::-webkit-scrollbar {
    width: 8px;
    height: 8px;
}

.table-container::-webkit-scrollbar-track {
    background: rgba(255, 255, 255, 0.05);
    border-radius: 4px;
}

.table-container::-webkit-scrollbar-thumb {
    background: var(--brand-blue);
    border-radius: 4px;
}

.table-container::-webkit-scrollbar-thumb:hover {
    background: var(--brand-blue-light);
}

.table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
    font-size: 13px;
    min-width: 1200px;
}

.table thead {
    background: linear-gradient(135deg, rgba(61, 141, 255, 0.1) 0%, rgba(157, 78, 221, 0.1) 100%);
    position: sticky;
    top: 0;
    z-index: 10;
    backdrop-filter: blur(20px);
}

.table th {
    color: var(--brand-blue);
    font-weight: 700;
    padding: 16px 14px;
    text-align: left;
    cursor: pointer;
    user-select: none;
    border-bottom: 2px solid var(--brand-blue);
    font-family: var(--font-secondary);
    font-size: 13px;
    white-space: nowrap;
    transition: var(--transition-fast);
}

.table th:hover {
    background: rgba(61, 141, 255, 0.15);
}

.table th span.sort-indicator {
    margin-left: 8px;
    font-size: 10px;
    opacity: 0.8;
}

.table td {
    padding: 14px;
    border-bottom: 1px solid var(--border-primary);
    transition: var(--transition-fast);
}

.table tr:nth-child(even) {
    background-color: rgba(255, 255, 255, 0.02);
}

.table tr:hover {
    background-color: rgba(61, 141, 255, 0.1);
    cursor: pointer;
}

.table tr.active-filter {
    background-color: rgba(255, 122, 69, 0.1);
    box-shadow: inset 0 0 0 1px var(--brand-orange);
}

.table td.filterable {
    cursor: pointer;
}

/* Status pills */
.status-pill {
    padding: 6px 14px;
    border-radius: var(--radius-full);
    font-size: 11px;
    font-weight: 700;
    text-transform: uppercase;
    display: inline-block;
    letter-spacing: 0.5px;
    box-shadow: var(--shadow-sm);
    border: 1px solid rgba(255, 255, 255, 0.2);
}

.st-fechado {
    background: var(--gradient-success);
    color: #fff;
}

.st-aberto {
    background: var(--gradient-warning);
    color: #fff;
}

.truncated {
    max-width: 220px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    cursor: help;
}

.table td.icon-cell {
    font-weight: 600;
}

.table td.icon-cell i {
    font-size: 16px;
    margin-right: 8px;
    vertical-align: middle;
}

/* ===== PAGINAÇÃO ===== */
.pagination {
    display: flex;
    align-items: center;
    gap: 8px;
}

.pagination-info {
    font-size: 12px;
    color: var(--text-secondary);
    font-weight: 500;
}

.pagination-btn {
    width: 32px;
    height: 32px;
    border-radius: var(--radius-sm);
    border: 1px solid var(--border-primary);
    background: rgba(255, 255, 255, 0.05);
    color: var(--brand-blue);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: var(--transition-fast);
    backdrop-filter: blur(10px);
}

.pagination-btn:hover {
    background: var(--brand-blue);
    color: white;
    border-color: var(--brand-blue);
    transform: translateY(-2px);
}

.pagination-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    background: rgba(255, 255, 255, 0.05);
    transform: none;
}

/* ===== LOADING ===== */
#loading {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: var(--bg-overlay);
    backdrop-filter: blur(20px);
    z-index: 4000;
    display: flex;
    align-items: center;
    justify-content: center;
    display: none;
}

.loading-content {
    background: var(--bg-card);
    border-radius: var(--radius-lg);
    padding: 40px;
    border: 1px solid var(--border-primary);
    box-shadow: var(--shadow-xl);
    backdrop-filter: blur(20px);
    text-align: center;
    width: 400px;
    max-width: 90vw;
}

.loading-spinner {
    width: 50px;
    height: 50px;
    border: 4px solid rgba(61, 141, 255, 0.1);
    border-top-color: var(--brand-blue);
    border-radius: 50%;
    margin: 0 auto 20px;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

.loading-text {
    font-size: 16px;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 10px;
}

.loading-subtext {
    font-size: 13px;
    color: var(--text-secondary);
}

/* ===== ANIMAÇÕES ===== */
@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

@keyframes slideInLeft {
    from { opacity: 0; transform: translateX(-20px); }
    to { opacity: 1; transform: translateX(0); }
}

.fade-in { animation: fadeIn 0.5s ease-out forwards; }
.slide-in-left { animation: slideInLeft 0.4s ease-out forwards; }

/* ===== ESTILOS PARA O NOVO MODAL DE AUTOMAÇÃO ===== */
.automation-popup {
    width: 95% !important;
    max-width: 1400px !important;
    height: 90vh !important;
}

.automation-content {
    padding: 0 !important;
    overflow: hidden !important;
    height: calc(100% - 140px) !important;
}

/* Tabs de Navegação */
.tabs-container {
    padding: 0 20px;
    display: flex;
    border-bottom: 1px solid var(--border-primary);
    background: var(--bg-card);
}

.tab-btn {
    padding: 12px 20px;
    background: none;
    border: none;
    border-bottom: 3px solid transparent;
    color: var(--text-secondary);
    font-weight: 600;
    font-size: 13px;
    cursor: pointer;
    transition: var(--transition-fast);
    display: flex;
    align-items: center;
    gap: 8px;
}

.tab-btn:hover {
    color: var(--brand-blue);
    background: rgba(61, 141, 255, 0.05);
}

.tab-btn.active {
    color: var(--brand-blue);
    border-bottom-color: var(--brand-blue);
    background: rgba(61, 141, 255, 0.1);
}

.tabs-content {
    height: calc(100% - 50px);
    overflow-y: auto;
    padding: 20px;
}

.tab-pane {
    display: none;
    height: 100%;
}

.tab-pane.active {
    display: block;
    animation: fadeIn 0.3s ease-out;
}

/* Estilos específicos para o conteúdo das tabs */
.tab-pane h3 {
    margin: 0;
    color: var(--text-primary);
    font-size: 18px;
    font-weight: 700;
    margin-bottom: 20px;
}

.tab-pane h4 {
    margin: 0;
    color: var(--text-primary);
    font-size: 16px;
    font-weight: 600;
    margin-bottom: 10px;
}

.motivo-stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 20px;
    margin-top: 20px;
}

.stat-card {
    background: rgba(255, 255, 255, 0.05);
    border-radius: var(--radius-md);
    padding: 15px;
    border: 1px solid var(--border-primary);
}

.stat-card h4 {
    color: var(--brand-blue);
    border-bottom: 2px solid var(--brand-blue);
    padding-bottom: 8px;
    margin-bottom: 15px;
}

.btn-sm {
    padding: 6px 12px !important;
    font-size: 12px !important;
}

/* ===== RESPONSIVIDADE ===== */
@media (max-width: 1800px) {
    .kpi-grid { grid-template-columns: repeat(6, 1fr); }
}

@media (max-width: 1500px) {
    .kpi-grid { grid-template-columns: repeat(5, 1fr); }
}

@media (max-width: 1300px) {
    .kpi-grid { grid-template-columns: repeat(4, 1fr); }
}

@media (max-width: 1200px) {
    .charts-grid { grid-template-columns: 1fr; }
    .kpi-grid { grid-template-columns: repeat(3, 1fr); }
    .wide-chart { grid-column: span 1; }
}

@media (max-width: 900px) {
    body { overflow: auto; min-width: auto; }
    .layout { flex-direction: column; height: auto; }
    .sidebar {
        width: 100%;
        height: auto;
        position: relative;
        top: 0;
        margin-top: 0;
        order: 2;
        box-shadow: none;
        border-right: none;
        border-top: 1px solid var(--border-primary);
        padding: 20px;
    }
    .sidebar:hover { width: 100%; }
    .sb-icons { display: none; }
    .sb-content {
        opacity: 1;
        transform: none;
        width: 100%;
        padding: 0;
    }
    .main {
        order: 1;
        padding: 20px;
        margin-left: 0;
    }
    .header { padding: 0 20px; height: 70px; }
    .header-stats { display: none; }
    .kpi-grid { grid-template-columns: repeat(2, 1fr); }
    .card { padding: 20px; }
    .notification-popup {
        top: 20px;
        right: 20px;
        left: 20px;
        width: auto;
    }
    .automation-popup {
        width: 95vw !important;
        height: 95vh !important;
    }
}

@media (max-width: 600px) {
    .header {
        flex-direction: column;
        height: auto;
        padding: 15px;
        gap: 15px;
        position: relative;
    }
    .header-left, .header-right { width: 100%; justify-content: center; }
    .header-actions { justify-content: center; flex-wrap: wrap; }
    .context-bar { flex-direction: column; align-items: stretch; gap: 15px; }
    .context-actions { width: 100%; flex-direction: column; }
    .context-hint { width: 100%; justify-content: center; text-align: center; }
    .btn-automation, .btn-ghost { width: 100%; justify-content: center; }
    .btn { padding: 10px 16px; font-size: 13px; }
    .kpi-grid { grid-template-columns: 1fr; gap: 12px; }
    .kpi-card { padding: 16px; min-height: 100px; }
    .kpi-val { font-size: 24px; }
    .kpi-sticky-container { position: relative; top: 0; }
    .development-popup,
    .automation-popup {
        width: 90vw;
        padding: 0;
    }
    .tabs-container {
        flex-wrap: wrap;
    }
    .tab-btn {
        flex: 1;
        min-width: 120px;
        justify-content: center;
        padding: 10px 12px;
    }
}

/* Adicionar efeito de ripple aos botões */
@keyframes ripple {
    to { transform: scale(4); opacity: 0; }
}

/* AJUSTES PARA LAYOUT DOS GRÁFICOS */
@media (min-width: 1400px) {
    .charts-grid {
        grid-template-columns: repeat(2, 1fr);
    }
    .card:nth-child(5) {
        grid-column: 1;
    }
    .card:nth-child(6) {
        grid-column: 2;
    }
}

/* ===== NOVOS ESTILOS PARA MELHORIAS VISUAIS ===== */

/* Tooltip para Motivo Mais Tratado */
.motivo-tooltip {
    position: absolute;
    top: calc(100% + 10px);
    left: 50%;
    transform: translateX(-50%);
    background: var(--bg-card);
    border: 1px solid var(--border-primary);
    border-radius: var(--radius-md);
    padding: 16px;
    box-shadow: var(--shadow-xl);
    z-index: 1000;
    display: none;
    width: 280px;
    font-size: 13px;
    backdrop-filter: blur(20px);
    animation: fadeIn 0.2s ease-out;
}

.motivo-tooltip.show {
    display: block;
}

.motivo-tooltip h4 {
    margin-top: 0;
    margin-bottom: 12px;
    color: var(--brand-blue);
    font-size: 14px;
    font-weight: 700;
    display: flex;
    align-items: center;
    gap: 8px;
}

.motivo-tooltip p {
    margin: 8px 0;
    color: var(--text-secondary);
    line-height: 1.4;
    display: flex;
    justify-content: space-between;
}

.motivo-tooltip p strong {
    color: var(--text-primary);
    font-weight: 600;
    min-width: 100px;
}

.motivo-tooltip p span {
    text-align: right;
    font-weight: 500;
}

/* Paleta de cores para gráficos de motivo */
.motivo-palette {
    --color-motivo-1: #0045B5;
    --color-motivo-2: #FFD100;
    --color-motivo-3: #0068FF;
    --color-motivo-4: #00ADFF;
    --color-motivo-5: #00266E;
    --color-motivo-6: #FFB206;
    --color-motivo-7: #00D9B8;
    --color-motivo-8: #939598;
    --color-motivo-9: #00C9A7;
    --color-motivo-10: #FFA93D;
    --color-motivo-11: #4CE4C9;
    --color-motivo-12: #3D8DFF;
    --color-motivo-13: #6CABFF;
    --color-motivo-14: #FFE4A1;
    --color-motivo-15: #FF9E76;
}

/* Legenda responsiva sem scroll */
.legend-container {
    width: 100%;
    max-height: 100%;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    gap: 4px;
    padding: 8px 0;
}

.legend-item {
    display: flex;
    align-items: center;
    padding: 6px 8px;
    border-radius: var(--radius-sm);
    transition: var(--transition-fast);
    font-size: 0.85em;
    min-height: 32px;
}

.legend-item:hover {
    background: rgba(255, 255, 255, 0.05);
}

.legend-color {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    margin-right: 10px;
    flex-shrink: 0;
}

.legend-label {
    flex: 1;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    font-weight: 500;
    color: var(--text-primary);
}

.legend-value {
    margin-left: 8px;
    font-weight: 600;
    color: var(--brand-blue);
    white-space: nowrap;
}

/* Ajustes de estabilidade para zoom */
.chart-container,
.bar-chart-mini-container,
.chart-scroll-container {
    transform-origin: 0 0;
    transform: scale(1);
    transition: transform 0.1s ease;
}

/* Ajustes responsivos para gráficos */
@media (min-width: 768px) {
    .chart-container {
        height: 320px;
    }
    
    .bar-chart-mini-container {
        height: 220px;
    }
}

/* Ajustes de texto responsivo */
@media (max-width: 1400px) {
    .kpi-val {
        font-size: clamp(18px, 2.5vw, 24px);
    }
    
    .legend-item {
        font-size: 0.8em;
    }
}

/* Prevenir quebra de layout em zoom */
@media (max-resolution: 192dpi) {
    .charts-grid {
        gap: 20px;
    }
    
    .kpi-grid {
        gap: 12px;
    }
}

/* Melhorias de acessibilidade em foco */
:focus-visible {
    outline: 2px solid var(--brand-blue);
    outline-offset: 2px;
}

/* Suporte a alto contraste */
@media (prefers-contrast: high) {
    .kpi-card {
        border: 2px solid var(--border-primary);
    }
    
    .legend-item {
        border: 1px solid var(--border-light);
    }
}

/* Styles for the Motivo Details Popup */
.motivo-info-icon {
    font-size: 14px;
    color: var(--brand-blue);
    cursor: pointer;
    margin-left: 6px;
    opacity: 0.7;
    transition: var(--transition-fast);
    vertical-align: middle;
}

.motivo-info-icon:hover {
    opacity: 1;
    transform: scale(1.2);
}

.motivo-details-popup {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: var(--bg-card);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-xl);
    border: 1px solid var(--border-primary);
    width: 500px;
    max-width: 90vw;
    z-index: 3000;
    display: none;
    overflow: hidden;
}

.motivo-details-popup.show {
    display: block;
    animation: fadeIn 0.3s ease-out;
}

.motivo-details-header {
    background: var(--brand-blue);
    color: white;
    padding: 24px;
    text-align: center;
    border-bottom: 1px solid var(--border-primary);
}

.motivo-details-title {
    font-size: 20px;
    font-weight: 700;
    margin-bottom: 8px;
    font-family: var(--font-secondary);
}

.motivo-details-subtitle {
    font-size: 13px;
    opacity: 0.9;
}

.motivo-details-close {
    position: absolute;
    top: 20px;
    right: 20px;
    background: none;
    border: none;
    color: white;
    font-size: 18px;
    cursor: pointer;
    padding: 5px;
    border-radius: var(--radius-sm);
    transition: var(--transition-fast);
}

.motivo-details-close:hover {
    background: rgba(255, 255, 255, 0.2);
}

.motivo-details-content {
    padding: 24px;
    color: var(--text-primary);
}

.motivo-details-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 0;
    border-bottom: 1px solid var(--border-light);
}

.motivo-details-row:last-child {
    border-bottom: none;
}

.motivo-details-label {
    font-size: 14px;
    color: var(--text-secondary);
    font-weight: 600;
}

.motivo-details-value {
    font-size: 15px;
    font-weight: 700;
    color: var(--text-primary);
    text-align: right;
    max-width: 60%;
}

.motivo-details-note {
    margin-top: 20px;
    padding: 12px;
    background: rgba(61, 141, 255, 0.05);
    border-radius: var(--radius-sm);
    font-size: 12px;
    color: var(--text-secondary);
    border: 1px solid rgba(61, 141, 255, 0.1);
}

.motivo-details-note i {
    color: var(--brand-blue);
    margin-right: 6px;
}
</style>

<!-- IDENTIDADE VISUAL IPIRANGA -->
<style>
/* ===== TOKENS IPIRANGA ===== */
:root {
  --color-azul: #0045B5;
  --color-amarelo: #FFD100;
  --color-laranja: #FF6900;
  --color-indigo: #0068FF;
  --color-chumbo: #58595B;
  --color-asfalto: #939598;
  --color-cromo: #D1D3D4;
  --color-preto: #000000;
  
  /* Cores de suporte */
  --color-aqua: #00D9B8;
  --color-laranja-escuro: #F04C25;
  --color-cinza-claro: #F7F7F7;
  
  /* Tipografia */
  --font-title: 'Montserrat', 'Inter', Verdana, sans-serif;
  --font-text: 'Inter', 'Segoe UI', Arial, sans-serif;
}

/* ===== CABEÇALHO - AMARELO COM TEXTO AZUL ===== */
.header {
    background: var(--color-azul) !important;
    color: #fff !important;
    border-bottom: 1px solid rgba(255, 255, 255, 0.15) !important;
  }

  .header::before {
    background: linear-gradient(90deg, var(--color-amarelo), var(--color-laranja)) !important;

}

.header-left .header-title {
    color: #fff !important;
    -webkit-text-fill-color: #fff !important;
    background: none !important;

}

.header-subtitle {
    color: #fff !important;
    opacity: 0.9 !important;
}

.header-logo {
    background: var(--color-amarelo) !important;
    color: var(--color-azul) !important;
    box-shadow: 0 4px 12px rgba(255, 209, 0, 0.3) !important;
  }

  .header-stats .stat-item {
    background: rgba(255, 255, 255, 0.15) !important;
    border: 1px solid rgba(255, 255, 255, 0.25) !important;
}

.header-stats .stat-value {
    color: #fff !important;
}

.header-stats .stat-label {
    color: #fff !important;
    opacity: 0.8 !important;
}

/* ===== ÍCONES E AVATAR ===== */
.header-actions .btn {
    color: #fff !important;
    background: rgba(255, 255, 255, 0.15) !important;
    border: 1px solid rgba(255, 255, 255, 0.25) !important;
}

.header-actions .btn:hover {
  background: rgba(255, 255, 255, 0.5) !important;
}

/* ===== BOTÕES PRINCIPAIS ===== */
.btn-primary {
  background: var(--color-azul) !important;
  box-shadow: 0 5px 15px rgba(0, 69, 181, 0.3) !important;
  border: none !important;
}

.btn-primary:hover {
  background: var(--color-indigo) !important;
  box-shadow: 0 8px 25px rgba(0, 104, 255, 0.4) !important;
}

.btn-secondary {
  background: var(--color-chumbo) !important;
  color: white !important;
  border: none !important;
  box-shadow: 0 5px 15px rgba(88, 89, 91, 0.3) !important;
}

.btn-secondary:hover {
  background: #6c6d6f !important;
  box-shadow: 0 8px 25px rgba(108, 109, 111, 0.4) !important;
}

.btn-ghost {
  color: var(--color-azul) !important;
  border-color: var(--color-azul) !important;
  background: transparent !important;
}

.btn-ghost:hover {
  color: var(--color-indigo) !important;
  border-color: var(--color-indigo) !important;
  background: rgba(0, 104, 255, 0.05) !important;
}

.btn-purple,
.btn-automation {
  background: var(--color-azul) !important;
  box-shadow: 0 5px 15px rgba(0, 69, 181, 0.3) !important;
}

.btn-purple:hover,
.btn-automation:hover {
  background: var(--color-indigo) !important;
  box-shadow: 0 8px 25px rgba(0, 104, 255, 0.4) !important;
}

/* ===== KPIs E CARTÕES ===== */
.kpi-card {
  background: white !important;
  border: 1px solid var(--color-cromo) !important;
  box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15) !important;
}

.kpi-card:hover {
  border-color: var(--color-azul) !important;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.25) !important;
}

.kpi-card::before {
  background: linear-gradient(90deg, var(--color-azul), var(--color-indigo)) !important;
}

.kpi-card.active-filter {
  border-color: var(--color-laranja) !important;
  box-shadow: 0 0 0 3px rgba(255, 105, 0, 0.2), 0 12px 40px rgba(0, 0, 0, 0.15) !important;
}

.kpi-card.active-filter::before {
  background: linear-gradient(90deg, var(--color-laranja), #ff8533) !important;
}

.kpi-lbl {
  color: var(--color-azul) !important;
}

.kpi-val {
  color: var(--color-preto) !important;
}

.kpi-icon {
  color: var(--color-amarelo) !important;
  opacity: 0.3 !important;
}

.kpi-card:hover .kpi-icon {
  opacity: 0.4 !important;
}

/* KPIs específicos */
#kOpen,
#headerOpen {
  color: var(--color-amarelo) !important;
}

#kClosed,
#headerClosed {
  color: var(--color-aqua) !important;
}

/* ===== FILTROS E INPUTS ===== */
.filter-tag {
  background: var(--color-azul) !important;
  border-color: rgba(0, 69, 181, 0.3) !important;
}

.filter-tag:hover {
  background: var(--color-indigo) !important;
}

.form-control {
  border: 1px solid var(--color-cromo) !important;
  background: white !important;
  color: var(--color-preto) !important;
}

.form-control:focus {
  border-color: var(--color-indigo) !important;
  box-shadow: 0 0 0 3px rgba(0, 104, 255, 0.15) !important;
}

.select-wrapper::after {
  color: var(--color-chumbo) !important;
}

/* ===== CONTEXT BAR ===== */
.context-bar {
  background: white !important;
  border: 1px solid var(--color-cromo) !important;
}

.context-text {
  color: var(--color-chumbo) !important;
}

.context-text span {
  background: rgba(0, 69, 181, 0.1) !important;
  color: var(--color-azul) !important;
  border: 1px solid rgba(0, 69, 181, 0.2) !important;
}

.context-hint {
  background: rgba(0, 69, 181, 0.05) !important;
  border: 1px solid rgba(0, 69, 181, 0.1) !important;
  color: var(--color-azul) !important;
}

/* ===== GRÁFICOS - AJUSTE DAS PALETAS ===== */
/* Gráfico de barras - Performance por Analista */
#chartAnal {
  --chart-color-primary: var(--color-azul);
  --chart-color-secondary: var(--color-amarelo);
}

/* Gráfico de rosca - Origem do Contato */
#chartOrigemContato {
  --chart-color-primary: var(--color-azul);
  --chart-color-secondary: var(--color-amarelo);
}

/* Gráfico de barras - Tipo de Atendimento */
#chartTipoAtendimento {
  --chart-color-ativo: var(--color-azul);
  --chart-color-receptivo: var(--color-amarelo);
}

/* Gráfico de rosca - Subclassificação */
#chartSubclassificacao {
  --chart-color-primary: var(--color-azul);
  --chart-color-secondary: var(--color-amarelo);
}

/* Gráfico de linha - Evolução Diária */
#chartEvo {
  --chart-color-total: var(--color-azul);
  --chart-color-concluido: var(--color-aqua);
}

/* Gráfico de barras horizontais - Distribuição por Motivo */
#chartMot {
  --chart-color-primary: var(--color-azul);
  --chart-color-secondary: var(--color-amarelo);
  --chart-color-accent: var(--color-laranja);
}

/* ===== TABELAS ===== */
.table thead {
  background: var(--color-azul) !important;
}

.table th {
  color: white !important;
  border-bottom-color: var(--color-amarelo) !important;
}

.table th:hover {
  background: rgba(255, 255, 255, 0.1) !important;
}

.table tr:nth-child(even) {
  background-color: var(--color-cinza-claro) !important;
}

.table tr:hover {
  background-color: rgba(255, 209, 0, 0.18) !important;
}

.table tr.active-filter {
  background-color: rgba(255, 105, 0, 0.1) !important;
}

/* Status pills */
.st-fechado {
  background: var(--color-aqua) !important;
  color: white !important;
}

.st-aberto {
  background: var(--color-amarelo) !important;
  color: var(--color-preto) !important;
}

/* ===== NOTIFICAÇÕES ===== */
.notification-popup {
  background: white !important;
  border: 1px solid var(--color-cromo) !important;
}

.notification-header {
  border-bottom-color: var(--color-cromo) !important;
}

.notification-title i {
  color: var(--color-azul) !important;
}

.notification-item {
  background: #f9f9f9 !important;
  border: 1px solid var(--color-cromo) !important;
}

.notification-item-stats {
  background: rgba(0, 69, 181, 0.05) !important;
}

/* Alertas/Toast */
.toast.success {
  border-left-color: var(--color-aqua) !important;
  background: #E9FCF6 !important;
  color: var(--color-preto) !important;
}

.toast.warning {
  border-left-color: var(--color-amarelo) !important;
  background: #FFF7CC !important;
  color: var(--color-preto) !important;
}

.toast.error {
  border-left-color: var(--color-laranja-escuro) !important;
  background: #FFE6DB !important;
  color: var(--color-preto) !important;
}

.toast.info {
  border-left-color: var(--color-azul) !important;
  background: #E6F0FF !important;
  color: var(--color-preto) !important;
}

/* ===== SIDEBAR ===== */
.sidebar {
  background: white !important;
  border-right: 1px solid var(--color-cromo) !important;
}

.section-title {
  color: var(--color-azul) !important;
}

.section-title::after {
  background: linear-gradient(90deg, var(--color-azul), var(--color-amarelo)) !important;
}

#connectionStatus {
  border: 1px solid var(--color-azul) !important;
  background: rgba(0, 69, 181, 0.05) !important;
}

/* ===== CARTÕES GERAIS ===== */
.card {
  background: white !important;
  border: 1px solid var(--color-cromo) !important;
}

.card-title i {
  color: inherit !important;
  background: none !important;
  -webkit-text-fill-color: inherit !important;
}

/* ===== PAGINAÇÃO ===== */
.pagination-btn {
  border-color: var(--color-cromo) !important;
  color: var(--color-azul) !important;
}

.pagination-btn:hover {
  background: var(--color-azul) !important;
  color: white !important;
  border-color: var(--color-azul) !important;
}

/* ===== MODAL DE AUTOMAÇÃO ===== */
.automation-popup,
.development-popup {
  background: white !important;
  border: 1px solid var(--color-cromo) !important;
}

.automation-header,
.development-header {
  border-bottom-color: var(--color-cromo) !important;
}

.automation-icon,
.development-icon {
  color: var(--color-azul) !important;
}

.tab-btn.active {
  color: var(--color-azul) !important;
  border-bottom-color: var(--color-azul) !important;
}

.tab-btn:hover {
  color: var(--color-indigo) !important;
}

.stat-card {
  background: #f9f9f9 !important;
  border: 1px solid var(--color-cromo) !important;
}

/* ===== LINKS ===== */
a {
  color: var(--color-azul) !important;
}

a:hover {
  color: var(--color-indigo) !important;
}

/* ===== ACESSIBILIDADE ===== */
:focus-visible {
  outline: 3px solid var(--color-indigo) !important;
  outline-offset: 2px !important;
}

/* ===== AJUSTES PARA TEXTO SOBRE FUNDO AMARELO ===== */
.on-yellow {
  color: var(--color-azul) !important;
}

/* ===== LEGENDAS/EIXOS PARA GRÁFICOS ===== */
.chart-container,
.bar-chart-mini-container,
.chart-scroll-container {
  background: white !important;
  border: 1px solid var(--color-cromo) !important;
}

/* Eixos de gráficos */
.chartjs-render-monitor .chartjs-tooltip {
  background: white !important;
  border: 1px solid var(--color-cromo) !important;
  color: var(--color-preto) !important;
}

/* ===== NOVOS ESTILOS IPIRANGA ===== */

/* Tooltip para Motivo Mais Tratado - Estilo Ipiranga */
.motivo-tooltip {
  background: white !important;
  border: 1px solid var(--color-cromo) !important;
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15) !important;
}

.motivo-tooltip h4 {
  color: var(--color-azul) !important;
  border-bottom: 2px solid var(--color-amarelo) !important;
  padding-bottom: 8px;
}

.motivo-tooltip p {
  color: var(--color-chumbo) !important;
}

.motivo-tooltip p strong {
  color: var(--color-azul) !important;
}

.motivo-tooltip p span {
  color: var(--color-preto) !important;
  font-weight: 600;
}

/* Legenda Ipiranga */
.legend-item {
  background: white !important;
  border: 1px solid var(--color-cromo) !important;
}

.legend-item:hover {
  background: var(--color-cinza-claro) !important;
}

.legend-label {
  color: var(--color-preto) !important;
}

.legend-value {
  color: var(--color-azul) !important;
}

/* Ícone de informação no KPI */
.kpi-lbl .fa-circle-info {
  color: var(--color-azul) !important;
  opacity: 0.7;
  transition: opacity 0.2s ease;
}

.kpi-lbl .fa-circle-info:hover {
  opacity: 1;
}

/* Styles for the Motivo Details Popup - Ipiranga */
.motivo-info-icon {
  color: var(--color-azul) !important;
}

.motivo-details-popup {
  background: white !important;
  border: 1px solid var(--color-cromo) !important;
}

.motivo-details-header {
  background: var(--color-azul) !important;
}

.motivo-details-title {
  color: white !important;
}

.motivo-details-subtitle {
  color: rgba(255, 255, 255, 0.9) !important;
}

.motivo-details-close {
  color: white !important;
}

.motivo-details-close:hover {
  background: rgba(255, 255, 255, 0.2) !important;
}

.motivo-details-content {
  background: white !important;
  color: var(--color-preto) !important;
}

.motivo-details-label {
  color: var(--color-chumbo) !important;
}

.motivo-details-value {
  color: var(--color-azul) !important;
}

.motivo-details-note {
  background: rgba(0, 69, 181, 0.05) !important;
  border: 1px solid rgba(0, 69, 181, 0.1) !important;
  color: var(--color-chumbo) !important;
}

.motivo-details-note i {
  color: var(--color-azul) !important;
}
</style>
</head>
<body>
<header class="header" role="banner" aria-label="Cabeçalho principal">
<div class="header-left">
    <img src="https://pbs.twimg.com/profile_images/1633505846981283841/KeJ1rMhg_400x400.jpg"
         alt="Logo Consolida Torre" 
         class="header-logo-img"
         aria-label="Logo ConsolidaTorre">
    <div class="header-titles">
        <div class="header-title">CONSOLIDA | TORRE</div>
        <div class="header-subtitle">Torre de Expansão • Mapeamento de Contato</div>
    </div>
</div>
<div class="header-right">
<div class="header-stats" aria-label="Estatísticas gerais">
<div class="stat-item">
<div class="stat-value" id="headerTotal">0</div>
<div class="stat-label">Total Registros</div>
</div>
<div class="stat-item">
<div class="stat-value" id="headerOpen" style="color:var(--color-amarelo)">0</div>
<div class="stat-label">Em Aberto</div>
</div>
<div class="stat-item">
<div class="stat-value" id="headerClosed" style="color:var(--color-aqua)">0</div>
<div class="stat-label">Concluídos</div>
</div>
</div>
<div class="header-actions">
<a href="https://thiccoipp.github.io/backendipp/DEMANDAS%20INTERNAS.html" class="btn" style="background-color: #FF6600; color: white; font-weight: 600; padding: 8px 16px; border-radius: var(--radius-sm); text-decoration: none; display: inline-flex; align-items: center; gap: 8px;" title="Requisições Internas" aria-label="Ir para Requisições Internas">
<i class="fa-solid fa-clipboard-list"></i> Requisições Internas
</a>
<div style="width: 1px; height: 28px; background: rgba(255,255,255,0.3); margin: 0 8px;"></div>
<button onclick="toggleFullScreen()" class="btn btn-purple btn-icon" title="Tela Cheia" aria-label="Expandir para tela cheia">
<i class="fa-solid fa-expand"></i>
</button>
<button onclick="exportCSV()" class="btn btn-secondary btn-icon" title="Exportar CSV" aria-label="Exportar dados em formato CSV">
<i class="fa-solid fa-file-export"></i>
</button>
<button onclick="toggleTheme()" class="btn btn-ghost btn-icon" title="Alternar Tema" aria-label="Alternar entre tema claro e escuro">
<i class="fa-solid fa-moon"></i>
</button>
<button onclick="initLoadFromGitHub()" class="btn btn-primary btn-icon" title="Recarregar Dados" aria-label="Recarregar dados da base">
<i class="fa-solid fa-rotate"></i>
</button>
</div>
</div>
</header>

<div class="layout">
<aside class="sidebar" aria-label="Filtros e ranking de analistas">
<div class="sb-icons">
<i class="fa-solid fa-database sb-icon" aria-hidden="true"></i>
<i class="fa-solid fa-filter sb-icon" aria-hidden="true"></i>
<i class="fa-solid fa-trophy sb-icon" aria-hidden="true"></i>
<i class="fa-solid fa-chart-line sb-icon" aria-hidden="true"></i>
</div>
<div class="sb-content">
<div class="mb-md">
<div class="section-title">Fonte de Dados</div>
<div id="connectionStatus" style="border:1px solid rgba(61, 141, 255, 0.3); background: rgba(61, 141, 255, 0.1); border-radius:var(--radius-sm); padding:18px; text-align:center; box-shadow: var(--shadow-sm); backdrop-filter: blur(10px);">
<div style="font-size:13px; font-weight:700; color:var(--brand-blue); margin-bottom:8px; display:flex; align-items:center; justify-content:center; gap:8px;">
<i class="fa-solid fa-database"></i> Conexão Ativa
</div>
<div style="font-size:11px; color:var(--brand-blue); margin-bottom:12px; font-weight:500;">
Base Remota Carregada
</div>
<button id="refreshBtn" class="btn btn-secondary" style="width:100%; justify-content:center; padding:10px; font-size:12px;">
<i class="fa-solid fa-sync"></i> Recarregar Dados
</button>
</div>
</div>
<div class="mb-md">
<div class="section-title">Filtros principais</div>
<input id="qSearch" class="form-control" placeholder="🔍 Buscar (CNPJ, Razão Social, Analista)..." aria-label="Busca rápida">
<div style="font-size:12px; color:var(--text-secondary); margin-bottom:6px; font-weight:500;">Período de análise</div>
<div class="select-wrapper">
<select id="datePreset" class="form-control" style="margin-bottom:8px;" aria-label="Filtro de período predefinido">
<option value="">Período Personalizado</option>
<option value="last7">Últimos 7 dias</option>
<option value="last30">Últimos 30 dias</option>
<option value="currentMonth">Mês Atual</option>
<option value="lastMonth">Mês Passado</option>
<option value="currentYear">Ano Atual</option>
<option value="fullRange">Período Completo (Base)</option>
</select>
</div>
<div class="flex gap-xs mb-sm">
<input id="dateStart" type="date" class="form-control" style="margin:0; flex:1" aria-label="Data inicial">
<input id="dateEnd" type="date" class="form-control" style="margin:0; flex:1" aria-label="Data final">
</div>
<div class="select-wrapper">
<select id="motivoSelect" class="form-control" aria-label="Filtro de motivo">
<option value="">Todos Motivos</option>
</select>
</div>
<div class="select-wrapper">
<select id="analistaSelect" class="form-control" aria-label="Filtro de analista">
<option value="">Todos Analistas</option>
</select>
</div>
</div>
<div class="mb-md">
<div class="section-title">Filtros avançados</div>
<div class="select-wrapper">
<select id="subSelect" class="form-control" aria-label="Filtro de subclassificação">
<option value="">Todas Subclasses</option>
</select>
</div>
<div class="select-wrapper">
<select id="tipoContatoSelect" class="form-control" aria-label="Filtro de tipo de contato">
<option value="">Todos Tipos</option>
<option value="Ativo">Ativo</option>
<option value="Receptivo">Receptivo</option>
</select>
</div>
<div class="flex gap-sm mt-sm">
<button id="applyBtn" class="btn btn-primary" type="button" style="flex:1">
<i class="fa-solid fa-rotate-right"></i> Aplicar Filtros
</button>
<button id="clearBtn" class="btn btn-ghost" type="button" style="flex:1">
<i class="fa-solid fa-eraser"></i> Limpar Tudo
</button>
</div>
</div>
<div>
<div class="section-title">Ranking Analistas</div>
<div id="gamificationBoard">
<div style="font-size:13px; color:var(--text-muted); text-align:center; padding:15px;">Carregando ranking...</div>
</div>
</div>
</div>
</aside>

<main class="main" id="main-content" role="main">
<div class="context-bar fade-in">
<div class="context-text" id="contextSummary">Iniciando download da base de dados...</div>
<div class="context-actions">
<div class="context-hint">
<i class="fa-solid fa-lightbulb"></i>
<span>Clique em gráficos, células ou KPIs para filtrar/desfiltrar</span>
</div>
<button class="btn btn-automation" onclick="showAutomationModal()" aria-label="Dashboard de Análise por Motivo">
<i class="fa-solid fa-chart-network"></i> Dashboard por Motivo
</button>

<button onclick="generateExecutiveReport()" class="btn btn-purple" aria-label="Gerar relatório executivo">
<i class="fa-solid fa-file-pdf"></i> Relatório Executivo
</button>
</div>
</div>

<div id="activeFilters" aria-label="Filtros ativos"></div>

<div class="kpi-sticky-container">
<div class="kpi-grid">
<div class="kpi-card slide-in-left" id="kpiTotal" data-filter="Total" style="animation-delay: 0.1s">
<div class="kpi-content">
<div class="kpi-val" id="kTotal">0</div>
<div class="kpi-lbl">Total de registros</div>
<div class="demanda-interna-indicator" style="font-size: 0.75em; color: #64748b; margin-top: 4px; display: flex; align-items: center; gap: 4px;">
<i class="fa-solid fa-inbox" style="font-size: 0.9em;"></i>
<span id="demandaInternaCount">0</span> demandas internas
</div>
<div class="kpi-helper" id="kTotalHelper">Clique para limpar todos os filtros</div>
</div>
<div class="kpi-icon"><i class="fa-solid fa-layer-group"></i></div>
</div>
<div class="kpi-card slide-in-left" id="kpiOpen" data-filter="Aberto" style="animation-delay: 0.2s">
<div class="kpi-content">
<div class="kpi-val" id="kOpen" style="color:var(--color-amarelo)">0</div>
<div class="kpi-lbl">Em aberto</div>
<div class="kpi-trend neutral" id="kOpenTrend"><span>0%</span></div>
<div class="kpi-helper" id="kOpenHelper">Clique para filtrar/desfiltrar por status "Em Aberto"</div>
</div>
<div class="kpi-icon"><i class="fa-regular fa-clock"></i></div>
</div>
<div class="kpi-card slide-in-left" id="kpiClosed" data-filter="Fechado" style="animation-delay: 0.3s">
<div class="kpi-content">
<div class="kpi-val" id="kClosed" style="color:var(--color-aqua)">0</div>
<div class="kpi-lbl">Concluídos</div>
<div class="kpi-trend neutral" id="kClosedTrend"><span>0%</span></div>
<div class="kpi-helper" id="kClosedHelper">Clique para filtrar/desfiltrar por status "Concluído"</div>
</div>
<div class="kpi-icon"><i class="fa-solid fa-check-circle"></i></div>
</div>
<div class="kpi-card slide-in-left" id="kpiFCR" data-filter="FCR" style="animation-delay: 0.4s">
<div class="kpi-content">
<div class="kpi-val" id="kFCR">0%</div>
<div class="kpi-lbl">FCR (Resolução 1ª)</div>
<div class="kpi-trend neutral" id="kFCRTrend"><i class="fa-solid fa-minus"></i> <span>Meta: 80%</span></div>
<div class="kpi-helper" id="kFCRHelper">Clique para filtrar/desfiltrar por FCR = Sim</div>
</div>
<div class="kpi-icon"><i class="fa-solid fa-bullseye"></i></div>
</div>
<div class="kpi-card slide-in-left avg-time-card" id="kpiAvgTime" data-filter="AvgTime" style="animation-delay: 0.5s">
<div class="kpi-content">
<div class="kpi-val" id="kAvgTime">0d</div>
<div class="kpi-lbl">Tempo Médio Resolução</div>
<div class="kpi-trend neutral" id="kAvgTimeTrend"><i class="fa-solid fa-minus"></i> <span>Meta: 1.0d</span></div>
<div class="kpi-helper" id="kAvgTimeHelper">Baseado apenas nos casos concluídos</div>
</div>
<div class="kpi-icon"><i class="fa-solid fa-hourglass-half"></i></div>
</div>

<!-- NOVO CARD: CNPJ ÚNICOS NO PERÍODO -->
<div class="kpi-card slide-in-left" id="kpiCnpjCount" style="animation-delay: 0.6s">
<div class="kpi-content">
<div class="kpi-val" id="kCnpjCount">0</div>
<div class="kpi-lbl">CNPJ Únicos</div>
<div class="kpi-trend neutral" id="kCnpjTrend"><i class="fa-solid fa-chart-simple"></i> <span>--</span></div>
<div class="kpi-helper">Quantidade de CNPJ distintos no período</div>
</div>
<div class="kpi-icon"><i class="fa-solid fa-building"></i></div>
</div>

<!-- NOVO CARD: MOTIVO MAIS TRATADO -->
<div class="kpi-card slide-in-left" id="kpiTopMotivo" style="animation-delay: 0.7s">
<div class="kpi-content">
<div class="kpi-val" id="kTopMotivo" title="">-</div>
<div class="kpi-lbl">Motivo Mais Tratado <i class="fa-solid fa-circle-info motivo-info-icon" onclick="showMotivoDetailsPopup(event)"></i></div>
<div class="kpi-trend neutral" id="kMotivoTrend"><i class="fa-solid fa-percent"></i> <span>--</span></div>
<div class="kpi-helper">Tema com maior volume</div>
</div>
<div class="kpi-icon"><i class="fa-solid fa-chart-bar"></i></div>
</div>

</div>
</div>

<div class="charts-grid">
<!-- Linha 1: Tipo de Atendimento e Canais de Contato -->
<div class="card fade-in" style="animation-delay: 0.3s">
<div class="card-header-row">
<div>
<h3 class="card-title"><i class="fa-solid fa-headset" style="color:var(--brand-blue)"></i> Tipo de Atendimento</h3>
<div class="card-subtitle">Distribuição entre contatos Ativos e Receptivos</div>
</div>
</div>
<div class="bar-chart-mini-container">
<canvas id="chartTipoAtendimento" role="img" aria-label="Gráfico de barras para tipo de atendimento"></canvas>
</div>
<div style="display:flex; justify-content:center; gap:20px; margin-top:15px;">
<div style="display:flex; align-items:center; gap:6px; font-size:11px;">
<div style="width:12px; height:12px; background:var(--brand-blue); border-radius:2px;"></div>
<span style="color:var(--text-secondary)">Ativo</span>
</div>
<div style="display:flex; align-items:center; gap:6px; font-size:11px;">
<div style="width:12px; height:12px; background:var(--color-amarelo); border-radius:2px;"></div>
<span style="color:var(--text-secondary)">Receptivo</span>
</div>
</div>
<div style="text-align:center; font-size:11px; color:var(--text-muted); margin-top:10px; font-weight:500;">
<i class="fa-solid fa-mouse-pointer"></i> Clique nas barras para filtrar/desfiltrar por tipo
</div>
</div>

<div class="card fade-in" style="animation-delay: 0.45s">
<div class="card-header-row">
<div>
<h3 class="card-title"><i class="fa-solid fa-comments" style="color:var(--success-green)"></i> Canais de Contato</h3>
<div class="card-subtitle">Distribuição dos canais de comunicação</div>
</div>
<button onclick="downloadChart('chartOrigemContato', 'origem-contato.png')" class="btn btn-ghost" style="padding:6px 12px; font-size:11px;">
<i class="fa-solid fa-download"></i> Exportar
</button>
</div>
<div style="display:flex; height:300px; align-items:center;">
<div style="flex:1; position:relative;">
<canvas id="chartOrigemContato" role="img" aria-label="Gráfico de rosca com origem do contato"></canvas>
<div class="doughnut-center-info" id="chartOrigemContatoCenter">
<div class="doughnut-center-name">Total</div>
<div class="doughnut-center-value">0</div>
</div>
</div>
<div id="legendOrigemContato" class="legend-container"></div>
</div>
<div style="text-align:center; font-size:11px; color:var(--text-muted); margin-top:10px; font-weight:500;">
<i class="fa-solid fa-mouse-pointer"></i> Clique em uma fatia para filtrar/desfiltrar por origem
</div>
</div>

<!-- Linha 2: Subclassificação e GN -->
<div class="card fade-in" style="animation-delay: 0.5s">
<div class="card-header-row">
<div>
<h3 class="card-title"><i class="fa-solid fa-sitemap" style="color:var(--brand-blue)"></i> Subclassificação</h3>
<div class="card-subtitle">Distribuição dos atendimentos por subclasse</div>
</div>
</div>
<div style="display:flex; height:300px; align-items:center;">
<div style="flex:1; position:relative;">
<canvas id="chartSubclassificacao" role="img" aria-label="Gráfico de rosca por subclassificação"></canvas>
<div class="doughnut-center-info" id="chartSubclassificacaoCenter"></div>
</div>
<div id="legendSubclassificacao" class="legend-container"></div>
</div>
</div>

<div class="card fade-in" style="animation-delay: 0.55s">
<div class="card-header-row">
<div>
<h3 class="card-title"><i class="fa-solid fa-map" style="color:var(--brand-orange)"></i> Atendimentos por GN</h3>
<div class="card-subtitle">Distribuição por Gerência Nacional</div>
</div>
</div>
<div style="display:flex; height:300px; align-items:center;">
<div style="flex:1; position:relative;">
<canvas id="chartGN" role="img" aria-label="Gráfico de rosca por GN"></canvas>
<div class="doughnut-center-info" id="chartGNCenter"></div>
</div>
<div id="legendGN" class="legend-container"></div>
</div>
</div>

<!-- Linha 3: Distribuição por Motivo (ocupa duas colunas) -->
<div class="card fade-in" style="animation-delay: 0.6s; grid-column: span 2;">
<div class="card-header-row">
<div>
<h3 class="card-title"><i class="fa-solid fa-folder-open" style="color:var(--brand-orange)"></i> Distribuição por Motivo</h3>
<div class="card-subtitle">Temas mais recorrentes (Ordenado)</div>
</div>
<button onclick="downloadChart('chartMot', 'distribuicao-motivo.png')" class="btn btn-ghost" style="padding:6px 12px; font-size:11px;">
<i class="fa-solid fa-download"></i> Exportar
</button>
</div>
<div class="chart-scroll-container">
<canvas id="chartMot" role="img" aria-label="Gráfico de barra horizontal por motivo"></canvas>
</div>
<div style="text-align:center; font-size:11px; color:var(--text-muted); margin-top:10px; font-weight:500;">
<i class="fa-solid fa-mouse-pointer"></i> Clique em qualquer barra para filtrar/desfiltrar por motivo
</div>
</div>

<!-- Linha 4: Evolução Diária e Performance por Analista -->
<div class="card fade-in" style="animation-delay: 0.7s">
<div class="card-header-row">
<div>
<h3 class="card-title"><i class="fa-solid fa-chart-line" style="color:var(--brand-blue)"></i> Evolução Diária</h3>
<div class="card-subtitle">Volume de atividades por dia (Total vs Concluído)</div>
</div>
<div style="display:flex; gap:8px; align-items:center;">
<div style="display:flex; align-items:center; gap:5px; font-size:11px;">
<div style="width:10px; height:10px; background:var(--brand-blue); border-radius:2px;"></div>
<span style="color:var(--text-secondary)">Total</span>
</div>
<div style="display:flex; align-items:center; gap:5px; font-size:11px;">
<div style="width:10px; height:10px; background:var(--success-green); border-radius:2px; border:1px dashed var(--success-green);"></div>
<span style="color:var(--text-secondary)">Concluído</span>
</div>
</div>
</div>
<div class="chart-container">
<canvas id="chartEvo" role="img" aria-label="Gráfico de linha com evolução diária de atendimentos"></canvas>
</div>
<div style="text-align:center; font-size:11px; color:var(--text-muted); margin-top:10px; font-weight:500;">
<i class="fa-solid fa-mouse-pointer"></i> Clique em qualquer ponto para filtrar/desfiltrar por data específica
</div>
</div>

<div class="card fade-in" style="animation-delay: 0.2s">
<div class="card-header-row">
<div>
<h3 class="card-title"><i class="fa-solid fa-trophy" style="color:var(--brand-yellow)"></i> Performance por Analista</h3>
<div class="card-subtitle">Volume total de atividades por responsável</div>
</div>
</div>
<div class="chart-container">
<canvas id="chartAnal" role="img" aria-label="Gráfico de barras com atendimentos por analista"></canvas>
</div>
<div style="text-align:center; font-size:11px; color:var(--text-muted); margin-top:10px; font-weight:500;">
<i class="fa-solid fa-mouse-pointer"></i> Clique em um analista para filtrar/desfiltrar
</div>
</div>
</div>

<div class="card fade-in" style="margin-top:20px; animation-delay: 0.8s">
<div class="card-header-row">
<div>
<h3 class="card-title" style="margin-bottom:5px;"><i class="fa-solid fa-table" style="color:var(--brand-blue)"></i> Detalhamento das Atividades</h3>
<div class="card-subtitle">Clique em uma linha para filtrar/desfiltrar por caso específico • Clique no cabeçalho para ordenar</div>
</div>
<div style="display:flex; align-items:center; gap:12px;">
<div class="pagination">
<div class="pagination-info" id="paginationInfo">0-0</div>
<button id="prevPage" class="pagination-btn" type="button" aria-label="Página anterior">◀</button>
<button id="nextPage" class="pagination-btn" type="button" aria-label="Próxima página">▶</button>
</div>
<button onclick="exportCSV()" class="btn btn-secondary" type="button">
<i class="fa-solid fa-download"></i> Exportar CSV
</button>
</div>
</div>
<div class="table-container" aria-label="Tabela detalhada das atividades">
<table class="table" id="dataTable">
<thead>
<tr>
<th data-key="status">Status <span class="sort-indicator"></span></th>
<th data-key="dtStart">Data Início <span class="sort-indicator"></span></th>
<th data-key="dtEnd">Data Fim <span class="sort-indicator"></span></th>
<th data-key="tempoResolucaoDias">Tempo Resolução <span class="sort-indicator"></span></th>
<th data-key="fcr">FCR <span class="sort-indicator"></span></th>
<th data-key="analista">Analista <span class="sort-indicator"></span></th>
<th data-key="motivo">Motivo <span class="sort-indicator"></span></th>
<th data-key="sub">Sub Classificação <span class="sort-indicator"></span></th>
<th data-key="solicitante">Razão Social <span class="sort-indicator"></span></th>
<th data-key="tipoContato">Tipo Atendimento <span class="sort-indicator"></span></th>
<th data-key="origemContato">Origem Contato <span class="sort-indicator"></span></th>
</tr>
</thead>
<tbody>
<tr>
<td colspan="11" style="text-align:center; padding:30px; color:var(--text-muted); font-weight:500;">
<i class="fa-solid fa-spinner fa-spin" style="margin-right:10px;"></i>
Aguardando dados...
</td>
</tr>
</tbody>
</table>
</div>
<div style="text-align:center; margin-top:15px;">
    <div onclick="showDevelopmentPopup()" style="cursor:pointer; font-size:12px; color:var(--text-secondary); display:inline-flex; align-items:center; gap:8px; padding:8px 16px; background:rgba(61,141,255,0.1); border-radius:8px; border:1px solid rgba(61,141,255,0.2); transition: all 0.3s ease;" onmouseover="this.style.background='rgba(61,141,255,0.2)'" onmouseout="this.style.background='rgba(61,141,255,0.1)'">
        <i class="fa-solid fa-info-circle" style="color:var(--brand-blue)"></i>
        <span>Use <kbd style="background:var(--gradient-primary); color:white; padding:2px 8px; border-radius:4px; font-weight:600;">F</kbd> para focar na busca rápida (Clique para ajuda)</span>
    </div>
</div>
</div>

<div style="text-align:center; margin-top:30px; padding:20px; font-size:12px; color:var(--text-muted); border-top:1px solid var(--border-light);">
<div style="display:flex; justify-content:center; align-items:center; gap:20px; flex-wrap:wrap;">
<div>Dashboard desenvolvido por <strong>Thiago Jr</strong></div>
<div>•</div>
<div>Última atualização: <span id="lastUpdateTime">--:--</span></div>
</div>
</div>
</main>
</div>

<!-- Popup de Notificações -->
<div class="notification-popup" id="notificationPopup" role="dialog" aria-label="Notificações" aria-hidden="true">
<div class="notification-header">
<div class="notification-title">
<i class="fa-solid fa-bell"></i>
Notificações
</div>
<div class="notification-subtitle">Mantenha-se atualizado com as atividades</div>
<button class="notification-close" onclick="toggleNotifications()" aria-label="Fechar notificações">
<i class="fa-solid fa-times"></i>
</button>
</div>
<div class="notification-content">
<div class="notification-item fade-in">
<div class="notification-item-title">
<span>Total de Registros Atualizado</span>
<span class="notification-item-date">De: 2025-11-11</span>
</div>
<div class="notification-item-content">
TOTAL DE REGISTROS atualizado com base nos dados mais recentes da planilha.
</div>
<div class="notification-item-stats">
<div>
<div class="stat-number">132</div>
<div class="stat-label">Total Registros</div>
</div>
<div>
<div class="stat-number">7</div>
<div class="stat-label">Em Aberto</div>
</div>
<div>
<div class="stat-number">125</div>
<div class="stat-label">Concluídos</div>
</div>
</div>
<div style="margin-top: 15px; font-size: 11px; color: var(--text-muted);">
<i class="fa-solid fa-info-circle"></i> Clique para limpar todos os filtros
</div>
</div>
<div class="notification-item fade-in" style="animation-delay: 0.1s">
<div class="notification-item-title">
<span>Tempo Médio de Resolução</span>
<span class="notification-item-date">Hoje</span>
</div>
<div class="notification-item-content">
TEMPO MÉDIO RESOLUÇÃO calculado com base apenas nos casos concluídos.
</div>
<div class="notification-item-stats">
<div style="flex: 1;">
<div class="stat-number" style="color: var(--purple)">0.8d</div>
<div class="stat-label">Tempo Médio</div>
</div>
</div>
</div>
<div class="notification-empty fade-in" style="animation-delay: 0.2s">
<i class="fa-regular fa-bell-slash"></i>
<h3>Nenhuma notificação no momento</h3>
<p>Novas notificações aparecerão aqui automaticamente</p>
</div>
</div>
<div class="notification-footer">
<button class="btn btn-ghost" style="flex: 1;" onclick="clearAllNotifications()" aria-label="Limpar todas as notificações">
<i class="fa-solid fa-trash"></i> Limpar Todas
</button>
<button class="btn btn-purple" style="flex: 1;" onclick="markAllAsRead()" aria-label="Marcar todas as notificações como lidas">
<i class="fa-solid fa-check-double"></i> Marcar como Lidas
</button>
</div>
</div>

<!-- Popup de Desenvolvimento -->
<div class="development-popup" id="developmentPopup" role="dialog" aria-label="Funcionalidade em desenvolvimento" aria-hidden="true">
<div class="development-header">
<div class="development-icon">
<i class="fa-solid fa-code"></i>
</div>
<div class="development-title">Em Desenvolvimento</div>
<div class="development-subtitle">Funcionalidade em construção</div>
</div>
<div class="development-content">
<div class="development-text">
Esta funcionalidade está em fase de desenvolvimento ativo.
Em breve você poderá aproveitar todos os recursos planejados.
</div>
<button class="btn btn-primary development-close" onclick="hideDevelopmentPopup()" aria-label="Entendi, fechar diálogo">
<i class="fa-solid fa-check"></i> Entendi
</button>
</div>
</div>

<!-- NOVO POPUP DE AUTOMAÇÃO - DASHBOARD POR MOTIVO -->
<div class="automation-popup" id="automationPopup" role="dialog" aria-label="Dashboard de Análise por Motivo" aria-hidden="true">
    <div class="automation-header">
        <div class="automation-icon">
            <i class="fa-solid fa-chart-network"></i>
        </div>
        <div class="automation-title">Dashboard de Análise por Motivo</div>
        <div class="automation-subtitle">Análise detalhada por categoria de motivo com métricas específicas</div>
        <button class="automation-close" onclick="hideAutomationModal()" aria-label="Fechar diálogo">
            <i class="fa-solid fa-times"></i>
        </button>
    </div>
    
    <div class="automation-content">
        <!-- Tabs de Navegação -->
        <div class="tabs-container">
            <button class="tab-btn active" onclick="switchAutomationTab('distribuicao')" data-tab="distribuicao">
                <i class="fa-solid fa-table"></i> Distribuição por Motivo
            </button>
            <button class="tab-btn" onclick="switchAutomationTab('analistas')" data-tab="analistas">
                <i class="fa-solid fa-users"></i> Performance por Analista
            </button>
            <button class="tab-btn" onclick="switchAutomationTab('tempo')" data-tab="tempo">
                <i class="fa-solid fa-clock"></i> Métricas de Tempo (TMR)
            </button>
            <button class="tab-btn" onclick="switchAutomationTab('evolucao')" data-tab="evolucao">
                <i class="fa-solid fa-chart-line"></i> Evolução Temporal
            </button>
        </div>
        
        <!-- Conteúdo das Tabs -->
        <div class="tabs-content">
            
            <!-- Tab 1: Distribuição por Motivo -->
            <div id="tab-distribuicao" class="tab-pane active">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3 style="margin: 0; color: var(--text-primary);">
                        <i class="fa-solid fa-list-check" style="color: var(--brand-blue);"></i>
                        Distribuição Detalhada por Motivo
                    </h3>
                    <div style="display: flex; gap: 10px;">
                        <input type="text" id="motivoSearch" placeholder="🔍 Filtrar motivo..." 
                               class="form-control" style="width: 250px; margin: 0;">
                        <button onclick="exportMotivoCSV()" class="btn btn-secondary">
                            <i class="fa-solid fa-download"></i> Exportar
                        </button>
                    </div>
                </div>
                
                <div class="table-container" style="max-height: 500px;">
                    <table class="table" id="motivoTable">
                        <thead>
                            <tr>
                                <th data-key="motivo" onclick="sortMotivoTable('motivo')">Motivo <span class="sort-indicator"></span></th>
                                <th data-key="total" onclick="sortMotivoTable('total')">Total <span class="sort-indicator"></span></th>
                                <th data-key="abertos" onclick="sortMotivoTable('abertos')">Em Aberto <span class="sort-indicator"></span></th>
                                <th data-key="fechados" onclick="sortMotivoTable('fechados')">Concluídos <span class="sort-indicator"></span></th>
                                <th data-key="fcr" onclick="sortMotivoTable('fcr')">FCR <span class="sort-indicator"></span></th>
                                <th data-key="tmr" onclick="sortMotivoTable('tmr')">TMR (dias) <span class="sort-indicator"></span></th>
                                <th data-key="analistas" onclick="sortMotivoTable('analistas')">Analistas <span class="sort-indicator"></span></th>
                                <th data-key="tipos" onclick="sortMotivoTable('tipos')">Tipos Contato <span class="sort-indicator"></span></th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody id="motivoTableBody">
                            <tr>
                                <td colspan="9" style="text-align:center; padding:30px; color:var(--text-muted);">
                                    <i class="fa-solid fa-spinner fa-spin" style="margin-right:10px;"></i>
                                    Carregando dados...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <div class="motivo-stats-grid">
                    <div class="stat-card">
                        <h4><i class="fa-solid fa-chart-pie"></i> Resumo Estatístico</h4>
                        <div id="motivoStats" style="font-size: 13px; line-height: 1.6;">
                            Carregando estatísticas...
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <h4><i class="fa-solid fa-ranking-star" style="color:var(--brand-orange);"></i> Top 5 Motivos</h4>
                        <div id="topMotivos" style="font-size: 13px;">
                            Carregando...
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Tab 2: Performance por Analista -->
            <div id="tab-analistas" class="tab-pane">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3 style="margin: 0; color: var(--text-primary);">
                        <i class="fa-solid fa-user-tie" style="color: var(--success-green);"></i>
                        Performance dos Analistas por Motivo
                    </h3>
                    <select id="analistaFilterMotivo" class="form-control" style="width: 200px; margin: 0;" onchange="loadAnalistaMotivoData()">
                        <option value="">Todos os Motivos</option>
                    </select>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                    <div class="chart-container" style="height: 300px;">
                        <canvas id="chartAnalistaVolume"></canvas>
                    </div>
                    <div class="chart-container" style="height: 300px;">
                        <canvas id="chartAnalistaFCR"></canvas>
                    </div>
                </div>
                
                <div class="table-container" style="max-height: 400px;">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Analista</th>
                                <th>Motivos Únicos</th>
                                <th>Total</th>
                                <th>Aberto</th>
                                <th>Concluído</th>
                                <th>FCR</th>
                                <th>TMR Médio (dias)</th>
                                <th>Origem Principal</th>
                            </tr>
                        </thead>
                        <tbody id="analistaMotivoTable">
                            <tr>
                                <td colspan="8" style="text-align:center; padding:20px; color:var(--text-muted);">
                                    Selecione um motivo para visualizar os dados
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Tab 3: Métricas de Tempo -->
            <div id="tab-tempo" class="tab-pane">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3 style="margin: 0; color: var(--text-primary);">
                        <i class="fa-solid fa-hourglass-half" style="color: var(--purple);"></i>
                        Análise de Tempo Médio de Resolução (TMR) por Motivo
                    </h3>
                </div>
                
                <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 20px;">
                    <div class="chart-container" style="height: 350px;">
                        <canvas id="chartTMRMotivo"></canvas>
                    </div>
                    
                    <div style="display: flex; flex-direction: column; gap: 15px;">
                        <div class="stat-card">
                            <h4 style="color: var(--brand-blue);">TMR Geral</h4>
                            <div style="font-size: 28px; font-weight: 900; color: var(--brand-blue);" id="tmrGeral">0d</div>
                            <div style="font-size: 12px; color: var(--text-muted);">Média de todos os motivos concluídos</div>
                        </div>
                        
                        <div class="stat-card">
                            <h4 style="color: var(--brand-orange);">Motivo mais Rápido</h4>
                            <div id="motivoMaisRapido" style="font-size: 14px; font-weight: 600;">-</div>
                            <div id="tempoMaisRapido" style="font-size: 12px; color: var(--text-muted);">-</div>
                        </div>
                        
                        <div class="stat-card">
                            <h4 style="color: var(--error-red);">Motivo mais Lento</h4>
                            <div id="motivoMaisLento" style="font-size: 14px; font-weight: 600;">-</div>
                            <div id="tempoMaisLento" style="font-size: 12px; color: var(--text-muted);">-</div>
                        </div>
                    </div>
                </div>
                
                <div style="margin-top: 20px;">
                    <h4 style="margin-bottom: 15px; color: var(--text-primary);">
                        <i class="fa-solid fa-table"></i> Detalhamento por Motivo
                    </h4>
                    <div class="table-container" style="max-height: 300px;">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Motivo</th>
                                    <th>Total Concluídos</th>
                                    <th>TMR (dias)</th>
                                    <th>Desvio Padrão</th>
                                    <th>Casos > 7 dias</th>
                                </tr>
                            </thead>
                            <tbody id="tmrDetailTable">
                                <tr>
                                    <td colspan="6" style="text-align:center; padding:20px; color:var(--text-muted);">
                                        Carregando dados de tempo...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Tab 4: Evolução Temporal -->
            <div id="tab-evolucao" class="tab-pane">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3 style="margin: 0; color: var(--text-primary);">
                        <i class="fa-solid fa-chart-line" style="color: var(--success-green);"></i>
                        Evolução Temporal por Motivo
                    </h3>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <select id="motivoEvolucaoSelect" class="form-control" style="width: 250px; margin: 0;" onchange="updateEvolucaoChart()">
                            <option value="">Selecione um motivo</option>
                        </select>
                        <select id="periodoEvolucao" class="form-control" style="width: 150px; margin: 0;" onchange="updateEvolucaoChart()">
                            <option value="7">Últimos 7 dias</option>
                            <option value="30" selected>Últimos 30 dias</option>
                            <option value="90">Últimos 90 dias</option>
                            <option value="all">Todo o período</option>
                        </select>
                    </div>
                </div>
                
                <div class="chart-container" style="height: 400px; margin-bottom: 20px;">
                    <canvas id="chartEvolucaoMotivo"></canvas>
                </div>
                
                <div class="motivo-stats-grid">
                    <div class="stat-card">
                        <h4 style="color: var(--brand-blue);">
                            <i class="fa-solid fa-calendar-day"></i> Tendência Diária
                        </h4>
                        <div id="tendenciaDiaria" style="font-size: 13px;">
                            Carregando análise de tendência...
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <h4 style="color: var(--brand-orange);">
                            <i class="fa-solid fa-chart-column"></i> Pico de Ocorrências
                        </h4>
                        <div id="picoOcorrencias" style="font-size: 13px;">
                            Carregando dados de pico...
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- NOVO POPUP DE DETALHES DO MOTIVO -->
<div class="motivo-details-popup" id="motivoDetailsPopup" role="dialog" aria-label="Detalhes do motivo mais tratado" aria-hidden="true">
    <div class="motivo-details-header">
        <div class="motivo-details-title">Detalhes de Tempo por Motivo</div>
        <div class="motivo-details-subtitle">Assunto mais rápido e mais demorado</div>
        <button class="motivo-details-close" onclick="hideMotivoDetailsPopup()" aria-label="Fechar diálogo">
            <i class="fa-solid fa-times"></i>
        </button>
    </div>
    <div class="motivo-details-content">
        <div class="motivo-details-row">
            <div class="motivo-details-label">Motivo Mais Tratado:</div>
            <div class="motivo-details-value" id="detailMotivoMaisTratado">-</div>
        </div>
        <div class="motivo-details-row">
            <div class="motivo-details-label">Quantidade:</div>
            <div class="motivo-details-value" id="detailQuantidade">-</div>
        </div>
        <div class="motivo-details-row">
            <div class="motivo-details-label">Assunto Mais Rápido:</div>
            <div class="motivo-details-value" id="detailMaisRapido">-</div>
        </div>
        <div class="motivo-details-row">
            <div class="motivo-details-label">Tempo Médio (Mais Rápido):</div>
            <div class="motivo-details-value" id="detailTempoMaisRapido">-</div>
        </div>
        <div class="motivo-details-row">
            <div class="motivo-details-label">Assunto Mais Demorado:</div>
            <div class="motivo-details-value" id="detailMaisDemorado">-</div>
        </div>
        <div class="motivo-details-row">
            <div class="motivo-details-label">Tempo Médio (Mais Demorado):</div>
            <div class="motivo-details-value" id="detailTempoMaisDemorado">-</div>
        </div>
        <div class="motivo-details-note">
            <i class="fa-solid fa-info-circle"></i> Nota: Os tempos são calculados com base na média de resolução por motivo (apenas casos concluídos) em dias.
        </div>
    </div>
</div>

<div id="loading">
<div class="loading-content">
<div class="loading-spinner"></div>
<div class="loading-text" id="loadingText">Conectando à base de dados...</div>
<div class="loading-subtext">Baixando e processando dados da planilha</div>
<div style="margin-top:20px; width:100%; height:6px; background:rgba(61, 141, 255, 0.1); border-radius:3px; overflow:hidden;">
<div id="loadingProgress" style="width:0%; height:100%; background:var(--gradient-primary); transition:width 0.3s;"></div>
</div>
</div>
</div>

<script>
/* ===== JAVASCRIPT PRINCIPAL ===== */
Chart.register(ChartDataLabels);

// === FUNÇÕES GLOBAIS DE HOVER PARA LEGENDAS DAS ROSCAS ===
window.highlightLegendItem = function(legendId, index) {
    const legendDiv = document.getElementById(legendId);
    if (!legendDiv) return;
    // Primeiro remove todos os highlights
    legendDiv.querySelectorAll('.legend-item').forEach(item => {
        item.classList.remove('legend-item-highlight');
    });
    // Adiciona highlight no item específico
    const items = legendDiv.querySelectorAll('.legend-item');
    if (items[index]) {
        items[index].classList.add('legend-item-highlight');
    }
};

window.unhighlightAllLegendItems = function(legendId) {
    const legendDiv = document.getElementById(legendId);
    if (!legendDiv) return;
    legendDiv.querySelectorAll('.legend-item').forEach(item => {
        item.classList.remove('legend-item-highlight');
    });
};

// Função para configurar hover em gráficos de rosca
window.setupDoughnutHover = function(chartInstance, legendId) {
    const canvas = chartInstance.canvas;

    canvas.addEventListener('mousemove', function(e) {
        const points = chartInstance.getElementsAtEventForMode(e, 'nearest', { intersect: true }, false);
        if (points.length > 0) {
            const idx = points[0].index;
            canvas.style.cursor = 'pointer';
            window.highlightLegendItem(legendId, idx);
        } else {
            canvas.style.cursor = 'default';
            window.unhighlightAllLegendItems(legendId);
        }
    });

    canvas.addEventListener('mouseleave', function() {
        canvas.style.cursor = 'default';
        window.unhighlightAllLegendItems(legendId);
    });
};




const DATA_URL = "https://raw.githubusercontent.com/thiccoipp/Ipp/main/base_hub_github.xlsx";


// Paleta de cores para gráficos de motivo (sem vermelho e roxo)
const MOTIVO_PALETTE = [
  '#0045B5', // Azul Ipiranga
  '#FFD100', // Amarelo Ipiranga
  '#0068FF', // Índigo
  '#00ADFF', // Céu
  '#00266E', // Marinho
  '#FFB206', // Canário
  '#00D9B8', // Aqua
  '#939598', // Asfalto
  '#00C9A7', // Verde sucesso
  '#FFA93D', // Laranja claro
  '#4CE4C9', // Verde claro
  '#3D8DFF', // Azul claro
  '#6CABFF', // Azul mais claro
  '#FFE4A1', // Amarelo claro
  '#FF9E76'  // Laranja suave
];

const GN_PALETTE = [
  '#0045B5', // Azul Ipiranga
  '#FFD100', // Amarelo Ipiranga
  '#0068FF', // Índigo
  '#00ADFF', // Céu
  '#00266E', // Marinho
  '#FFB206', // Canário
  '#00D9B8', // Aqua
  '#939598', // Asfalto
  '#9D4EDD', // Roxo
  '#FF7A45', // Laranja
  '#00C9A7', // Verde sucesso
  '#FF4757', // Vermelho erro
  '#FFA93D', // Laranja claro
  '#7B2CBF', // Roxo escuro
  '#4CE4C9'  // Verde claro
];

const BRAND_BLUE = '#3D8DFF';
const BRAND_BLUE_LIGHT = '#6CABFF';
const BRAND_YELLOW = '#FFD166';
const BRAND_ORANGE = '#FF7A45';
const BRAND_ORANGE_LIGHT = '#FF9E76';
const SUCCESS_GREEN = '#00C9A7';
const SUCCESS_GREEN_LIGHT = '#4CE4C9';
const PURPLE = '#9D4EDD';

// Cores Ipiranga para consistência
const IPIRANGA_BLUE = '#0045B5';
const IPIRANGA_YELLOW = '#FFD100';
const IPIRANGA_ORANGE = '#FF6900';

let RAW = [], FILTERED = [], CURRENT_PAGE = 1, ITEMS_PER_PAGE = 15;

// Função para normalizar motivo REDE para Adquirente Redecard
function normalizarMotivo(motivo) {
    if (!motivo) return motivo;
    const motivoStr = motivo.toString().trim();
    if (motivoStr.toUpperCase() === 'REDE') {
        return 'Adquirente Redecard';
    }
    return motivoStr;
}


let CHART_FILTERS = {
    'Table Row': null,
    'Evo Date': null,
    'Status': null,
    'FCR_Sim': null,
    'Date Preset': null,
    'Doughnut Selection': {},
    'Motivo': null,
    'Analista': null,
    'Subclassificação': null,
    'TipoContato': null,
    'AvgTime': null,
    'Origem': null,
    'GN': null,
    'CnpjCount': null,
    'TopMotivo': null
};

let CURRENT_SORT = { key: 'dtStart', direction: 'desc' };
let BASE_FILTERED_LENGTH = 0;
let LAST_UPDATE_TIME = null;
let charts = {};
let loadingProgressInterval = null;
let notificationCount = 3;
let firstLoad = true;

// ===== NOVAS VARIÁVEIS PARA ANÁLISE POR MOTIVO =====
let motivoAnalyticsData = null;
let currentMotivoSort = { key: 'total', direction: 'desc' };
let motivoCharts = {};

const $ = id => document.getElementById(id);

// ===== FUNÇÃO DE FORMATAÇÃO DE CNPJ =====
function formatCNPJ(cnpj) {
    const digits = cnpj.replace(/\D/g, '');
    if (digits.length !== 14) return cnpj;
    return digits.replace(
        /^(\d{2})(\d{3})(\d{3})(\d{4})(\d{2})$/,
        '$1.$2.$3/$4-$5'
    );
}

// ===== FUNÇÃO PARA CALCULAR CONTRASTE =====
function getContrastColor(hexColor) {
    let r, g, b;
    if (hexColor.startsWith('rgb')) {
        const rgb = hexColor.match(/\d+/g);
        r = parseInt(rgb[0]);
        g = parseInt(rgb[1]);
        b = parseInt(rgb[2]);
    } else {
        const hex = hexColor.replace('#', '');
        r = parseInt(hex.substr(0, 2), 16);
        g = parseInt(hex.substr(2, 2), 16);
        b = parseInt(hex.substr(4, 2), 16);
    }
    const luminance = (0.299 * r + 0.587 * g + 0.114 * b) / 255;
    return luminance > 0.5 ? '#000000' : '#FFFFFF';
}

// ===== FUNÇÃO PARA TRATAR GN =====
function tratarGN(gn) {
    if (!gn) return 'Não Informado';
    let gnTratada = gn.toString().trim();
    gnTratada = gnTratada.replace(/G\.N\.\s*Urbano\s*/i, "Urb ");
    gnTratada = gnTratada.replace(/G\.N\.\s*Rodovia\s*/i, "Rod. ");
    gnTratada = gnTratada.replace(/G\.N\.\s*/i, "");
    return gnTratada || gn;
}

// ===== FUNÇÕES PARA MOTIVO DETAILS POPUP =====
function showMotivoDetailsPopup(event) { 
    event.stopPropagation(); // Prevents the icon click from triggering the KPI filter 
    
    // Calculate average times per reason (only for closed cases) 
    const motivoTempos = {}; 
    FILTERED.forEach(item => { 
        if (item.statusNorm === 'Fechado' && item.tempoResolucaoHoras !== null) { 
            const motivo = item.motivo || 'Não informado'; 
            if (!motivoTempos[motivo]) { 
                motivoTempos[motivo] = { 
                    total: 0, 
                    count: 0, 
                    avg: 0 
                }; 
            } 
            motivoTempos[motivo].total += item.tempoResolucaoHoras; 
            motivoTempos[motivo].count++; 
        } 
    }); 
    
    // Calculate the averages in days
    Object.keys(motivoTempos).forEach(motivo => { 
        motivoTempos[motivo].avg = (motivoTempos[motivo].total / motivoTempos[motivo].count) / 24; // Convert hours to days
    }); 
    
    // Find the fastest and slowest 
    let maisRapido = { motivo: '-', tempo: Infinity }; 
    let maisDemorado = { motivo: '-', tempo: -Infinity }; 
    
    const motivosComTempo = Object.entries(motivoTempos); 
    if (motivosComTempo.length > 0) { 
        maisRapido = motivosComTempo.reduce((min, [motivo, data]) => { 
            return data.avg < min.tempo ? { motivo, tempo: data.avg } : min; 
        }, { motivo: '', tempo: Infinity }); 
        
        maisDemorado = motivosComTempo.reduce((max, [motivo, data]) => { 
            return data.avg > max.tempo ? { motivo, tempo: data.avg } : max; 
        }, { motivo: '', tempo: -Infinity }); 
    } 
    
    // Get the current most treated reason 
    const motivoCounts = {}; 
    FILTERED.forEach(item => { 
        const motivo = item.motivo || 'Não informado'; 
        motivoCounts[motivo] = (motivoCounts[motivo] || 0) + 1; 
    }); 
    
    let topMotivo = '-'; 
    let topMotivoCount = 0; 
    if (Object.keys(motivoCounts).length > 0) { 
        const entries = Object.entries(motivoCounts); 
        entries.forEach(([motivo, count]) => { 
            if (count > topMotivoCount) { 
                topMotivoCount = count; 
                topMotivo = motivo; 
            } 
        }); 
    } 
    
    // Populate the popup 
    $('detailMotivoMaisTratado').innerText = topMotivo; 
    $('detailQuantidade').innerText = topMotivoCount; 
    $('detailMaisRapido').innerText = maisRapido.motivo; 
    $('detailTempoMaisRapido').innerText = maisRapido.tempo !== Infinity ? maisRapido.tempo.toFixed(1) + ' dias' : '-'; 
    $('detailMaisDemorado').innerText = maisDemorado.motivo; 
    $('detailTempoMaisDemorado').innerText = maisDemorado.tempo !== -Infinity ? maisDemorado.tempo.toFixed(1) + ' dias' : '-'; 
    
    // Show the popup 
    const popup = $('motivoDetailsPopup'); 
    popup.classList.add('show'); 
} 

function hideMotivoDetailsPopup() { 
    $('motivoDetailsPopup').classList.remove('show'); 
}

// ===== INICIALIZAÇÃO =====
window.onload = function() {
    document.querySelectorAll('.btn').forEach(button => button.addEventListener('click', addRippleEffect));
    if (localStorage.getItem('dashboard-theme') === 'light') document.body.classList.add('light-theme');
    updateLastUpdateTime();
    initLoadFromGitHub();
    setupListeners();
};

function setupListeners() {
    $('refreshBtn').addEventListener('click', () => { showToast('Recarregando...', 'info'); initLoadFromGitHub(); });
    $('applyBtn').addEventListener('click', applyAllFilters);
    $('clearBtn').addEventListener('click', clearAllFilters);
    $('qSearch').addEventListener('input', () => { CURRENT_PAGE=1; applyAllFilters(); });
    $('motivoSelect').addEventListener('change', applyAllFilters);
    $('analistaSelect').addEventListener('change', applyAllFilters);
    $('subSelect').addEventListener('change', applyAllFilters);
    $('tipoContatoSelect').addEventListener('change', applyAllFilters);
    $('datePreset').addEventListener('change', handleDatePreset);
    $('dateStart').addEventListener('change', () => { $('datePreset').value=''; applyAllFilters(); });
    $('dateEnd').addEventListener('change', () => { $('datePreset').value=''; applyAllFilters(); });
    $('prevPage').addEventListener('click', () => changePage(-1));
    $('nextPage').addEventListener('click', () => changePage(1));
    $('kpiTotal').addEventListener('click', () => filterByKPI('Total'));
    $('kpiOpen').addEventListener('click', () => filterByKPI('Aberto'));
    $('kpiClosed').addEventListener('click', () => filterByKPI('Fechado'));
    $('kpiFCR').addEventListener('click', () => filterByKPI('FCR'));
    $('kpiAvgTime').addEventListener('click', () => filterByKPI('AvgTime'));
    $('kpiCnpjCount').addEventListener('click', () => filterByKPI('CnpjCount'));
    $('kpiTopMotivo').addEventListener('click', () => filterByKPI('TopMotivo'));
    
    document.addEventListener('click', function(e) {
        if (e.target.matches('#dataTable th[data-key]') || e.target.closest('#dataTable th[data-key]')) {
            const th = e.target.closest('#dataTable th[data-key]');
            const key = th.getAttribute('data-key');
            sortTable(key);
        }
    });
    
    document.addEventListener('keydown', (e) => {
        if (e.key === 'f' || e.key === 'F') {
            if (!e.ctrlKey && !e.metaKey) {
                e.preventDefault();
                $('qSearch').focus();
                $('qSearch').select();
                showToast('Campo de busca ativado. Digite para filtrar.', 'info');
            }
        }
        if (e.key === 'Escape') {
            hideDevelopmentPopup();
            hideAutomationModal();
            hideMotivoDetailsPopup();
            const notificationPopup = $('notificationPopup');
            if (notificationPopup.classList.contains('show')) {
                toggleNotifications();
            }
        }
    });
    
    document.addEventListener('click', (e) => {
        const notificationPopup = $('notificationPopup');
        const developmentPopup = $('developmentPopup');
        const automationPopup = $('automationPopup');
        const motivoDetailsPopup = $('motivoDetailsPopup');
        
        if (notificationPopup.classList.contains('show') &&
            !notificationPopup.contains(e.target) &&
            !e.target.closest('.btn-purple.btn-icon')) {
            toggleNotifications();
        }
        
        if (developmentPopup.classList.contains('show') &&
            !developmentPopup.contains(e.target) &&
            !e.target.closest('.btn-ghost.btn-icon')) {
            hideDevelopmentPopup();
        }
        
        if (automationPopup.classList.contains('show') &&
            !automationPopup.contains(e.target) &&
            !e.target.closest('.btn-automation')) {
            hideAutomationModal();
        }
        
        if (motivoDetailsPopup && motivoDetailsPopup.classList.contains('show') &&
            !motivoDetailsPopup.contains(e.target) &&
            !e.target.closest('.motivo-info-icon')) {
            hideMotivoDetailsPopup();
        }
    });
    
    // Event listener para busca na tabela de motivos
    const motivoSearch = $('motivoSearch');
    if (motivoSearch) {
        motivoSearch.addEventListener('input', () => {
            if (motivoAnalyticsData) {
                renderMotivoTable();
            }
        });
    }
    
    // Ajustar tamanho de fonte em zoom
    let lastZoom = 100;
    window.addEventListener('resize', function() {
        const zoom = Math.round((window.outerWidth / window.innerWidth) * 100);
        if (Math.abs(zoom - lastZoom) > 5) {
            lastZoom = zoom;
            adjustZoomStyles(zoom);
        }
    });
}

// ===== FUNÇÃO PARA AJUSTAR ESTILOS EM ZOOM =====
function adjustZoomStyles(zoomLevel) {
    const fontSize = Math.max(10, 12 * (zoomLevel / 100));
    document.documentElement.style.setProperty('--zoom-factor', zoomLevel / 100);
    
    // Ajustar legendas
    document.querySelectorAll('.legend-container').forEach(legend => {
        legend.style.fontSize = `${Math.max(0.7, 0.9 * (zoomLevel / 100))}em`;
    });
    
    // Ajustar KPIs
    document.querySelectorAll('.kpi-val').forEach(kpi => {
        kpi.style.fontSize = `clamp(16px, ${2.5 * (zoomLevel / 100)}vw, 28px)`;
    });
}

// ===== FUNÇÕES PRINCIPAIS EXISTENTES =====
function toggleNotifications() {
    const popup = $('notificationPopup');
    popup.classList.toggle('show');
    if (popup.classList.contains('show')) {
        updateNotificationBadge(0);
    }
}

function showDevelopmentPopup() {
    $('developmentPopup').classList.add('show');
}

function hideDevelopmentPopup() {
    $('developmentPopup').classList.remove('show');
}

function showAutomationModal() {
    const popup = $('automationPopup');
    popup.classList.add('show');
    
    loadMotivoAnalytics();
    
    setTimeout(() => {
        popup.focus();
    }, 100);
    document.addEventListener('keydown', handleAutomationKeydown);
}

function hideAutomationModal() {
    const popup = $('automationPopup');
    popup.classList.remove('show');
    document.removeEventListener('keydown', handleAutomationKeydown);
    const automationBtn = document.querySelector('.btn-automation');
    if (automationBtn) automationBtn.focus();
}

function handleAutomationKeydown(e) {
    if (e.key === 'Escape') {
        hideAutomationModal();
    }
}

function clearAllNotifications() {
    const notificationContent = $('notificationPopup').querySelector('.notification-content');
    const emptyState = notificationContent.querySelector('.notification-empty');
    const notificationItems = notificationContent.querySelectorAll('.notification-item');
    
    if (notificationItems.length > 0) {
        notificationItems.forEach(item => {
            item.style.opacity = '0';
            item.style.transform = 'translateX(-20px)';
            setTimeout(() => item.remove(), 300);
        });
        
        if (emptyState) {
            emptyState.style.display = 'block';
        }
        
        updateNotificationBadge(0);
        showToast('Todas as notificações foram limpas', 'success');
    }
}

function markAllAsRead() {
    const notificationItems = $('notificationPopup').querySelectorAll('.notification-item');
    
    notificationItems.forEach(item => {
        item.style.opacity = '0.7';
        item.style.borderLeftColor = 'var(--border-primary)';
        const title = item.querySelector('.notification-item-title');
        if (title) {
            title.style.color = 'var(--text-secondary)';
        }
    });
    
    updateNotificationBadge(0);
    showToast('Todas as notificações marcadas como lidas', 'success');
}

function updateNotificationBadge(count) {
    // Função desativada - notificações removidas
    return;
}

async function initLoadFromGitHub() {
    showLoading(true, "Conectando à base de dados...");
    resetLoadingProgress();
    
    try {
        const noCacheUrl = DATA_URL + "?t=" + new Date().getTime();
        startLoadingProgress();
        const response = await fetch(noCacheUrl);
        if (!response.ok) throw new Error(`Erro HTTP: ${response.status}`);
        const arrayBuffer = await response.arrayBuffer();
        completeLoadingProgress();
        processExcelData(arrayBuffer);
        addDataUpdateNotification();
    } catch (error) {
        console.error(error);
        completeLoadingProgress();
        showToast(`Falha ao carregar dados: ${error.message}`, 'error');
        setTimeout(() => {
            showLoading(false);
        }, 500);
        $('contextSummary').innerHTML = `<span style="color:var(--error-red)">Erro ao conectar: ${error.message}</span>`;
    }
}

function addDataUpdateNotification() {
    notificationCount++;
    updateNotificationBadge(notificationCount);
    showToast('Dados atualizados com sucesso!', 'success');
}

function startLoadingProgress() {
    clearInterval(loadingProgressInterval);
    let progress = 0;
    loadingProgressInterval = setInterval(() => {
        progress += Math.random() * 10 + 5;
        if (progress > 90) {
            progress = 90;
        }
        $('loadingProgress').style.width = progress + '%';
    }, 200);
}

function completeLoadingProgress() {
    clearInterval(loadingProgressInterval);
    $('loadingProgress').style.width = '100%';
}

function resetLoadingProgress() {
    clearInterval(loadingProgressInterval);
    $('loadingProgress').style.width = '0%';
}

function processExcelData(arrayBuffer) {
    try {
        const wb = XLSX.read(arrayBuffer, { type: 'array' });
        const sheetName = wb.SheetNames[0];
        const json = XLSX.utils.sheet_to_json(wb.Sheets[sheetName], { defval: "" });
        
        const excelDateToJS = (n) => {
            const date = new Date((n - 25568) * 86400 * 1000);
            return new Date(date.getFullYear(), date.getMonth(), date.getDate());
        };
        
        RAW = json.map((row, index) => {
            let dataInicioRaw = row["Data Inicio"];
            let dataInicioObj = null;
            if(typeof dataInicioRaw === 'number') dataInicioObj = excelDateToJS(dataInicioRaw);
            else if(dataInicioRaw) dataInicioObj = new Date(dataInicioRaw);
            
            let dataFimRaw = row["Data Fim"];
            let dataFimObj = null;
            if(typeof dataFimRaw === 'number') dataFimObj = excelDateToJS(dataFimRaw);
            else if(dataFimRaw) dataFimObj = new Date(dataFimRaw);
            
            let statusNorm = "Aberto";
            if (dataFimObj && !isNaN(dataFimObj.getTime())) statusNorm = "Fechado";
            let statusDisplay = row["Status de liberação"] || statusNorm;
            
            let fcrValue = row["FCR"] || "Não";
            if (typeof fcrValue === 'string') {
                fcrValue = fcrValue.trim().toUpperCase();
                if (fcrValue === 'SIM') fcrValue = 'Sim';
                if (fcrValue === 'NÃO' || fcrValue === 'NAO') fcrValue = 'Não';
            }
            
            let tempoResolucao = null, tempoResolucaoDias = null, tempoResolucaoHoras = null, tempoResolucaoFormatado = "-";
            if (dataInicioObj && dataFimObj && !isNaN(dataInicioObj.getTime()) && !isNaN(dataFimObj.getTime()) && statusNorm === "Fechado" && dataFimObj >= dataInicioObj) {
                const diffMs = dataFimObj.getTime() - dataInicioObj.getTime();
                tempoResolucao = diffMs;
                tempoResolucaoDias = diffMs / (1000 * 60 * 60 * 24);
                tempoResolucaoHoras = diffMs / (1000 * 60 * 60);
                tempoResolucaoFormatado = tempoResolucaoDias < 1 ? `${(tempoResolucaoDias * 24).toFixed(1)}h` : `${tempoResolucaoDias.toFixed(1)} dias`;
            }
            
            let tipoContato = String(row["Tipo de contato"] || "").trim();
            if (!tipoContato || tipoContato === "") tipoContato = "Não Informado";
            if (tipoContato.toLowerCase().includes("ativo")) tipoContato = "Ativo";
            if (tipoContato.toLowerCase().includes("receptivo")) tipoContato = "Receptivo";
            
            let origemContato = row["Origem do contato"] || "Não Informado";
            origemContato = origemContato.toString().trim();
            
            let cnpjRawDigits = String(row["CNPJ"] || "").replace(/[^0-9]/g, "");
            let cnpjFormatted = cnpjRawDigits;
            
            if (cnpjFormatted.length === 14) {
                cnpjFormatted = formatCNPJ(cnpjFormatted);
            } else if (cnpjFormatted.length === 13) {
                cnpjFormatted = '0' + cnpjFormatted;
                cnpjFormatted = formatCNPJ(cnpjFormatted);
            } else if (cnpjFormatted.length > 14) {
                cnpjFormatted = formatCNPJ(cnpjFormatted.substring(0, 14));
            } else {
                cnpjFormatted = "Não Informado";
                cnpjRawDigits = "";
            }
            
            let razaoSocial = String(row["Razão Social"] || "").trim();
            if (razaoSocial === "") razaoSocial = "Não Informada";
            
            let gn = row["GN"] || "";
            let gnTratada = tratarGN(gn);
            
            return {
                uid: index,
                status: statusDisplay,
                statusNorm,
                dtStart: dataInicioObj,
                dtEnd: dataFimObj,
                fcr: fcrValue,
                analista: row["Analista"] || "Não Atribuído",
                motivo: row["Motivo"] || "Outros",
                sub: row["Sub Classificação"] || "Geral",
                solicitante: razaoSocial,
                descricao: row["Descrição"] || "",
                cnpj: cnpjRawDigits || "Não Informado",
                cnpjFormatted: cnpjFormatted,
                tipoContato: tipoContato,
                origemContato: origemContato,
                tempoResolucao,
                tempoResolucaoDias,
                tempoResolucaoHoras,
                tempoResolucaoFormatado,
                gn: gnTratada
            };
        });
        
        RAW = RAW.filter(r => r.dtStart && !isNaN(r.dtStart.getTime()));
        FILTERED = [...RAW];
        BASE_FILTERED_LENGTH = FILTERED.length;
        
        populateFilters();
        applyAllFilters();
        
        if (firstLoad) {
            $('datePreset').value = 'currentMonth';
            handleDatePreset();
            firstLoad = false;
        }
        
        setTimeout(() => {
            showLoading(false);
            showToast('Dados carregados com sucesso!', 'success');
            updateLastUpdateTime();
        }, 300);
        
    } catch (err) {
        console.error('Erro processamento:', err);
        showToast('Erro ao ler planilha. Verifique console.', 'error');
        showLoading(false);
    }
}

function populateFilters() {
    const unique = (key) => [...new Set(RAW.map(item => item[key]))]
        .filter(x => (typeof x === 'string' ? x.trim() !== '' : x != null))
        .sort();
    
    const fillSelect = (id, list, defaultText) => {
        const sel = $(id);
        sel.innerHTML = `<option value="">${defaultText}</option>`;
        list.forEach(val => {
            const opt = document.createElement('option');
            opt.value = val;
            opt.innerText = val.length > 40 ? val.substring(0, 40) + '...' : val;
            opt.title = val;
            sel.appendChild(opt);
        });
    };
    
    fillSelect('motivoSelect', unique('motivo'), 'Todos Motivos');
    fillSelect('analistaSelect', unique('analista'), 'Todos Analistas');
    fillSelect('subSelect', unique('sub'), 'Todas Subclasses');
    fillSelect('tipoContatoSelect', unique('tipoContato'), 'Todos Tipos');
}

function applyAllFilters() {
    const q = $('qSearch').value.toLowerCase();
    const fMotivo = $('motivoSelect').value;
    const fAnalista = $('analistaSelect').value;
    const fSub = $('subSelect').value;
    const fTipoContato = $('tipoContatoSelect').value;
    const fOrigem = CHART_FILTERS['Origem'];
    const fGN = CHART_FILTERS['GN'];
    const fCnpjCount = CHART_FILTERS['CnpjCount'];
    const fTopMotivo = CHART_FILTERS['TopMotivo'];
    
    let dStart = $('dateStart').value ? new Date($('dateStart').value) : null;
    let dEnd = $('dateEnd').value ? new Date($('dateEnd').value) : null;
    
    if (CHART_FILTERS['Evo Date']) {
        const filterDate = new Date(CHART_FILTERS['Evo Date']);
        dStart = new Date(filterDate.getFullYear(), filterDate.getMonth(), filterDate.getDate(), 0, 0, 0);
        dEnd = new Date(filterDate.getFullYear(), filterDate.getMonth(), filterDate.getDate(), 23, 59, 59);
    } else if (dEnd) {
        dEnd.setHours(23,59,59);
    }
    
    FILTERED = RAW.filter(item => {
        const textMatch = !q ||
            (item.analista && item.analista.toLowerCase().includes(q)) ||
            (item.solicitante && item.solicitante.toLowerCase().includes(q)) ||
            (item.motivo && item.motivo.toLowerCase().includes(q)) ||
            (item.cnpj && item.cnpj.toString().includes(q)) ||
            (item.cnpjFormatted && item.cnpjFormatted.toLowerCase().includes(q)) ||
            (item.gn && item.gn.toLowerCase().includes(q));
        
        const motivoMatch = !fMotivo || item.motivo === fMotivo;
        const analistaMatch = !fAnalista || item.analista === fAnalista;
        const subMatch = !fSub || item.sub === fSub;
        const tipoContatoMatch = !fTipoContato || item.tipoContato === fTipoContato;
        const origemMatch = !fOrigem || item.origemContato === fOrigem;
        const gnMatch = !fGN || item.gn === fGN;
        const cnpjCountMatch = !fCnpjCount || (item.cnpj && item.cnpj.trim() !== '');
        const topMotivoMatch = !fTopMotivo || item.motivo === fTopMotivo;
        
        let dateMatch = true;
        if (dStart || dEnd) {
            const itemDate = item.dtStart;
            if (!itemDate) dateMatch = false;
            else {
                if (dStart && itemDate < dStart) dateMatch = false;
                if (dateMatch && dEnd && itemDate > dEnd) dateMatch = false;
            }
        }
        
        const kpiStatusMatch = !CHART_FILTERS['Status'] ||
            (CHART_FILTERS['Status'] === 'Fechado' ? item.statusNorm === 'Fechado' : item.statusNorm === 'Aberto');
        
        const kpiFcrMatch = !CHART_FILTERS['FCR_Sim'] || item.fcr === 'Sim';
        
        const kpiAvgTimeMatch = !CHART_FILTERS['AvgTime'] || (item.statusNorm === 'Fechado' && item.tempoResolucao !== null);
        
        const chartAnalistaMatch = !CHART_FILTERS['Doughnut Selection']['Analista'] || item.analista === CHART_FILTERS['Doughnut Selection']['Analista'];
        
        return textMatch && motivoMatch && analistaMatch && subMatch && tipoContatoMatch && origemMatch && dateMatch &&
            kpiStatusMatch && kpiFcrMatch && kpiAvgTimeMatch && chartAnalistaMatch && gnMatch && cnpjCountMatch && topMotivoMatch;
    });
    
    renderKPIs();
    renderCharts();
    renderTable();
    updateActiveFiltersDisplay();
    generateGamification();
}

function renderKPIs() {
    const total = FILTERED.length;
    const closed = FILTERED.filter(d => d.statusNorm === 'Fechado').length;
    const open = total - closed;
    
    const fcrCount = FILTERED.filter(d => (d.fcr || '').toUpperCase() === 'SIM').length;
    const fcrPerc = total > 0 ? Math.round((fcrCount / total) * 100) : 0;
    
    // Cálculo do tempo médio em dias
    const closedWithTime = FILTERED.filter(d => d.statusNorm === 'Fechado' && d.tempoResolucao !== null);
    let avgTimeDays = 0;
    let avgTimeDisplay = "0d";
    if (closedWithTime.length > 0) {
        const totalMs = closedWithTime.reduce((acc, d) => acc + d.tempoResolucao, 0);
        const avgTimeHours = totalMs / closedWithTime.length / (1000 * 60 * 60);
        avgTimeDays = (avgTimeHours / 24).toFixed(1);
        avgTimeDisplay = `${avgTimeDays}d`;
    }
    
    // CNPJ únicos
    const cnpjSet = new Set();
    FILTERED.forEach(item => {
        if (item.cnpj && item.cnpj.trim() !== '') {
            cnpjSet.add(item.cnpj.trim());
        }
    });
    const cnpjCount = cnpjSet.size;
    
    // Motivo mais tratado
    const motivoCounts = {};
    FILTERED.forEach(item => {
        const motivo = item.motivo || 'Não informado';
        motivoCounts[motivo] = (motivoCounts[motivo] || 0) + 1;
    });
    let topMotivo = '-';
    let topMotivoCount = 0;
    if (Object.keys(motivoCounts).length > 0) {
        const entries = Object.entries(motivoCounts);
        entries.forEach(([motivo, count]) => {
            if (count > topMotivoCount) {
                topMotivoCount = count;
                topMotivo = motivo;
            }
        });
    }
    
    const topMotivoDisplay = topMotivo.length > 20 ? topMotivo.substring(0, 20) + '...' : topMotivo;
    
    // Atualizar KPIs
    $('kTotal').innerText = total;
    $('kOpen').innerText = open;
    $('kClosed').innerText = closed;
    $('kFCR').innerText = fcrPerc + '%';
    $('kAvgTime').innerText = avgTimeDisplay;
    $('kCnpjCount').innerText = cnpjCount;

    // Atualizar percentuais/trends dos KPIs
    updateKPITrends(total, open, closed, fcrPerc, cnpjCount, topMotivoCount, avgTimeDays);
    
    // Atualizar motivo mais tratado com tooltip
    const kTopMotivoElement = $('kTopMotivo');
    kTopMotivoElement.innerHTML = `<span title="${topMotivo}">${topMotivoDisplay}</span> <span style="font-size:16px; color:var(--color-azul)">(${topMotivoCount})</span>`;
    kTopMotivoElement.setAttribute('title', topMotivo);
    
    $('headerTotal').innerText = total;
    $('headerOpen').innerText = open;
    $('headerClosed').innerText = closed;
    
    $('contextSummary').innerHTML = `Exibindo <span>${total}</span> registros filtrados de <span>${RAW.length}</span> totais.`;
    
    $('kTotalHelper').innerText = (CHART_FILTERS['Status'] || CHART_FILTERS['FCR_Sim'] || CHART_FILTERS['AvgTime']) ?
        'Clique para limpar todos os filtros' : 'Clique para limpar todos os filtros';
    
    $('kOpenHelper').innerText = CHART_FILTERS['Status'] === 'Aberto' ?
        'Clique para remover filtro "Em Aberto"' : 'Clique para filtrar por status "Em Aberto"';
    
    $('kClosedHelper').innerText = (CHART_FILTERS['Status'] === 'Fechado' && !CHART_FILTERS['FCR_Sim'] && !CHART_FILTERS['AvgTime']) ?
        'Clique para remover filtro "Concluído"' : 'Clique para filtrar por status "Concluído"';
    
    $('kFCRHelper').innerText = CHART_FILTERS['FCR_Sim'] === 'Sim' ?
        'Clique para remover filtro FCR' : 'Clique para filtrar por FCR = Sim';
    
    $('kAvgTimeHelper').innerText = CHART_FILTERS['AvgTime'] ?
        'Clique para remover filtro Tempo Médio' : 'Baseado apenas nos casos concluídos';
    
    ['kpiTotal', 'kpiOpen', 'kpiClosed', 'kpiFCR', 'kpiAvgTime', 'kpiCnpjCount', 'kpiTopMotivo'].forEach(id => $(id).classList.remove('active-filter'));
    
    if (CHART_FILTERS['Status'] === 'Aberto') $('kpiOpen').classList.add('active-filter');
    else if (CHART_FILTERS['Status'] === 'Fechado' && CHART_FILTERS['FCR_Sim'] !== 'Sim' && !CHART_FILTERS['AvgTime']) $('kpiClosed').classList.add('active-filter');
    else if (CHART_FILTERS['FCR_Sim'] === 'Sim') $('kpiFCR').classList.add('active-filter');
    else if (CHART_FILTERS['AvgTime']) $('kpiAvgTime').classList.add('active-filter');
    if (CHART_FILTERS['CnpjCount']) $('kpiCnpjCount').classList.add('active-filter');
    if (CHART_FILTERS['TopMotivo']) $('kpiTopMotivo').classList.add('active-filter');
}


// Função para atualizar os percentuais/trends dos KPIs
function updateKPITrends(total, open, closed, fcrPerc, cnpjCount, topMotivoCount, avgTimeDays) {
    // Percentual de Em Aberto
    const openPerc = total > 0 ? Math.round((open / total) * 100) : 0;
    const openTrend = $('kOpenTrend');
    if (openTrend) {
        openTrend.className = 'kpi-trend ' + (openPerc > 50 ? 'down' : openPerc > 30 ? 'neutral' : 'up');
        openTrend.innerHTML = '<span>' + openPerc + '% do total</span>';
    }

    // Percentual de Concluídos
    const closedPerc = total > 0 ? Math.round((closed / total) * 100) : 0;
    const closedTrend = $('kClosedTrend');
    if (closedTrend) {
        closedTrend.className = 'kpi-trend ' + (closedPerc >= 70 ? 'up' : closedPerc >= 50 ? 'neutral' : 'down');
        closedTrend.innerHTML = '<span>' + closedPerc + '% do total</span>';
    }

    // Total trend removido conforme solicitado

    // FCR - meta de 80%
    const fcrTrend = $('kFCRTrend');
    if (fcrTrend) {
        fcrTrend.className = 'kpi-trend ' + (fcrPerc >= 80 ? 'up' : fcrPerc >= 60 ? 'neutral' : 'down');
        fcrTrend.innerHTML = '<i class="fa-solid ' + (fcrPerc >= 80 ? 'fa-check' : fcrPerc >= 60 ? 'fa-minus' : 'fa-xmark') + '"></i> <span>Meta: 80%</span>';
    }

    // Tempo Médio - meta de 1.0 dias
    const avgTrend = $('kAvgTimeTrend');
    if (avgTrend) {
        const avgTimeDaysNum = parseFloat(avgTimeDays) || 0;
        avgTrend.className = 'kpi-trend ' + (avgTimeDaysNum <= 1.0 ? 'up' : avgTimeDaysNum <= 2.0 ? 'neutral' : 'down');
        if (avgTimeDaysNum > 0) {
            avgTrend.innerHTML = '<i class="fa-solid ' + (avgTimeDaysNum <= 1.0 ? 'fa-check' : avgTimeDaysNum <= 2.0 ? 'fa-minus' : 'fa-xmark') + '"></i> <span>Meta: 1.0d</span>';
        } else {
            avgTrend.innerHTML = '<i class="fa-solid fa-minus"></i> <span>--</span>';
        }
    }

    // CNPJ - média de registros por CNPJ
    const cnpjTrend = $('kCnpjTrend');
    if (cnpjTrend) {
        const avgPerCnpj = cnpjCount > 0 ? (total / cnpjCount).toFixed(1) : 0;
        cnpjTrend.className = 'kpi-trend neutral';
        cnpjTrend.innerHTML = '<i class="fa-solid fa-chart-simple"></i> <span>' + avgPerCnpj + ' reg/CNPJ</span>';
    }

    // Motivo - percentual do top motivo
    const motivoTrend = $('kMotivoTrend');
    if (motivoTrend) {
        const motivoPerc = total > 0 ? Math.round((topMotivoCount / total) * 100) : 0;
        motivoTrend.className = 'kpi-trend neutral';
        motivoTrend.innerHTML = '<i class="fa-solid fa-percent"></i> <span>' + motivoPerc + '% do total</span>';
    }
}

function filterByKPI(filterType) {
    if (filterType === 'Total') {
        if (CHART_FILTERS['Status'] === null && CHART_FILTERS['FCR_Sim'] === null && CHART_FILTERS['AvgTime'] === null) return;
        CHART_FILTERS['Status'] = null;
        CHART_FILTERS['FCR_Sim'] = null;
        CHART_FILTERS['AvgTime'] = null;
    } else if (filterType === 'Aberto') {
        if (CHART_FILTERS['Status'] === 'Aberto') {
            CHART_FILTERS['Status'] = null;
        } else {
            CHART_FILTERS['Status'] = 'Aberto';
            CHART_FILTERS['FCR_Sim'] = null;
            CHART_FILTERS['AvgTime'] = null;
        }
    } else if (filterType === 'Fechado') {
        if (CHART_FILTERS['Status'] === 'Fechado' && CHART_FILTERS['FCR_Sim'] !== 'Sim' && !CHART_FILTERS['AvgTime']) {
            CHART_FILTERS['Status'] = null;
        } else {
            CHART_FILTERS['Status'] = 'Fechado';
            CHART_FILTERS['FCR_Sim'] = null;
            CHART_FILTERS['AvgTime'] = null;
        }
    } else if (filterType === 'FCR') {
        if (CHART_FILTERS['FCR_Sim'] === 'Sim') {
            CHART_FILTERS['FCR_Sim'] = null;
            CHART_FILTERS['Status'] = null;
            CHART_FILTERS['AvgTime'] = null;
        } else {
            CHART_FILTERS['FCR_Sim'] = 'Sim';
            CHART_FILTERS['Status'] = 'Fechado';
            CHART_FILTERS['AvgTime'] = null;
        }
    } else if (filterType === 'AvgTime') {
        if (CHART_FILTERS['AvgTime']) {
            CHART_FILTERS['AvgTime'] = null;
            CHART_FILTERS['Status'] = null;
        } else {
            CHART_FILTERS['AvgTime'] = 'Sim';
            CHART_FILTERS['Status'] = 'Fechado';
            CHART_FILTERS['FCR_Sim'] = null;
        }
    } else if (filterType === 'CnpjCount') {
        if (CHART_FILTERS['CnpjCount']) {
            CHART_FILTERS['CnpjCount'] = null;
        } else {
            CHART_FILTERS['CnpjCount'] = 'Sim';
        }
    } else if (filterType === 'TopMotivo') {
        if (CHART_FILTERS['TopMotivo']) {
            CHART_FILTERS['TopMotivo'] = null;
        } else {
            const motivoCounts = {};
            FILTERED.forEach(item => {
                const motivo = item.motivo || 'Não informado';
                motivoCounts[motivo] = (motivoCounts[motivo] || 0) + 1;
            });
            let topMotivo = null;
            let topMotivoCount = 0;
            Object.entries(motivoCounts).forEach(([motivo, count]) => {
                if (count > topMotivoCount) {
                    topMotivoCount = count;
                    topMotivo = motivo;
                }
            });
            CHART_FILTERS['TopMotivo'] = topMotivo;
        }
    }
    
    applyAllFilters();
}

function filterByOrigem(origem) {
    if (CHART_FILTERS['Origem'] === origem) {
        CHART_FILTERS['Origem'] = null;
        showToast(`Filtro de origem "${origem}" removido`, 'info');
    } else {
        CHART_FILTERS['Origem'] = origem;
        showToast(`Filtrando por origem: ${origem}`, 'success');
    }
    applyAllFilters();
}

// ===== FUNÇÕES DE RENDERIZAÇÃO DE GRÁFICOS COM NOVAS PALETAS =====
function renderCharts() {
    const countsAnalista = {};
    FILTERED.forEach(d => countsAnalista[d.analista] = (countsAnalista[d.analista]||0)+1);
    const sortedAnalista = Object.entries(countsAnalista).sort((a,b)=>b[1]-a[1]).slice(0, 15);
    
    createBarChart('chartAnal', sortedAnalista.map(x=>x[0]), sortedAnalista.map(x=>x[1]), 'Analista');
    createTipoAtendimentoChart();
    createOrigemContatoChart();
    
    const countsGN = {};
    FILTERED.forEach(d => {
        const gn = d.gn || 'Não informado';
        countsGN[gn] = (countsGN[gn]||0)+1;
    });
    createDoughnutChart('chartGN', countsGN, 'chartGNCenter', 'legendGN', 'GN');
    
    const countsSub = {};
    FILTERED.forEach(d => {
        const sub = d.sub || 'Não informado';
        countsSub[sub] = (countsSub[sub]||0)+1;
    });
    createDoughnutChart('chartSubclassificacao', countsSub, 'chartSubclassificacaoCenter', 'legendSubclassificacao', 'Subclasse');
    
    const timelineData = {};
    FILTERED.forEach(d => {
        if (!d.dtStart) return;
        const dateKey = moment(d.dtStart).format('YYYY-MM-DD');
        if(!timelineData[dateKey]) timelineData[dateKey] = { total: 0, closed: 0 };
        timelineData[dateKey].total++;
        if(d.statusNorm === 'Fechado') timelineData[dateKey].closed++;
    });
    
    const allDates = [];
    if (FILTERED.length > 0) {
        const minDate = new Date(Math.min(...FILTERED.map(d => d.dtStart).filter(d => d)));
        const maxDate = new Date(Math.max(...FILTERED.map(d => d.dtStart).filter(d => d)));
        let currentDate = new Date(minDate);
        while (currentDate <= maxDate) {
            allDates.push(moment(currentDate).format('YYYY-MM-DD'));
            currentDate.setDate(currentDate.getDate() + 1);
        }
    }
    
    const sortedDates = allDates.sort();
    const totalPoints = sortedDates.map(d => ({
        x: moment(d, 'YYYY-MM-DD').toDate(),
        y: timelineData[d] ? timelineData[d].total : 0
    }));
    
    const closedPoints = sortedDates.map(d => ({
        x: moment(d, 'YYYY-MM-DD').toDate(),
        y: timelineData[d] ? timelineData[d].closed : 0
    }));
    
    createLineChart('chartEvo', totalPoints, closedPoints);
    
    const countsMotivo = {};
    FILTERED.forEach(d => {
        const motivo = d.motivo || 'Não informado';
        countsMotivo[motivo] = (countsMotivo[motivo]||0)+1;
    });
    const sortedMotivo = Object.entries(countsMotivo).sort((a,b)=>b[1]-a[1]);
    createHorizontalBarChart('chartMot', sortedMotivo.map(x=>x[0]), sortedMotivo.map(x=>x[1]));
}

function createOrigemContatoChart() {
    const ctx = $('chartOrigemContato').getContext('2d');
    if(charts.chartOrigemContato) charts.chartOrigemContato.destroy();
    
    const origemCounts = {};
    FILTERED.forEach(d => {
        const origem = d.origemContato || 'Não Informado';
        origemCounts[origem] = (origemCounts[origem] || 0) + 1;
    });
    
    let origemArray = Object.entries(origemCounts).map(([origem, count]) => ({origem, count}));
    origemArray.sort((a, b) => b.count - a.count);
    
    let topOrigem = [];
    let othersCount = 0;
    if (origemArray.length > 8) {
        topOrigem = origemArray.slice(0, 7);
        othersCount = origemArray.slice(7).reduce((sum, item) => sum + item.count, 0);
        if (othersCount > 0) {
            topOrigem.push({origem: 'Outros', count: othersCount});
        }
    } else {
        topOrigem = origemArray;
    }
    
    const labels = topOrigem.map(item => item.origem);
    const data = topOrigem.map(item => item.count);
    const total = data.reduce((a, b) => a + b, 0);
    
    $('chartOrigemContatoCenter').innerHTML = `
        <div class="doughnut-center-name">Total</div>
        <div class="doughnut-center-value">${total}</div>
    `;
    
    const legendDiv = $('legendOrigemContato');
    let legendHtml = '';
    
    topOrigem.forEach((item, index) => {
        const perc = total > 0 ? Math.round((item.count/total)*100) : 0;
        const color = GN_PALETTE[index % GN_PALETTE.length];
        legendHtml += `
            <div class="legend-item" onclick="filterByOrigem('${item.origem.replace(/'/g, "\\'")}')">
                <span class="legend-color" style="background:${color}"></span>
                <span class="legend-label" title="${item.origem}">${item.origem}</span>
                <span class="legend-value">${item.count} (${perc}%)</span>
            </div>
        `;
    });
    
    legendDiv.innerHTML = legendHtml;
    
    charts.chartOrigemContato = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: labels,
            datasets: [{
                data: data,
                backgroundColor: labels.map((_, i) => GN_PALETTE[i % GN_PALETTE.length]),
                borderWidth: 2,
                borderColor: 'rgba(255, 255, 255, 0.1)',
                hoverBorderWidth: 3
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            cutout: '70%',
            plugins: {
                legend: { display: false },
                datalabels: {
                    display: true,
                    color: '#fff',
                    font: { weight: 'bold', size: 11 },
                    formatter: (value) => value
                }
            },
            onClick: (e, els) => {
                if(!els.length) return;
                const idx = els[0].index;
                const origem = labels[idx];
                if (origem !== 'Outros') {
                    filterByOrigem(origem);
                }
            }
        },
        plugins: [ChartDataLabels]
    });

    // Configurar hover para destacar legendas
    window.setupDoughnutHover(charts.chartOrigemContato, 'legendOrigemContato');
}

function createBarChart(id, labels, data, type) {
    const ctx = $(id).getContext('2d');
    if(charts[id]) charts[id].destroy();
    
    charts[id] = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Volume',
                data: data,
                backgroundColor: labels.map((_, index) => 
                    GN_PALETTE[index % GN_PALETTE.length]
                ),
                borderRadius: 4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            onClick: (e, els) => {
                if(els.length > 0) {
                    const idx = els[0].index;
                    const val = labels[idx];
                    if (CHART_FILTERS['Analista'] === val) {
                        CHART_FILTERS['Analista'] = null;
                        delete CHART_FILTERS['Doughnut Selection']['Analista'];
                        $('analistaSelect').value = '';
                        showToast(`Filtro do analista "${val}" removido`, 'info');
                    } else {
                        CHART_FILTERS['Analista'] = val;
                        CHART_FILTERS['Doughnut Selection']['Analista'] = val;
                        $('analistaSelect').value = val;
                        showToast(`Filtrando por analista: ${val}`, 'success');
                    }
                    applyAllFilters();
                }
            },
            plugins: {
                legend: { display: false },
                datalabels: {
                    color: function(context) {
                        const backgroundColor = context.dataset.backgroundColor[context.dataIndex];
                        return getContrastColor(backgroundColor);
                    },
                    anchor: 'center',
                    align: 'center',
                    formatter: (value) => value,
                    font: { weight: 'bold', size: 12 }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: { color: 'rgba(255, 255, 255, 0.05)' },
                    ticks: { stepSize: 1 }
                },
                x: {
                    grid: { display: false },
                    ticks: {
                        autoSkip: false,
                        maxRotation: 45,
                        minRotation: 0,
                        font: { size: 11 }
                    }
                }
            }
        },
        plugins: [ChartDataLabels]
    });
}

function createTipoAtendimentoChart() {
    const ctx = $('chartTipoAtendimento').getContext('2d');
    if(charts.chartTipoAtendimento) charts.chartTipoAtendimento.destroy();
    
    const tipoCounts = {};
    FILTERED.forEach(d => {
        const tipo = d.tipoContato || 'Não Informado';
        tipoCounts[tipo] = (tipoCounts[tipo] || 0) + 1;
    });
    
    const tiposArray = Object.entries(tipoCounts);
    tiposArray.sort((a, b) => b[1] - a[1]);
    
    const labels = tiposArray.map(item => item[0]);
    const data = tiposArray.map(item => item[1]);
    const total = data.reduce((a, b) => a + b, 0);
    
    const backgroundColors = labels.map(label => {
        if (label === 'Ativo') return IPIRANGA_BLUE;
        if (label === 'Receptivo') return IPIRANGA_YELLOW;
        if (label === 'Não Informado') return '#8B8D9E';
        return GN_PALETTE[labels.indexOf(label) % GN_PALETTE.length];
    });
    
    charts.chartTipoAtendimento = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Quantidade',
                data: data,
                backgroundColor: backgroundColors,
                borderColor: backgroundColors.map(color => color.replace('0.8', '1')),
                borderWidth: 1,
                borderRadius: 6,
                barPercentage: 0.6
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            onClick: (e, elements) => {
                if (elements.length > 0) {
                    const index = elements[0].index;
                    const tipo = labels[index];
                    if (CHART_FILTERS['TipoContato'] === tipo || $('tipoContatoSelect').value === tipo) {
                        CHART_FILTERS['TipoContato'] = null;
                        $('tipoContatoSelect').value = '';
                        showToast(`Filtro de tipo "${tipo}" removido`, 'info');
                    } else {
                        CHART_FILTERS['TipoContato'] = tipo;
                        $('tipoContatoSelect').value = tipo;
                        showToast(`Filtrando por tipo: ${tipo}`, 'success');
                    }
                    applyAllFilters();
                }
            },
            plugins: {
                legend: { display: false },
                datalabels: {
                    color: function(context) {
                        const backgroundColor = context.dataset.backgroundColor[context.dataIndex];
                        return getContrastColor(backgroundColor);
                    },
                    anchor: 'center',
                    align: 'center',
                    font: { weight: 'bold', size: 11 },
                    formatter: (value) => value
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const label = context.dataset.label || '';
                            const value = context.parsed.y;
                            const percentage = ((value / total) * 100).toFixed(1);
                            return `${label}: ${value} (${percentage}%)`;
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: { color: 'rgba(255, 255, 255, 0.05)' },
                    ticks: {
                        stepSize: 1,
                        font: { size: 11 }
                    }
                },
                x: {
                    grid: { display: false },
                    ticks: {
                        font: { size: 11 },
                        maxRotation: 45
                    }
                }
            }
        },
        plugins: [ChartDataLabels]
    });
}

function createDoughnutChart(id, dataObj, centerId, legendId, title) {
    let processed = [];
    for (let key in dataObj) {
        processed.push({ keyNorm: key, keyDisplay: key, count: dataObj[key] });
    }
    processed.sort((a,b)=>b.count-a.count);
    
    let top = processed.slice(0,7);
    let othersCount = processed.slice(7).reduce((acc, cur)=>acc+cur.count, 0);
    if (othersCount>0) top.push({ keyNorm: 'Outros', keyDisplay: 'Outros', count: othersCount });
    
    const labels = top.map(x=>x.keyDisplay);
    const data = top.map(x=>x.count);
    
    const ctx = $(id).getContext('2d');
    if(charts[id]) charts[id].destroy();
    
    const total = data.reduce((a,b)=>a+b,0);
    $(centerId).innerHTML = `<div class="doughnut-center-name">${title}</div><div class="doughnut-center-value">${total}</div>`;
    
    let legendHtml = '';
    top.forEach((item, i) => {
        const perc = total > 0 ? Math.round((item.count/total)*100) : 0;
        const color = GN_PALETTE[i % GN_PALETTE.length];
        legendHtml += `<div class="legend-item" onclick="filterByGN('${item.keyNorm.replace(/'/g, "\\'")}')">
            <span class="legend-color" style="background:${color}"></span>
            <span class="legend-label" title="${item.keyDisplay}">${item.keyDisplay}</span>
            <span class="legend-value">${item.count} (${perc}%)</span>
        </div>`;
    });
    
    $(legendId).innerHTML = legendHtml;
    
    charts[id] = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: labels,
            datasets: [{
                data: data,
                backgroundColor: labels.map((_, i) => GN_PALETTE[i % GN_PALETTE.length]),
                borderWidth: 2,
                borderColor: 'rgba(255, 255, 255, 0.1)'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            cutout: '70%',
            rotation: -90,
            circumference: 360,
            plugins: {
                legend: { display: false },
                datalabels: {
                    display: true,
                    color: '#fff',
                    font: { weight: 'bold', size: 11 },
                    formatter: (value) => value
                }
            },
            onClick: (e, els) => {
                if(!els.length) return;
                const idx = els[0].index;
                const displayVal = labels[idx];
                if (displayVal === 'Outros') return;
                if (title === 'Subclasse') {
                    if ($('subSelect').value === displayVal) {
                        $('subSelect').value = '';
                        showToast(`Filtro de subclasse removido`, 'info');
                    } else {
                        $('subSelect').value = displayVal;
                        showToast(`Filtrando por subclasse: ${displayVal}`, 'success');
                    }
                    applyAllFilters();
                } else if (title === 'GN') {
                    filterByGN(displayVal);
                }
            }
        },
        plugins: [ChartDataLabels]
    });

    // Configurar hover para destacar legendas
    window.setupDoughnutHover(charts[id], legendId);
}

function filterByGN(gn) {
    if (CHART_FILTERS['GN'] === gn) {
        CHART_FILTERS['GN'] = null;
        showToast(`Filtro de GN removido`, 'info');
    } else {
        CHART_FILTERS['GN'] = gn;
        showToast(`Filtrando por GN: ${gn}`, 'success');
    }
    applyAllFilters();
}

function createLineChart(id, totalPoints, closedPoints) {
    const ctx = $(id).getContext('2d');
    if(charts[id]) charts[id].destroy();
    
    const labels = totalPoints.map(p => moment(p.x).format('YYYY-MM-DD'));
    const totalData = totalPoints.map(p => p.y);
    const closedData = closedPoints.map(p => p.y);
    
    const isDateFiltered = CHART_FILTERS['Evo Date'] !== null;
    let gradient;
    if (!isDateFiltered) {
        gradient = ctx.createLinearGradient(0, 0, 0, 280);
        gradient.addColorStop(0, 'rgba(61, 141, 255, 0.3)');
        gradient.addColorStop(1, 'rgba(61, 141, 255, 0)');
    }
   
    charts[id] = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [
                {
                    label: 'Total',
                    data: totalData,
                    borderColor: BRAND_BLUE,
                    backgroundColor: isDateFiltered ? 'transparent' : gradient,
                    fill: !isDateFiltered,
                    tension: 0.4,
                    pointRadius: labels.map(d => d === CHART_FILTERS['Evo Date'] ? 8 : 4),
                    pointHoverRadius: 8,
                    pointBackgroundColor: labels.map(d => d === CHART_FILTERS['Evo Date'] ? BRAND_ORANGE : BRAND_YELLOW),
                    pointBorderColor: BRAND_BLUE,
                    pointBorderWidth: 2,
                    borderWidth: isDateFiltered ? 1 : 3
                },
                {
                    label: 'Concluído',
                    data: closedData,
                    borderColor: SUCCESS_GREEN,
                    backgroundColor: 'transparent',
                    borderWidth: 2,
                    borderDash: [5, 5],
                    tension: 0.4
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: { mode: 'nearest', intersect: true },
            plugins: {
                legend: {
                    display: true,
                    position: 'top',
                    labels: {
                        usePointStyle: true,
                        padding: 20,
                        font: { size: 12 }
                    }
                },
                tooltip: {
                    callbacks: {
                        title: (items) => {
                            (() => {
                                    const label = items[0].label;
                                    let parsed = moment(label, 'YYYY-MM-DD');
                                    if (!parsed.isValid()) parsed = moment(label, 'DD/MM');
                                    if (!parsed.isValid()) parsed = moment(label);
                                    return parsed.isValid() ? parsed.format('ddd, DD/MM/YYYY') : label;
                                })();
                        },
                        label: (ctx) => `${ctx.dataset.label}: ${ctx.parsed.y}`
                    }
                }
            },
            scales: {
                x: {
                            type: 'category',
                            grid: {
                                display: false
                            },
                            ticks: {
                                callback: function(value, index) {
                                    const label = this.getLabelForValue(value);
                                    const parsed = moment(label, 'YYYY-MM-DD');
                                    return parsed.isValid() ? parsed.format('DD/MM') : label;
                                },
                                maxRotation: 45,
                                minRotation: 0,
                                font: { size: 11 },
                                autoSkip: true,
                                maxTicksLimit: 15
                            }
                        },
                y: {
                    beginAtZero: true,
                    grid: { color: 'rgba(255, 255, 255, 0.05)' },
                    ticks: { stepSize: 1 }
                }
            },
            onClick: (e, elements) => {
                if (!elements.length) return;
                const element = elements[0];
                const datasetIndex = element.datasetIndex;
                const index = element.index;
                
                if (datasetIndex === 0) {
                    const dateLabel = labels[index];
                    const dateISO = dateLabel;
        
                    if (CHART_FILTERS['Evo Date'] === dateISO) {
                        CHART_FILTERS['Evo Date'] = null;
                        if ($('dateStart').value === dateISO && $('dateEnd').value === dateISO) {
                            $('dateStart').value = '';
                            $('dateEnd').value = '';
                        }
                        $('datePreset').value = '';
                        showToast(`Filtro de data removido`, 'info');
                    } else {
                        CHART_FILTERS['Evo Date'] = dateISO;
                        $('dateStart').value = dateISO;
                        $('dateEnd').value = dateISO;
                        $('datePreset').value = '';
                        showToast(`Filtrando por data: ${moment(dateISO).format('DD/MM/YYYY')}`, 'success');
                    }
                    
                    applyAllFilters();
                }
            }
        }
    });
}

function createHorizontalBarChart(id, labels, data) {
    const ctx = $(id).getContext('2d');
    if(charts[id]) charts[id].destroy();
    
    const barHeight = 25;
    const minHeight = 300;
    const canvasHeight = Math.max(minHeight, labels.length * barHeight + 50);
    
    ctx.canvas.height = canvasHeight;
    ctx.canvas.style.height = canvasHeight + 'px';
    ctx.canvas.style.width = '100%';
    
    charts[id] = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Ocorrências',
                data: data,
                backgroundColor: labels.map((_, index) => 
                    MOTIVO_PALETTE[index % MOTIVO_PALETTE.length]
                ),
                barThickness: 20,
                borderRadius: 6
            }]
        },
        options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            onClick: (e, els) => {
                if(els.length > 0) {
                    const idx = els[0].index;
                    const val = labels[idx];
                    if (CHART_FILTERS['Motivo'] === val || $('motivoSelect').value === val) {
                        CHART_FILTERS['Motivo'] = null;
                        $('motivoSelect').value = '';
                        showToast(`Filtro do motivo "${val}" removido`, 'info');
                    } else {
                        CHART_FILTERS['Motivo'] = val;
                        $('motivoSelect').value = val;
                        showToast(`Filtrando por motivo: ${val}`, 'success');
                    }
                    applyAllFilters();
                }
            },
            plugins: {
                legend: { display: false },
                datalabels: {
                    color: function(context) {
                        const backgroundColor = context.dataset.backgroundColor[context.dataIndex];
                        return getContrastColor(backgroundColor);
                    },
                    anchor: 'end',
                    align: 'center',
                    formatter: (val) => val,
                    font: { weight: 'bold', size: 12 },
                    offset: 10
                }
            },
            scales: {
                x: {
                    beginAtZero: true,
                    grid: { display: false },
                    ticks: { stepSize: 1 }
                },
                y: {
                    grid: { display: false },
                    ticks: {
                        font: { size: 12 },
                        autoSkip: false,
                        padding: 10 // Adiciona espaço entre o rótulo e o gráfico
                    }
                }
            }
        },
        plugins: [ChartDataLabels]
    });
}

function renderTable() {
    const tbody = document.querySelector('#dataTable tbody');
    tbody.innerHTML = '';
    
    const sortedData = [...FILTERED].sort((a,b) => {
        let valA = a[CURRENT_SORT.key];
        let valB = b[CURRENT_SORT.key];
        
        if (CURRENT_SORT.key === 'dtStart' || CURRENT_SORT.key === 'dtEnd') {
            valA = valA ? new Date(valA).getTime() : 0;
            valB = valB ? new Date(valB).getTime() : 0;
        } else {
            if(valA == null) valA = "";
            if(valB == null) valB = "";
            if (typeof valA === 'string') valA = valA.toLowerCase();
            if (typeof valB === 'string') valB = valB.toLowerCase();
        }
        
        if (valA < valB) return CURRENT_SORT.direction === 'asc' ? -1 : 1;
        if (valA > valB) return CURRENT_SORT.direction === 'asc' ? 1 : -1;
        return 0;
    });
    
    const totalPages = Math.ceil(sortedData.length / ITEMS_PER_PAGE);
    if(CURRENT_PAGE > totalPages) CURRENT_PAGE = 1;
    
    const start = (CURRENT_PAGE - 1) * ITEMS_PER_PAGE;
    const end = start + ITEMS_PER_PAGE;
    const pageData = sortedData.slice(start, end);
    
    $('paginationInfo').innerText = `${sortedData.length ? start+1 : 0}-${Math.min(end, sortedData.length)} de ${sortedData.length}`;
    $('prevPage').disabled = CURRENT_PAGE === 1;
    $('nextPage').disabled = CURRENT_PAGE >= totalPages || totalPages === 0;
    
    if(pageData.length === 0) {
        tbody.innerHTML = `<tr><td colspan="11" style="text-align:center;padding:20px;color:var(--text-muted)">Nenhum dado encontrado</td></tr>`;
        return;
    }
    
    pageData.forEach((row, index) => {
        const tr = document.createElement('tr');
        tr.style.animation = `fadeIn 0.3s ease-out ${index * 0.05}s forwards`;
        tr.style.opacity = '0';
        
        let statusClass = row.statusNorm === 'Fechado' ? 'st-fechado' : 'st-aberto';
        let statusText = row.statusNorm === 'Fechado' ? 'Concluído' : 'Em Aberto';
        
        const dtStart = row.dtStart ? moment(row.dtStart).format('DD/MM/YYYY') : '-';
        const dtEnd = row.dtEnd ? moment(row.dtEnd).format('DD/MM/YYYY') : '-';
        
        const fcrColor = row.fcr === 'Sim' ? 'color:var(--success-green);font-weight:700;' : 'color:var(--text-secondary);';
        
        let tempoCor = 'color:var(--text-secondary);';
        if (row.tempoResolucaoDias !== null) {
            if (row.tempoResolucaoDias > 7) tempoCor = 'color:var(--error-red);font-weight:700;';
            else if (row.tempoResolucaoDias > 3) tempoCor = 'color:var(--brand-orange);font-weight:600;';
            else if (row.tempoResolucaoDias > 0) tempoCor = 'color:var(--success-green);font-weight:600;';
        }
        
        let tipoCor = 'color:var(--text-secondary);';
        if (row.tipoContato === 'Ativo') tipoCor = 'color:var(--brand-blue);font-weight:600;';
        else if (row.tipoContato === 'Receptivo') tipoCor = 'color:var(--color-amarelo);font-weight:600;';
        
        let origemCor = 'color:var(--text-secondary);';
        if (row.origemContato === 'Whatsapp') origemCor = 'color:#25D366;font-weight:600;';
        else if (row.origemContato === 'Telefone') origemCor = 'color:#34B7F1;font-weight:600;';
        else if (row.origemContato === 'E-mail') origemCor = 'color:#EA4335;font-weight:600;';
        else if (row.origemContato === 'Teams') origemCor = 'color:#7B83EB;font-weight:600;';
        
        tr.innerHTML = `
            <td><span class="status-pill ${statusClass}">${statusText}</span></td>
            <td>${dtStart}</td>
            <td>${dtEnd}</td>
            <td style="${tempoCor}">${row.tempoResolucaoFormatado}</td>
            <td style="${fcrColor}">${row.fcr}</td>
            <td style="font-weight:600;color:var(--brand-blue)">${row.analista}</td>
            <td class="truncated" title="${normalizarMotivo(row.motivo)}">${normalizarMotivo(row.motivo)}</td>
            <td class="truncated" title="${row.sub}">${row.sub}</td>
            <td class="truncated" title="${row.solicitante}">${row.solicitante}</td>
            <td style="${tipoCor}">${row.tipoContato}</td>
            <td style="${origemCor}">${row.origemContato}</td>
        `;
        
        tr.addEventListener('click', () => {
            if (CHART_FILTERS['Table Row'] === row.uid) {
                CHART_FILTERS['Table Row'] = null;
                tr.classList.remove('active-filter');
                showToast('Filtro de linha específica removido', 'info');
            } else {
                CHART_FILTERS['Table Row'] = row.uid;
                document.querySelectorAll('#dataTable tr.active-filter').forEach(r => {
                    r.classList.remove('active-filter');
                });
                tr.classList.add('active-filter');
                showToast(`Filtrando por caso específico`, 'success');
            }
            applyAllFilters();
        });
        
        if (CHART_FILTERS['Table Row'] === row.uid) {
            tr.classList.add('active-filter');
        }
        
        tbody.appendChild(tr);
    });
    
    document.querySelectorAll('#dataTable th .sort-indicator').forEach(el => el.innerHTML = '');
    const activeHeader = document.querySelector(`#dataTable th[data-key="${CURRENT_SORT.key}"] .sort-indicator`);
    if(activeHeader) activeHeader.innerHTML = CURRENT_SORT.direction === 'asc' ? '▲' : '▼';
}

function sortTable(key) {
    if (CURRENT_SORT.key === key) {
        CURRENT_SORT.direction = CURRENT_SORT.direction === 'asc' ? 'desc' : 'asc';
    } else {
        CURRENT_SORT.key = key;
        CURRENT_SORT.direction = 'asc';
    }
    
    document.querySelectorAll('#dataTable th .sort-indicator').forEach(el => {
        el.innerHTML = '';
    });
    
    const activeHeader = document.querySelector(`#dataTable th[data-key="${key}"] .sort-indicator`);
    if (activeHeader) {
        activeHeader.innerHTML = CURRENT_SORT.direction === 'asc' ? '▲' : '▼';
    }
    
    renderTable();
}

function changePage(delta) {
    CURRENT_PAGE += delta;
    renderTable();
}

function handleDatePreset() {
    CHART_FILTERS['Evo Date'] = null;
    
    const val = $('datePreset').value;
    const today = new Date();
    let start = new Date();
    
    if(!val) return;
    
    switch(val) {
        case 'last7': start.setDate(today.getDate()-7); break;
        case 'last30': start.setDate(today.getDate()-30); break;
        case 'currentMonth': start = new Date(today.getFullYear(), today.getMonth(), 1); break;
        case 'lastMonth':
            start = new Date(today.getFullYear(), today.getMonth()-1, 1);
            today.setDate(0);
            break;
        case 'currentYear': start = new Date(today.getFullYear(), 0, 1); break;
        case 'fullRange':
            $('dateStart').value = '';
            $('dateEnd').value = '';
            applyAllFilters();
            return;
    }
    
    $('dateStart').value = start.toISOString().split('T')[0];
    $('dateEnd').value = new Date().toISOString().split('T')[0];
    applyAllFilters();
}

function updateActiveFiltersDisplay() {
    const container = $('activeFilters');
    container.innerHTML = '';
    
    const addTag = (label, onClick, color) => {
        const tag = document.createElement('div');
        tag.className = 'filter-tag';
        tag.innerHTML = `${label} <i class="fa-solid fa-xmark"></i>`;
        if (color) tag.style.background = color;
        tag.onclick = onClick;
        container.appendChild(tag);
    };
    
    if($('qSearch').value) addTag(`Busca: "${$('qSearch').value}"`, () => { $('qSearch').value=''; applyAllFilters(); });
    if($('motivoSelect').value) addTag(`Motivo: ${$('motivoSelect').value}`, () => { $('motivoSelect').value=''; applyAllFilters(); });
    if($('analistaSelect').value) addTag(`Analista: ${$('analistaSelect').value}`, () => { $('analistaSelect').value=''; applyAllFilters(); });
    if($('subSelect').value) addTag(`Subclasse: ${$('subSelect').value}`, () => { $('subSelect').value=''; applyAllFilters(); });
    if($('tipoContatoSelect').value) addTag(`Tipo: ${$('tipoContatoSelect').value}`, () => { $('tipoContatoSelect').value=''; applyAllFilters(); });
    
    if(CHART_FILTERS['Status']) {
        const color = CHART_FILTERS['Status'] === 'Aberto' ? 'var(--gradient-warning)' : 'var(--gradient-success)';
        addTag(`Status: ${CHART_FILTERS['Status']}`, () => { $('kpiTotal').click(); }, color);
    }
    
    if(CHART_FILTERS['FCR_Sim']) {
        addTag(`FCR: Sim`, () => { CHART_FILTERS['FCR_Sim'] = null; $('kpiTotal').click(); });
    }
    
    if(CHART_FILTERS['AvgTime']) {
        addTag(`Tempo Médio: Ativo`, () => { CHART_FILTERS['AvgTime'] = null; $('kpiTotal').click(); }, 'var(--gradient-purple)');
    }
    
    if(CHART_FILTERS['Doughnut Selection']['Analista']) {
        addTag(`Analista: ${CHART_FILTERS['Doughnut Selection']['Analista']}`, () => { delete CHART_FILTERS['Doughnut Selection']['Analista']; $('analistaSelect').value=''; applyAllFilters(); });
    }
    
    if(CHART_FILTERS['Evo Date']) {
        addTag(`Data: ${moment(CHART_FILTERS['Evo Date']).format('DD/MM/YYYY')}`, () => { 
            CHART_FILTERS['Evo Date'] = null;
            if ($('dateStart').value === CHART_FILTERS['Evo Date'] && $('dateEnd').value === CHART_FILTERS['Evo Date']) {
                $('dateStart').value = '';
                $('dateEnd').value = '';
            }
            applyAllFilters(); 
        }, 'var(--gradient-primary)');
    } else if($('dateStart').value || $('dateEnd').value) {
        const dateLabel = `${$('dateStart').value ? moment($('dateStart').value).format('DD/MM/YYYY') : 'Início'} a ${$('dateEnd').value ? moment($('dateEnd').value).format('DD/MM/YYYY') : 'Fim'}`;
        addTag(`Período: ${dateLabel}`, () => {
            $('dateStart').value = '';
            $('dateEnd').value = '';
            $('datePreset').value = '';
            CHART_FILTERS['Evo Date'] = null;
            applyAllFilters();
        });
    } else if($('datePreset').value) {
        const presetText = $('datePreset').options[$('datePreset').selectedIndex].text;
        addTag(`Período: ${presetText}`, () => {
            $('datePreset').value = '';
            CHART_FILTERS['Evo Date'] = null;
            applyAllFilters();
        });
    }
    
    if(CHART_FILTERS['Origem']) {
        addTag(`Origem: ${CHART_FILTERS['Origem']}`, () => {
            CHART_FILTERS['Origem'] = null;
            applyAllFilters();
        });
    }
    
    if(CHART_FILTERS['GN']) {
        addTag(`GN: ${CHART_FILTERS['GN']}`, () => {
            CHART_FILTERS['GN'] = null;
            applyAllFilters();
        });
    }
    
    if(CHART_FILTERS['CnpjCount']) {
        addTag(`CNPJ Únicos: Sim`, () => {
            CHART_FILTERS['CnpjCount'] = null;
            applyAllFilters();
        }, 'var(--gradient-primary)');
    }
    
    if(CHART_FILTERS['TopMotivo']) {
        addTag(`Motivo Mais: ${CHART_FILTERS['TopMotivo']}`, () => {
            CHART_FILTERS['TopMotivo'] = null;
            applyAllFilters();
        }, 'var(--gradient-warning)');
    }
}

function clearAllFilters() {
    $('qSearch').value = '';
    $('motivoSelect').value = '';
    $('analistaSelect').value = '';
    $('subSelect').value = '';
    $('tipoContatoSelect').value = '';
    $('dateStart').value = '';
    $('dateEnd').value = '';
    $('datePreset').value = '';
    
    CHART_FILTERS = {
        'Table Row': null,
        'Evo Date': null,
        'Status': null,
        'FCR_Sim': null,
        'Date Preset': null,
        'Doughnut Selection': {},
        'Motivo': null,
        'Analista': null,
        'Subclassificação': null,
        'TipoContato': null,
        'AvgTime': null,
        'Origem': null,
        'GN': null,
        'CnpjCount': null,
        'TopMotivo': null
    };
    
    CURRENT_SORT = { key: 'dtStart', direction: 'desc' };
    CURRENT_PAGE = 1;
    applyAllFilters();
    showToast('Todos os filtros foram limpos', 'info');
}

function generateGamification() {
    const board = $('gamificationBoard');
    const counts = {};
    FILTERED.forEach(d => counts[d.analista] = (counts[d.analista]||0)+1);
    const sorted = Object.entries(counts).sort((a,b)=>b[1]-a[1]).slice(0, 10);
    
    if(sorted.length === 0) {
        board.innerHTML = '<div style="padding:15px;text-align:center;color:var(--text-muted)">Sem dados para exibir o ranking</div>';
        return;
    }
    
    let html = '<div style="max-height:300px;overflow-y:auto;">';
    const maxCount = sorted[0][1];
    
    sorted.forEach((item, index) => {
        const medal = index === 0 ? '🥇' : (index === 1 ? '🥈' : (index === 2 ? '🥉' : ''));
        const percentage = maxCount > 0 ? Math.round((item[1]/maxCount)*100) : 0;
        const barWidth = Math.max(20, percentage);
        
        html += `
            <div style="display:flex;align-items:center;padding:12px 15px;border-bottom:1px solid var(--border-light);transition:var(--transition-fast);cursor:pointer;"
                 onclick="filterByChartSegment('Analista', '${item[0]}')">
                <div style="font-weight:900;color:var(--brand-blue);width:25px;font-size:14px;">${index+1}</div>
                <div style="flex:1;margin-left:10px;">
                    <div style="font-weight:700;font-size:13px">${item[0]} ${medal}</div>
                    <div style="font-size:11px;color:var(--text-secondary)">${item[1]} solicitações</div>
                </div>
                <div style="width:80px;height:6px;background:rgba(255, 255, 255, 0.05);border-radius:3px;overflow:hidden;margin-left:10px;">
                    <div style="width:${barWidth}%;height:100%;background:var(--gradient-primary);transition:width 0.5s;"></div>
                </div>
                <div style="font-weight:700;color:var(--brand-blue);margin-left:10px;font-size:12px;">${item[1]}</div>
            </div>`;
    });
    
    html += '</div>';
    board.innerHTML = html;
}

function filterByChartSegment(filterKey, filterValue) {
    if (filterKey === 'Analista') {
        if(CHART_FILTERS['Doughnut Selection']['Analista'] === filterValue) {
            delete CHART_FILTERS['Doughnut Selection']['Analista'];
            $('analistaSelect').value = '';
            showToast(`Filtro do analista "${filterValue}" removido`, 'info');
        } else {
            CHART_FILTERS['Doughnut Selection']['Analista'] = filterValue;
            $('analistaSelect').value = filterValue;
            showToast(`Filtrando por analista: ${filterValue}`, 'success');
        }
        applyAllFilters();
    }
}

function showLoading(show, text) {
    $('loading').style.display = show ? 'flex' : 'none';
    if(text) $('loadingText').innerText = text;
    if (!show) {
        resetLoadingProgress();
    }
}

function showToast(msg, type) {
    document.querySelectorAll('.toast').forEach(t => t.remove());
    const t = document.createElement('div');
    t.className = `toast ${type}`;
    t.style.cssText = `
        position: fixed; top: 100px; right: 30px;
        background: linear-gradient(135deg, #1A1B2E 0%, #12131F 100%);
        color: white; padding: 16px 20px; border-radius: var(--radius-md);
        box-shadow: var(--shadow-xl); z-index: 3000; display: flex; align-items: center; gap: 12px;
        transform: translateX(400px); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); max-width: 350px;
        backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.1);
        border-left: 4px solid ${type === 'success' ? SUCCESS_GREEN : type === 'error' ? 'var(--error-red)' : type === 'info' ? BRAND_BLUE : type === 'warning' ? 'var(--warning)' : PURPLE};
    `;
    
    const icon = type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : type === 'info' ? 'fa-info-circle' : type === 'warning' ? 'fa-lightbulb' : 'fa-hourglass-half';
    
    t.innerHTML = `<i class="fa-solid ${icon}" style="font-size:20px;"></i><div style="flex:1;font-weight:600;font-size:13px;">${msg}</div>`;
    document.body.appendChild(t);
    
    setTimeout(() => t.style.transform = 'translateX(0)', 10);
    setTimeout(() => { t.style.transform = 'translateX(400px)'; setTimeout(() => t.remove(), 300); }, 4000);
}

function addRippleEffect(e) {
    const btn = e.currentTarget;
    const circle = document.createElement('span');
    const d = Math.max(btn.clientWidth, btn.clientHeight);
    const rect = btn.getBoundingClientRect();
    
    circle.style.width = circle.style.height = d + 'px';
    circle.style.left = e.clientX - rect.left - d/2 + 'px';
    circle.style.top = e.clientY - rect.top - d/2 + 'px';
    circle.style.position = 'absolute';
    circle.style.borderRadius = '50%';
    circle.style.backgroundColor = 'rgba(255, 255, 255, 0.7)';
    circle.style.transform = 'scale(0)';
    circle.style.animation = 'ripple 0.6s linear';
    circle.style.pointerEvents = 'none';
    
    btn.style.overflow = 'hidden';
    btn.style.position = 'relative';
    btn.appendChild(circle);
    
    setTimeout(()=>{
        circle.remove();
        btn.style.overflow = '';
    }, 600);
}

// ===== NOVAS FUNÇÕES PARA ANÁLISE POR MOTIVO =====
function loadMotivoAnalytics() {
    if (!RAW.length) {
        showToast('Carregue os dados primeiro', 'warning');
        return;
    }
    
    const motivoGroups = {};
    
    RAW.forEach(item => {
        const motivo = item.motivo || 'Não Informado';
        
        if (!motivoGroups[motivo]) {
            motivoGroups[motivo] = {
                motivo: motivo,
                total: 0,
                abertos: 0,
                fechados: 0,
                fcrSim: 0,
                fcrNao: 0,
                temposResolucao: [],
                analistas: new Set(),
                tiposContato: new Set(),
                origens: new Set(),
                registros: []
            };
        }
        
        const grupo = motivoGroups[motivo];
        grupo.total++;
        grupo.registros.push(item);
        
        if (item.statusNorm === 'Aberto') {
            grupo.abertos++;
        } else {
            grupo.fechados++;
        }
        
        if (item.fcr === 'Sim') grupo.fcrSim++;
        else if (item.fcr === 'Não') grupo.fcrNao++;
        
        if (item.tempoResolucaoHoras !== null) {
            grupo.temposResolucao.push(item.tempoResolucaoHoras);
        }
        
        if (item.analista) grupo.analistas.add(item.analista);
        if (item.tipoContato) grupo.tiposContato.add(item.tipoContato);
        if (item.origemContato) grupo.origens.add(item.origemContato);
    });
    
    motivoAnalyticsData = Object.values(motivoGroups).map(grupo => {
        const fcrPerc = grupo.fechados > 0 ? (grupo.fcrSim / grupo.fechados * 100) : 0;
        
        let tmrHoras = 0;
        if (grupo.temposResolucao.length > 0) {
            tmrHoras = grupo.temposResolucao.reduce((a, b) => a + b, 0) / grupo.temposResolucao.length;
        }
        
        return {
            ...grupo,
            fcrPercentual: fcrPerc.toFixed(1),
            tmrHoras: tmrHoras.toFixed(1),
            tmrDias: (tmrHoras / 24).toFixed(1),
            analistasCount: grupo.analistas.size,
            tiposContatoList: Array.from(grupo.tiposContato).join(', '),
            origensList: Array.from(grupo.origens).join(', ')
        };
    });
    
    renderMotivoTable();
    loadMotivoStats();
    populateMotivoSelects();
    loadAnalistaMotivoData();
    loadTMRData();
}

function renderMotivoTable() {
    const tbody = $('motivoTableBody');
    const searchTerm = ($('motivoSearch') || {value: ''}).value.toLowerCase();
    
    let filteredData = [...motivoAnalyticsData];
    if (searchTerm) {
        filteredData = filteredData.filter(item => 
            item.motivo.toLowerCase().includes(searchTerm)
        );
    }
    
    filteredData.sort((a, b) => {
        const valA = a[currentMotivoSort.key];
        const valB = b[currentMotivoSort.key];
        
        if (currentMotivoSort.key === 'tmr') {
            const numA = parseFloat(a.tmrDias) || 0;
            const numB = parseFloat(b.tmrDias) || 0;
            return currentMotivoSort.direction === 'asc' ? numA - numB : numB - numA;
        } else if (currentMotivoSort.key === 'fcr') {
            const numA = parseFloat(a.fcrPercentual) || 0;
            const numB = parseFloat(b.fcrPercentual) || 0;
            return currentMotivoSort.direction === 'asc' ? numA - numB : numB - numA;
        } else if (currentMotivoSort.key === 'total' || currentMotivoSort.key === 'abertos' || currentMotivoSort.key === 'fechados' || currentMotivoSort.key === 'analistas') {
            return currentMotivoSort.direction === 'asc' ? valA - valB : valB - valA;
        }
        
        if (typeof valA === 'string') return currentMotivoSort.direction === 'asc' 
            ? valA.localeCompare(valB) 
            : valB.localeCompare(valA);
        
        return currentMotivoSort.direction === 'asc' ? valA - valB : valB - valA;
    });
    
    tbody.innerHTML = '';
    
    filteredData.forEach((item, index) => {
        const tr = document.createElement('tr');
        
        const fcrColor = item.fcrPercentual >= 80 ? 'color:var(--success-green);' 
            : item.fcrPercentual >= 60 ? 'color:var(--brand-orange);' 
            : 'color:var(--error-red);';
            
        const tmrColor = parseFloat(item.tmrDias) > 2.0 ? 'color:var(--error-red);' 
            : parseFloat(item.tmrDias) > 1.0 ? 'color:var(--brand-orange);' 
            : 'color:var(--success-green);';
        
        tr.innerHTML = `
            <td><strong>${item.motivo}</strong></td>
            <td><span class="status-pill" style="background:var(--gradient-primary)">${item.total}</span></td>
            <td><span class="status-pill" style="background:var(--gradient-warning)">${item.abertos}</span></td>
            <td><span class="status-pill" style="background:var(--gradient-success)">${item.fechados}</span></td>
            <td style="${fcrColor}; font-weight: 600;">${item.fcrPercentual}%</td>
            <td style="${tmrColor}; font-weight: 600;">${item.tmrDias}d</td>
            <td>${item.analistasCount} analista(s)</td>
            <td class="truncated" title="${item.tiposContatoList}">${item.tiposContatoList}</td>
            <td>
                <button onclick="drillDownMotivo('${item.motivo}')" class="btn btn-sm" style="padding: 4px 8px; font-size: 11px;">
                    <i class="fa-solid fa-magnifying-glass"></i> Detalhar
                </button>
            </td>
        `;
        
        tr.addEventListener('click', (e) => {
            if (!e.target.closest('button')) {
                drillDownMotivo(item.motivo);
            }
        });
        
        tbody.appendChild(tr);
    });
}

function sortMotivoTable(key) {
    if (currentMotivoSort.key === key) {
        currentMotivoSort.direction = currentMotivoSort.direction === 'asc' ? 'desc' : 'asc';
    } else {
        currentMotivoSort.key = key;
        currentMotivoSort.direction = 'desc';
    }
    
    renderMotivoTable();
}

function loadMotivoStats() {
    if (!motivoAnalyticsData) return;
    
    const totalRegistros = motivoAnalyticsData.reduce((sum, item) => sum + item.total, 0);
    const totalMotivos = motivoAnalyticsData.length;
    const mediaPorMotivo = (totalRegistros / totalMotivos).toFixed(1);
    
    const melhorFCR = motivoAnalyticsData.reduce((best, current) => 
        parseFloat(current.fcrPercentual) > parseFloat(best.fcrPercentual) ? current : best
    );
    
    const maisFrequente = motivoAnalyticsData.reduce((most, current) => 
        current.total > most.total ? current : most
    );
    
    $('motivoStats').innerHTML = `
        <div style="margin-bottom: 8px;">
            <span style="color: var(--text-secondary);">Total de Motivos Únicos:</span>
            <span style="font-weight: 600; color: var(--brand-blue); margin-left: 8px;">${totalMotivos}</span>
        </div>
        <div style="margin-bottom: 8px;">
            <span style="color: var(--text-secondary);">Registros Totais:</span>
            <span style="font-weight: 600; color: var(--brand-blue); margin-left: 8px;">${totalRegistros}</span>
        </div>
        <div style="margin-bottom: 8px;">
            <span style="color: var(--text-secondary);">Média por Motivo:</span>
            <span style="font-weight: 600; color: var(--brand-blue); margin-left: 8px;">${mediaPorMotivo}</span>
        </div>
        <div style="margin-bottom: 8px;">
            <span style="color: var(--text-secondary);">Melhor FCR:</span>
            <span style="font-weight: 600; color: var(--success-green); margin-left: 8px;">
                ${melhorFCR.fcrPercentual}% (${melhorFCR.motivo})
            </span>
        </div>
    `;
    
    const top5 = [...motivoAnalyticsData]
        .sort((a, b) => b.total - a.total)
        .slice(0, 5);
    
    let top5HTML = '';
    top5.forEach((item, index) => {
        const medal = index === 0 ? '🥇' : index === 1 ? '🥈' : index === 2 ? '🥉' : `${index + 1}.`;
        top5HTML += `
            <div style="display: flex; justify-content: space-between; align-items: center; 
                        padding: 8px 0; border-bottom: 1px solid var(--border-light);">
                <span>${medal} ${item.motivo}</span>
                <span style="font-weight: 600; color: var(--brand-blue);">${item.total}</span>
            </div>
        `;
    });
    
    $('topMotivos').innerHTML = top5HTML;
}

function populateMotivoSelects() {
    const selectAnalista = $('analistaFilterMotivo');
    const selectEvolucao = $('motivoEvolucaoSelect');
    
    selectAnalista.innerHTML = '<option value="">Todos os Motivos</option>';
    selectEvolucao.innerHTML = '<option value="">Selecione um motivo</option>';
    
    motivoAnalyticsData.sort((a, b) => a.motivo.localeCompare(b.motivo)).forEach(item => {
        const option1 = document.createElement('option');
        option1.value = item.motivo;
        option1.textContent = item.motivo;
        selectAnalista.appendChild(option1.cloneNode(true));
        
        const option2 = option1.cloneNode(true);
        selectEvolucao.appendChild(option2);
    });
}

function loadAnalistaMotivoData() {
    const motivoSelecionado = $('analistaFilterMotivo').value;
    const filteredData = motivoSelecionado 
        ? RAW.filter(item => item.motivo === motivoSelecionado)
        : RAW;
    
    const analistaGroups = {};
    
    filteredData.forEach(item => {
        const analista = item.analista || 'Não Atribuído';
        
        if (!analistaGroups[analista]) {
            analistaGroups[analista] = {
                analista: analista,
                total: 0,
                abertos: 0,
                fechados: 0,
                fcrSim: 0,
                temposResolucao: [],
                motivos: new Set(),
                origens: {}
            };
        }
        
        const grupo = analistaGroups[analista];
        grupo.total++;
        grupo.motivos.add(item.motivo);
        
        if (item.statusNorm === 'Aberto') {
            grupo.abertos++;
        } else {
            grupo.fechados++;
        }
        
        if (item.fcr === 'Sim') grupo.fcrSim++;
        
        if (item.tempoResolucaoHoras !== null) {
            grupo.temposResolucao.push(item.tempoResolucaoHoras);
        }
        
        const origem = item.origemContato || 'Não Informado';
        grupo.origens[origem] = (grupo.origens[origem] || 0) + 1;
    });
    
    const analistaData = Object.values(analistaGroups).map(grupo => {
        const fcrPerc = grupo.fechados > 0 ? (grupo.fcrSim / grupo.fechados * 100) : 0;
        
        let tmrHoras = 0;
        if (grupo.temposResolucao.length > 0) {
            tmrHoras = grupo.temposResolucao.reduce((a, b) => a + b, 0) / grupo.temposResolucao.length;
        }
        
        let origemPrincipal = '-';
        let maxCount = 0;
        Object.entries(grupo.origens).forEach(([origem, count]) => {
            if (count > maxCount) {
                maxCount = count;
                origemPrincipal = origem;
            }
        });
        
        return {
            ...grupo,
            fcrPercentual: fcrPerc.toFixed(1),
            tmrDias: (tmrHoras / 24).toFixed(1),
            motivosCount: grupo.motivos.size,
            origemPrincipal: origemPrincipal
        };
    });
    
    const tbody = $('analistaMotivoTable');
    tbody.innerHTML = '';
    
    analistaData.sort((a, b) => b.total - a.total).forEach(item => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td><strong>${item.analista}</strong></td>
            <td>${item.motivosCount}</td>
            <td>${item.total}</td>
            <td>${item.abertos}</td>
            <td>${item.fechados}</td>
            <td>${item.fcrPercentual}%</td>
            <td>${item.tmrDias}d</td>
            <td>${item.origemPrincipal}</td>
        `;
        tbody.appendChild(tr);
    });
    
    updateAnalistaCharts(analistaData);
}

function updateAnalistaCharts(data) {
    const ctx1 = $('chartAnalistaVolume').getContext('2d');
    if (motivoCharts.analistaVolumeChart) motivoCharts.analistaVolumeChart.destroy();
    
    const sortedData = [...data].sort((a, b) => b.total - a.total).slice(0, 10);
    
    motivoCharts.analistaVolumeChart = new Chart(ctx1, {
        type: 'bar',
        data: {
            labels: sortedData.map(d => d.analista),
            datasets: [{
                label: 'Total de Atendimentos',
                data: sortedData.map(d => d.total),
                backgroundColor: MOTIVO_PALETTE[0],
                borderRadius: 6
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false },
                datalabels: {
                    color: function(context) {
                        const backgroundColor = context.dataset.backgroundColor[context.dataIndex];
                        return getContrastColor(backgroundColor);
                    },
                    anchor: 'end',
                    align: 'top',
                    font: { weight: 'bold', size: 11 },
                    formatter: (value) => value
                }
            }
        },
        plugins: [ChartDataLabels]
    });
    
    const ctx2 = $('chartAnalistaFCR').getContext('2d');
    if (motivoCharts.analistaFCRChart) motivoCharts.analistaFCRChart.destroy();
    
    motivoCharts.analistaFCRChart = new Chart(ctx2, {
        type: 'bar',
        data: {
            labels: sortedData.map(d => d.analista),
            datasets: [{
                label: 'FCR (%)',
                data: sortedData.map(d => parseFloat(d.fcrPercentual)),
                backgroundColor: sortedData.map(d => 
                    parseFloat(d.fcrPercentual) >= 80 ? MOTIVO_PALETTE[6] :
                    parseFloat(d.fcrPercentual) >= 60 ? MOTIVO_PALETTE[9] :
                    MOTIVO_PALETTE[11]
                ),
                borderRadius: 6
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    max: 100,
                    ticks: {
                        callback: value => value + '%'
                    }
                }
            },
            plugins: {
                legend: { display: false },
                datalabels: {
                    color: function(context) {
                        const backgroundColor = context.dataset.backgroundColor[context.dataIndex];
                        return getContrastColor(backgroundColor);
                    },
                    anchor: 'end',
                    align: 'top',
                    font: { weight: 'bold', size: 11 },
                    formatter: (value) => value + '%'
                }
            }
        },
        plugins: [ChartDataLabels]
    });
}

function loadTMRData() {
    if (!motivoAnalyticsData) return;
    
    const motivosComTMR = motivoAnalyticsData
        .filter(item => parseFloat(item.tmrDias) > 0)
        .sort((a, b) => parseFloat(b.tmrDias) - parseFloat(a.tmrDias));
    
    const temposGeral = [];
    motivoAnalyticsData.forEach(item => {
        if (item.temposResolucao && item.temposResolucao.length > 0) {
            temposGeral.push(...item.temposResolucao);
        }
    });
    
    const tmrGeralHoras = temposGeral.length > 0 
        ? (temposGeral.reduce((a, b) => a + b, 0) / temposGeral.length)
        : 0;
    const tmrGeralDias = (tmrGeralHoras / 24).toFixed(1);
    
    $('tmrGeral').textContent = `${tmrGeralDias}d`;
    
    if (motivosComTMR.length > 0) {
        const maisRapido = motivosComTMR[motivosComTMR.length - 1];
        const maisLento = motivosComTMR[0];
        
        $('motivoMaisRapido').textContent = maisRapido.motivo;
        $('tempoMaisRapido').textContent = `${maisRapido.tmrDias} dias`;
        
        $('motivoMaisLento').textContent = maisLento.motivo;
        $('tempoMaisLento').textContent = `${maisLento.tmrDias} dias`;
    }
    
    const ctx = $('chartTMRMotivo').getContext('2d');
    if (motivoCharts.tmrChart) motivoCharts.tmrChart.destroy();
    
    const top15 = motivosComTMR.slice(0, 15);
    
    motivoCharts.tmrChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: top15.map(d => d.motivo.length > 20 ? d.motivo.substring(0, 20) + '...' : d.motivo),
            datasets: [{
                label: 'TMR (dias)',
                data: top15.map(d => parseFloat(d.tmrDias)),
                backgroundColor: top15.map(d => 
                    parseFloat(d.tmrDias) > 2.0 ? MOTIVO_PALETTE[11] :
                    parseFloat(d.tmrDias) > 1.0 ? MOTIVO_PALETTE[9] :
                    MOTIVO_PALETTE[6]
                ),
                borderRadius: 4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: context => `TMR: ${context.parsed.y.toFixed(1)} dias`
                    }
                },
                datalabels: {
                    color: function(context) {
                        const backgroundColor = context.dataset.backgroundColor[context.dataIndex];
                        return getContrastColor(backgroundColor);
                    },
                    anchor: 'end',
                    align: 'top',
                    font: { weight: 'bold', size: 11 },
                    formatter: (value) => value.toFixed(1) + 'd'
                }
            }
        },
        plugins: [ChartDataLabels]
    });
    
    const tbody = $('tmrDetailTable');
    tbody.innerHTML = '';
    
    motivosComTMR.forEach(item => {
        const casosLentos = item.temposResolucao.filter(t => t > 168).length;
        const desvioPadraoHoras = item.temposResolucao.length > 1 
            ? Math.sqrt(item.temposResolucao.reduce((sq, n) => sq + Math.pow(n - parseFloat(item.tmrHoras), 2), 0) / item.temposResolucao.length)
            : 0;
        const desvioPadraoDias = (desvioPadraoHoras / 24).toFixed(1);
        
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${item.motivo}</td>
            <td>${item.fechados}</td>
            <td>${item.tmrDias}</td>
            <td>${desvioPadraoDias}d</td>
            <td>${casosLentos}</td>
        `;
        tbody.appendChild(tr);
    });
}

function drillDownMotivo(motivo) {
    $('motivoSearch').value = motivo;
    renderMotivoTable();
    switchAutomationTab('distribuicao');
    showToast(`Filtrando por motivo: ${motivo}`, 'success');
}

function switchAutomationTab(tabName) {
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    
    document.querySelectorAll('.tab-pane').forEach(pane => {
        pane.classList.remove('active');
    });
    
    document.querySelector(`.tab-btn[data-tab="${tabName}"]`)?.classList.add('active');
    $(`tab-${tabName}`)?.classList.add('active');
    
    if (tabName === 'evolucao') {
        
        updateEvolucaoChart();
    }
}

function updateEvolucaoChart() {
    const motivoSelecionado = $('motivoEvolucaoSelect').value;
    const periodoSelecionado = $('periodoEvolucao').value;
    
    if (!motivoSelecionado) {
        $('tendenciaDiaria').innerHTML = 'Selecione um motivo para visualizar a evolução';
        $('picoOcorrencias').innerHTML = 'Selecione um motivo para visualizar os picos';
        return;
    }
    
    const dadosMotivo = RAW.filter(item => item.motivo === motivoSelecionado);
    
    const dadosPorData = {};
    dadosMotivo.forEach(item => {
        if (!item.dtStart) return;
        const dataKey = moment(item.dtStart).format('YYYY-MM-DD');
        if (!dadosPorData[dataKey]) {
            dadosPorData[dataKey] = { total: 0, concluidos: 0 };
        }
        dadosPorData[dataKey].total++;
        if (item.statusNorm === 'Fechado') {
            dadosPorData[dataKey].concluidos++;
        }
    });
    
    const datas = Object.keys(dadosPorData).sort();
    
    let datasFiltradas = datas;
    if (periodoSelecionado !== 'all') {
        const dias = parseInt(periodoSelecionado);
        const dataLimite = moment().subtract(dias, 'days').format('YYYY-MM-DD');
        datasFiltradas = datas.filter(d => d >= dataLimite);
    }
    
    const labels = datasFiltradas;
    const totais = datasFiltradas.map(d => dadosPorData[d].total);
    const concluidos = datasFiltradas.map(d => dadosPorData[d].concluidos);
    
    const ctx = $('chartEvolucaoMotivo').getContext('2d');
    if (motivoCharts.evolucaoChart) motivoCharts.evolucaoChart.destroy();
    
    motivoCharts.evolucaoChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [
                {
                    label: 'Total',
                    data: totais,
                    borderColor: MOTIVO_PALETTE[0],
                    backgroundColor: 'rgba(0, 69, 181, 0.1)',
                    fill: true,
                    tension: 0.4
                },
                {
                    label: 'Concluídos',
                    data: concluidos,
                    borderColor: MOTIVO_PALETTE[6],
                    backgroundColor: 'transparent',
                    borderDash: [5, 5],
                    tension: 0.4
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top'
                }
            },
            scales: {
                x: {
                    grid: { display: false }
                },
                y: {
                    beginAtZero: true,
                    ticks: { stepSize: 1 }
                }
            }
        }
    });
    
    const totalPeriodo = totais.reduce((a, b) => a + b, 0);
    const mediaDiaria = (totalPeriodo / labels.length).toFixed(1);
    const maiorDia = Math.max(...totais);
    const indiceMaiorDia = totais.indexOf(maiorDia);
    const dataMaiorDia = labels[indiceMaiorDia];
    
    $('tendenciaDiaria').innerHTML = `
        <div style="margin-bottom: 5px;">
            <span style="color: var(--text-secondary);">Média diária:</span>
            <span style="font-weight: 600; color: var(--brand-blue); margin-left: 5px;">${mediaDiaria} ocorrências/dia</span>
        </div>
        <div>
            <span style="color: var(--text-secondary);">Total no período:</span>
            <span style="font-weight: 600; color: var(--brand-blue); margin-left: 5px;">${totalPeriodo} ocorrências</span>
        </div>
    `;
    
    $('picoOcorrencias').innerHTML = `
        <div style="margin-bottom: 5px;">
            <span style="color: var(--text-secondary);">Pico:</span>
            <span style="font-weight: 600; color: var(--brand-orange); margin-left: 5px;">${maiorDia} ocorrências</span>
        </div>
        <div>
            <span style="color: var(--text-secondary);">Data do pico:</span>
            <span style="font-weight: 600; color: var(--brand-blue); margin-left: 5px;">${moment(dataMaiorDia).format('DD/MM/YYYY')}</span>
        </div>
    `;
}

// ===== FUNÇÕES ADICIONAIS =====
function toggleFullScreen() {
    if (!document.fullscreenElement) {
        document.documentElement.requestFullscreen().catch(err => {
            console.error(`Erro ao ativar tela cheia: ${err.message}`);
        });
    } else {
        if (document.exitFullscreen) {
            document.exitFullscreen();
        }
    }
}

function downloadChart(chartId, filename) {
    const chartCanvas = $(chartId);
    const link = document.createElement('a');
    link.download = filename;
    link.href = chartCanvas.toDataURL('image/png');
    link.click();
}

function exportCSV() {
    if (FILTERED.length === 0) {
        showToast('Não há dados para exportar', 'warning');
        return;
    }
    
    const headers = ['Status', 'Data Início', 'Data Fim', 'Tempo Resolução', 'FCR', 'Analista', 'Motivo', 'Sub Classificação', 'Razão Social', 'Tipo Atendimento', 'Origem Contato'];
    
    const csvContent = [
        headers.join(','),
        ...FILTERED.map(row => [
            row.status,
            row.dtStart ? moment(row.dtStart).format('DD/MM/YYYY') : '',
            row.dtEnd ? moment(row.dtEnd).format('DD/MM/YYYY') : '',
            row.tempoResolucaoFormatado,
            row.fcr,
            `"${row.analista}"`,
            `"${normalizarMotivo(row.motivo)}"`,
            `"${row.sub}"`,
            `"${row.solicitante}"`,
            row.tipoContato,
            row.origemContato
        ].join(','))
    ].join('\n');
    
    const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `dados_hub_${moment().format('YYYY-MM-DD_HH-mm')}.csv`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    showToast('CSV exportado com sucesso!', 'success');
}

function exportMotivoCSV() {
    if (!motivoAnalyticsData) {
        showToast('Carregue os dados de motivo primeiro', 'warning');
        return;
    }
    
    const headers = ['Motivo', 'Total', 'Em Aberto', 'Concluídos', 'FCR (%)', 'TMR (horas)', 'Nº Analistas', 'Tipos de Contato', 'Origens'];
    
    const csvContent = [
        headers.join(','),
        ...motivoAnalyticsData.map(item => [
            `"${item.motivo}"`,
            item.total,
            item.abertos,
            item.fechados,
            item.fcrPercentual,
            item.tmrHoras,
            item.analistasCount,
            `"${item.tiposContatoList}"`,
            `"${item.origensList}"`
        ].join(','))
    ].join('\n');
    
    const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `analise_motivos_${moment().format('YYYY-MM-DD_HH-mm')}.csv`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    showToast('CSV de motivos exportado com sucesso!', 'success');
}

function toggleTheme() {
    document.body.classList.toggle('light-theme');
    const isLight = document.body.classList.contains('light-theme');
    localStorage.setItem('dashboard-theme', isLight ? 'light' : 'dark');
    showToast(`Tema ${isLight ? 'claro' : 'escuro'} ativado`, 'info');
}

function updateLastUpdateTime() {
    LAST_UPDATE_TIME = new Date();
    $('lastUpdateTime').textContent = moment(LAST_UPDATE_TIME).format('DD/MM/YYYY HH:mm');
}

    // =====================================================
    // FUNÇÃO PARA GERAR RELATÓRIO EXECUTIVO
    // =====================================================
    function generateExecutiveReport() {
        if (!FILTERED || FILTERED.length === 0) {
            showToast('Carregue os dados primeiro antes de gerar o relatório.', 'warning');
            return;
        }

        showToast('Gerando relatório executivo...', 'info');

        // Coletar estatísticas
        const total = FILTERED.length;
        const abertos = FILTERED.filter(i => i.statusNorm === 'Aberto').length;
        const fechados = FILTERED.filter(i => i.statusNorm === 'Fechado').length;
        const fcrSim = FILTERED.filter(i => i.fcr === 'Sim').length;
        const fcrPerc = fechados > 0 ? ((fcrSim / fechados) * 100).toFixed(1) : '0.0';

        // Tempo médio de resolução
        const casosComTempo = FILTERED.filter(i => i.statusNorm === 'Fechado' && i.tempoResolucaoDias !== null);
        const tmrDias = casosComTempo.length > 0 
            ? (casosComTempo.reduce((sum, i) => sum + i.tempoResolucaoDias, 0) / casosComTempo.length).toFixed(1)
            : '0.0';

        // CNPJs únicos
        const cnpjsUnicos = new Set(FILTERED.filter(i => i.cnpj && i.cnpj.trim() !== '').map(i => i.cnpj)).size;

        // Top 5 Motivos
        const motivoCounts = {};
        FILTERED.forEach(item => {
            const motivo = item.motivo || 'Não informado';
            motivoCounts[motivo] = (motivoCounts[motivo] || 0) + 1;
        });
        const topMotivos = Object.entries(motivoCounts)
            .sort((a, b) => b[1] - a[1])
            .slice(0, 5);

        // Top 5 Analistas
        const analistaCounts = {};
        FILTERED.forEach(item => {
            const analista = item.analista || 'Não Atribuído';
            analistaCounts[analista] = (analistaCounts[analista] || 0) + 1;
        });
        const topAnalistas = Object.entries(analistaCounts)
            .sort((a, b) => b[1] - a[1])
            .slice(0, 5);

        // Distribuição por Origem de Contato
        const origemCounts = {};
        FILTERED.forEach(item => {
            const origem = item.origemContato || 'Não Informado';
            origemCounts[origem] = (origemCounts[origem] || 0) + 1;
        });

        // Distribuição por Tipo de Atendimento
        const tipoCounts = {};
        FILTERED.forEach(item => {
            const tipo = item.tipoContato || 'Não Informado';
            tipoCounts[tipo] = (tipoCounts[tipo] || 0) + 1;
        });

        // Período dos dados
        const datas = FILTERED.filter(i => i.dtStart).map(i => i.dtStart);
        const dataMin = datas.length > 0 ? moment(Math.min(...datas)).format('DD/MM/YYYY') : '--';
        const dataMax = datas.length > 0 ? moment(Math.max(...datas)).format('DD/MM/YYYY') : '--';

        // Gerar HTML do relatório
        const reportHTML = `
            <!DOCTYPE html>
            <html lang="pt-BR">
            <head>
                <meta charset="UTF-8">
                <meta name="viewport" content="width=device-width, initial-scale=1.0">
                <title>Relatório Executivo - Torre Mapeamento de Contatos</title>
                <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;800&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
                <style>
                    * { margin: 0; padding: 0; box-sizing: border-box; }
                    body {
                        font-family: 'Inter', sans-serif;
                        background: linear-gradient(135deg, #f8faff 0%, #e8f0ff 100%);
                        color: #1a1b2e;
                        line-height: 1.6;
                        padding: 40px;
                    }
                    .report-container {
                        max-width: 900px;
                        margin: 0 auto;
                        background: white;
                        border-radius: 20px;
                        box-shadow: 0 20px 60px rgba(0,0,0,0.1);
                        overflow: hidden;
                    }
                    .report-header {
                        background: linear-gradient(135deg, #0045B5 0%, #0068FF 100%);
                        color: white;
                        padding: 40px;
                        text-align: center;
                    }
                    .report-header h1 {
                        font-family: 'Montserrat', sans-serif;
                        font-size: 28px;
                        font-weight: 800;
                        margin-bottom: 10px;
                    }
                    .report-header p {
                        opacity: 0.9;
                        font-size: 14px;
                    }
                    .report-content { padding: 40px; }
                    .section {
                        margin-bottom: 30px;
                        padding-bottom: 30px;
                        border-bottom: 1px solid #e8e9ee;
                    }
                    .section:last-child { border-bottom: none; }
                    .section-title {
                        font-family: 'Montserrat', sans-serif;
                        font-size: 18px;
                        font-weight: 700;
                        color: #0045B5;
                        margin-bottom: 20px;
                        display: flex;
                        align-items: center;
                        gap: 10px;
                    }
                    .section-title::before {
                        content: '';
                        width: 4px;
                        height: 24px;
                        background: linear-gradient(180deg, #0045B5, #FFD100);
                        border-radius: 2px;
                    }
                    .kpi-grid {
                        display: grid;
                        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
                        gap: 20px;
                    }
                    .kpi-card {
                        background: linear-gradient(135deg, #f8faff 0%, #fff 100%);
                        border: 1px solid #e8e9ee;
                        border-radius: 12px;
                        padding: 20px;
                        text-align: center;
                    }
                    .kpi-value {
                        font-family: 'Montserrat', sans-serif;
                        font-size: 32px;
                        font-weight: 800;
                        color: #0045B5;
                        line-height: 1;
                    }
                    .kpi-label {
                        font-size: 12px;
                        color: #5a5d72;
                        margin-top: 8px;
                        text-transform: uppercase;
                        letter-spacing: 0.5px;
                    }
                    .list-item {
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        padding: 12px 16px;
                        background: #f8faff;
                        border-radius: 8px;
                        margin-bottom: 8px;
                    }
                    .list-item:last-child { margin-bottom: 0; }
                    .list-name { font-weight: 600; color: #1a1b2e; }
                    .list-value {
                        font-weight: 700;
                        color: #0045B5;
                        background: rgba(0,69,181,0.1);
                        padding: 4px 12px;
                        border-radius: 20px;
                        font-size: 13px;
                    }
                    .report-footer {
                        background: #f8faff;
                        padding: 20px 40px;
                        text-align: center;
                        font-size: 12px;
                        color: #5a5d72;
                        border-top: 1px solid #e8e9ee;
                    }
                    .print-btn {
                        background: linear-gradient(135deg, #0045B5, #0068FF);
                        color: white;
                        border: none;
                        padding: 12px 30px;
                        border-radius: 8px;
                        font-weight: 600;
                        cursor: pointer;
                        margin-top: 20px;
                        font-size: 14px;
                    }
                    .print-btn:hover { opacity: 0.9; }
                    @media print {
                        body { padding: 0; background: white; }
                        .report-container { box-shadow: none; }
                        .print-btn { display: none; }
                    }
                
/* === HOVER EFFECT PARA LEGENDAS DAS ROSCAS === */
.legend-item-highlight {
    background: linear-gradient(135deg, rgba(61, 141, 255, 0.35) 0%, rgba(61, 141, 255, 0.2) 100%) !important;
    transform: translateX(5px) scale(1.03);
    box-shadow: 0 0 15px rgba(61, 141, 255, 0.5), inset 0 0 10px rgba(61, 141, 255, 0.1);
    border-left: 3px solid var(--brand-blue) !important;
    border-radius: 8px !important;
}

.legend-item {
    cursor: pointer;
    transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1) !important;
    border-left: 3px solid transparent;
}

</style>
            </head>
            <body>
                <div class="report-container">
                    <div class="report-header">
                        <h1>📊 Relatório Executivo</h1>
                        <p>Torre Mapeamento de Contatos • Período: ${dataMin} a ${dataMax}</p>
                        <p>Gerado em: ${moment().format('DD/MM/YYYY [às] HH:mm')}</p>
                    </div>
                    <div class="report-content">
                        <div class="section">
                            <div class="section-title">Indicadores Principais</div>
                            <div class="kpi-grid">
                                <div class="kpi-card">
                                    <div class="kpi-value">${total}</div>
                                    <div class="kpi-label">Total Registros</div>
                                </div>
                                <div class="kpi-card">
                                    <div class="kpi-value">${abertos}</div>
                                    <div class="kpi-label">Em Aberto</div>
                                </div>
                                <div class="kpi-card">
                                    <div class="kpi-value">${fechados}</div>
                                    <div class="kpi-label">Concluídos</div>
                                </div>
                                <div class="kpi-card">
                                    <div class="kpi-value">${fcrPerc}%</div>
                                    <div class="kpi-label">FCR</div>
                                </div>
                                <div class="kpi-card">
                                    <div class="kpi-value">${tmrDias}d</div>
                                    <div class="kpi-label">TMR (dias)</div>
                                </div>
                                <div class="kpi-card">
                                    <div class="kpi-value">${cnpjsUnicos}</div>
                                    <div class="kpi-label">CNPJs Únicos</div>
                                </div>
                            </div>
                        </div>

                        <div class="section">
                            <div class="section-title">Top 5 Motivos</div>
                            ${topMotivos.map(([motivo, count], idx) => `
                                <div class="list-item">
                                    <span class="list-name">${idx + 1}. ${motivo}</span>
                                    <span class="list-value">${count} (${((count/total)*100).toFixed(1)}%)</span>
                                </div>
                            `).join('')}
                        </div>

                        <div class="section">
                            <div class="section-title">Top 5 Analistas</div>
                            ${topAnalistas.map(([analista, count], idx) => `
                                <div class="list-item">
                                    <span class="list-name">${idx + 1}. ${analista}</span>
                                    <span class="list-value">${count} atendimentos</span>
                                </div>
                            `).join('')}
                        </div>

                        <div class="section">
                            <div class="section-title">Distribuição por Canal</div>
                            ${Object.entries(origemCounts).sort((a,b) => b[1] - a[1]).map(([origem, count]) => `
                                <div class="list-item">
                                    <span class="list-name">${origem}</span>
                                    <span class="list-value">${count} (${((count/total)*100).toFixed(1)}%)</span>
                                </div>
                            `).join('')}
                        </div>

                        <div class="section">
                            <div class="section-title">Tipo de Atendimento</div>
                            ${Object.entries(tipoCounts).sort((a,b) => b[1] - a[1]).map(([tipo, count]) => `
                                <div class="list-item">
                                    <span class="list-name">${tipo}</span>
                                    <span class="list-value">${count} (${((count/total)*100).toFixed(1)}%)</span>
                                </div>
                            `).join('')}
                        </div>

                        <div style="text-align: center;">
                            <button class="print-btn" onclick="window.print()">🖨️ Imprimir Relatório</button>
                        </div>
                    </div>
                    <div class="report-footer">
                        Dashboard desenvolvido por <strong>Thiago Jr</strong> • Consolidação Torre Mapeamento de Contatos
                    </div>
                </div>
            </body>
            </html>
        `;

        // Abrir em nova janela
        const reportWindow = window.open('', '_blank', 'width=1000,height=800');
        if (reportWindow) {
            reportWindow.document.write(reportHTML);
            reportWindow.document.close();
            showToast('Relatório gerado com sucesso!', 'success');
        } else {
            showToast('Popup bloqueado! Permita popups para este site.', 'error');
        }
    }


// ============ DEMANDA INTERNA ============
let demandaInternaData = [];
let demandaInternaLoaded = false;

async function loadDemandaInterna() {
    try {
        const response = await fetch('https://raw.githubusercontent.com/thiccoipp/Ipp/main/internas.xlsx');
        const arrayBuffer = await response.arrayBuffer();
        const workbook = XLSX.read(arrayBuffer, { type: 'array' });
        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
        demandaInternaData = XLSX.utils.sheet_to_json(firstSheet, { defval: "" });
        demandaInternaLoaded = true;
        console.log('Demandas internas carregadas:', demandaInternaData.length);
        updateDemandaInternaCount();
    } catch (error) {
        console.error('Erro ao carregar demandas internas:', error);
        $('demandaInternaCount').innerText = '--';
    }
}

function updateDemandaInternaCount() {
    if (!demandaInternaLoaded) return;

    // Pegar datas do período atual do dashboard (se filtro existir)
    let count = demandaInternaData.length;

    // Se tiver filtro de período no dashboard, aplicar também às demandas internas
    if (typeof getDateRangeFilter === 'function') {
        const dateRange = getDateRangeFilter();
        if (dateRange && dateRange.start && dateRange.end) {
            count = demandaInternaData.filter(item => {
                let dataInicio = item['Data de início'] || item['Data de inicio'] || item['DataInicio'];
                if (!dataInicio) return true; // Incluir se não tiver data

                let itemDate;
                if (typeof dataInicio === 'number') {
                    itemDate = new Date((dataInicio - 25569) * 86400 * 1000);
                } else {
                    const parts = String(dataInicio).split(' ')[0].split('/');
                    if (parts.length === 3) {
                        let year = parseInt(parts[2]);
                        if (year < 100) year += 2000;
                        itemDate = new Date(year, parseInt(parts[0]) - 1, parseInt(parts[1]));
                    }
                }

                if (!itemDate || isNaN(itemDate)) return true;
                return itemDate >= dateRange.start && itemDate <= dateRange.end;
            }).length;
        }
    }

    $('demandaInternaCount').innerText = count;
}

// Carregar demandas internas após carregamento inicial
setTimeout(loadDemandaInterna, 1000);

        </script>
</body>
</html>