<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>HUB de Atividades Torre de Expans√£o (GitHub Connected) | Dashboard Premium</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700;800;900&family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-moment@1.0.1/dist/chartjs-adapter-moment.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js"></script>

<script>
moment.locale('pt-br', {
  weekdaysShort : ["Dom", "Seg", "Ter", "Qua", "Qui", "Sex", "S√°b"]
});
</script>

<style>
:root {
  --brand-blue: #2E5AA7;
  --brand-blue-light: #4A76C2;
  --brand-blue-dark: #1A3E7A;
  --brand-yellow: #FFC843;
  --brand-yellow-light: #FFDB8A;
  --brand-orange: #FF8A3D;
  --brand-orange-light: #FFA971;
  --success-green: #2E9D64;
  --success-green-light: #5BBF8A;
  --error-red: #D64550;
  --warning: #FFA93D;
  --purple: #8A4CAF;
  --purple-light: #A96CC9;
  --bg: linear-gradient(135deg, #F8FAFF 0%, #F0F7FF 100%);
  --card: #ffffff;
  --card-gradient: linear-gradient(135deg, #ffffff 0%, #fafcff 100%);
  --text: #2C3E50;
  --text-light: #5A6C7D;
  --muted: #7B8793;
  --border: #E8EEF5;
  --border-light: #F0F5FA;
  --border-radius: 16px;
  --border-radius-sm: 10px;
  --border-radius-lg: 20px;
  --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.05);
  --shadow: 0 8px 30px rgba(0, 0, 0, 0.07);
  --shadow-lg: 0 15px 50px rgba(0, 0, 0, 0.09);
  --shadow-xl: 0 20px 60px rgba(0, 0, 0, 0.12);
  --shadow-inset: inset 0 2px 4px rgba(0, 0, 0, 0.02);
  --sidebar-w-collapsed: 80px;
  --sidebar-w-expanded: 320px;
  --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  --transition-fast: all 0.15s cubic-bezier(0.4, 0, 0.2, 1);
  font-family: 'Inter', 'Montserrat', sans-serif;
}

.dark-theme {
  --bg: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
  --card: #0f3460;
  --card-gradient: linear-gradient(135deg, #0f3460 0%, #1a1a2e 100%);
  --text: #e6e6e6;
  --text-light: #b8b8b8;
  --muted: #8a8a8a;
  --border: #1a3e7a;
  --border-light: #2E5AA7;
  --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.2);
  --shadow: 0 8px 30px rgba(0, 0, 0, 0.3);
  --shadow-lg: 0 15px 50px rgba(0, 0, 0, 0.4);
  --shadow-xl: 0 20px 60px rgba(0, 0, 0, 0.5);
  --shadow-inset: inset 0 2px 4px rgba(0, 0, 0, 0.1);
}

* { box-sizing: border-box; margin: 0; padding: 0; }
html { scroll-behavior: smooth; }
body {
  margin: 0; background: var(--bg); color: var(--text); overflow-x: hidden;
  font-family: 'Inter', sans-serif; font-weight: 400; line-height: 1.6;
  -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;
  zoom: 1; min-width: 1000px;
}

.header {
  height: 80px; background: linear-gradient(135deg, var(--brand-blue) 0%, var(--brand-blue-dark) 100%);
  color: #fff; display: flex; align-items: center; justify-content: space-between;
  padding: 0 30px; box-shadow: var(--shadow-lg); z-index: 100; position: relative; overflow: hidden;
}
.header::before {
  content: ''; position: absolute; top: 0; left: 0; right: 0; height: 4px;
  background: linear-gradient(90deg, var(--brand-yellow), var(--brand-orange), var(--brand-yellow-light)); z-index: 1;
}
.header-left { display: flex; align-items: center; gap: 15px; }
.header-logo {
  background: var(--brand-yellow); color: var(--brand-blue); width: 48px; height: 48px; border-radius: 12px;
  display: flex; align-items: center; justify-content: center; font-weight: 900; font-size: 24px;
  box-shadow: 0 4px 12px rgba(255, 200, 67, 0.25); position: relative; overflow: hidden; z-index: 2;
}
.header-logo::after {
  content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0;
  background: linear-gradient(135deg, rgba(255,255,255,0.2) 0%, rgba(255,255,255,0) 100%); z-index: -1;
}
.header-titles { display: flex; flex-direction: column; }
.header-title {
  font-weight: 800; font-size: 20px; letter-spacing: -0.2px;
  background: linear-gradient(90deg, #fff, var(--brand-yellow-light)); -webkit-background-clip: text;
  -webkit-text-fill-color: transparent; background-clip: text;
}
.header-subtitle { font-size: 12px; opacity: 0.85; font-weight: 500; margin-top: 2px; }
.header-right { display: flex; align-items: center; gap: 20px; }
.header-stats { display: flex; gap: 20px; }
.stat-item { display: flex; flex-direction: column; align-items: flex-end; }
.stat-value { font-weight: 700; font-size: 18px; }
.stat-label { font-size: 11px; opacity: 0.8; font-weight: 500; }
.header-actions { display: flex; gap: 10px; }

.dark-theme .header {
  background: linear-gradient(135deg, #1a3e7a 0%, #0f3460 100%);
}

.layout { display: flex; height: calc(100vh - 80px); position: relative; }

.sidebar {
  width: var(--sidebar-w-collapsed); background: linear-gradient(180deg, #ffffff 0%, #f8fafc 100%);
  border-right: 1px solid var(--border); box-shadow: 5px 0 25px rgba(0, 0, 0, 0.05);
  display: flex; flex-direction: column; overflow-x: hidden; overflow-y: auto; z-index: 90; position: relative;
  transition: var(--transition); padding-top: 25px;
}
.sidebar::before { content: ''; position: absolute; top: 0; right: 0; width: 1px; height: 100%;
  background: linear-gradient(to bottom, transparent, var(--border), transparent); }
.sidebar:hover { width: var(--sidebar-w-expanded); box-shadow: 10px 0 40px rgba(0, 0, 0, 0.1); }
.sb-content {
  width: var(--sidebar-w-expanded); padding: 0 24px; opacity: 0; transform: translateX(-15px);
  transition: opacity 0.3s 0.1s, transform 0.3s 0.1s;
}
.sidebar:hover .sb-content { opacity: 1; transform: translateX(0); }
.sb-icons {
  position: absolute; left: 0; top: 25px; width: var(--sidebar-w-collapsed);
  display: flex; flex-direction: column; align-items: center; gap: 30px; pointer-events: none;
}
.sb-icon { font-size: 26px; color: var(--brand-blue); opacity: 0.7; transition: var(--transition-fast); }
.sidebar:hover .sb-icons { opacity: 0; }
.section-title {
  font-size: 13px; text-transform: uppercase; letter-spacing: 1.2px; color: var(--brand-blue); font-weight: 700;
  margin-bottom: 18px; position: relative; padding-bottom: 10px; font-family: 'Montserrat', sans-serif;
}
.section-title::after {
  content: ''; position: absolute; bottom: 0; left: 0; width: 40px; height: 3px;
  background: linear-gradient(90deg, var(--brand-yellow), var(--brand-orange)); border-radius: 3px;
}

.dark-theme .sidebar {
  background: linear-gradient(180deg, #0f3460 0%, #1a1a2e 100%);
  border-right-color: var(--border);
}

.main { flex: 1; padding: 25px 35px 35px; overflow-y: auto; position: relative; scroll-behavior: smooth; }
.main::-webkit-scrollbar { width: 8px; }
.main::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 4px; }
.main::-webkit-scrollbar-thumb { background: var(--brand-blue-light); border-radius: 4px; }
.main::-webkit-scrollbar-thumb:hover { background: var(--brand-blue); }

.context-bar {
  display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; gap: 15px; flex-wrap: wrap;
  padding: 15px 20px; background: var(--card); border-radius: var(--border-radius-sm);
  box-shadow: var(--shadow); border: 1px solid var(--border-light);
}
.context-text { font-size: 13px; color: var(--text-light); font-weight: 500; }
.context-text span {
  font-weight: 700; color: var(--brand-blue); background: rgba(46, 90, 167, 0.08);
  padding: 2px 8px; border-radius: 6px;
}
.context-actions { display: flex; gap: 10px; align-items: center; }
.context-hint {
  font-size: 11px; color: var(--muted); display: flex; align-items: center; gap: 6px; padding: 6px 12px;
  background: rgba(46, 90, 167, 0.05); border-radius: 8px; font-weight: 500;
}
.context-hint i { color: var(--brand-orange); }

.dark-theme .context-bar {
  background: var(--card);
  border-color: var(--border);
}

#activeFilters { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 20px; min-height: 0; padding: 5px 0; }
.filter-tag {
  background: linear-gradient(135deg, var(--brand-blue), var(--brand-blue-light)); color: #fff;
  padding: 8px 16px; border-radius: 50px; font-size: 12px; font-weight: 600; display: inline-flex; align-items: center;
  gap: 8px; box-shadow: 0 4px 12px rgba(46, 90, 167, 0.2); cursor: pointer; transition: var(--transition-fast);
  border: 2px solid transparent;
}
.filter-tag:hover { transform: translateY(-2px); box-shadow: 0 6px 16px rgba(46, 90, 167, 0.3); border-color: rgba(255, 255, 255, 0.3); }
.filter-tag i { font-size: 13px; }
.filter-tag .fa-xmark { margin-left: 4px; color: rgba(255, 255, 255, 0.9); opacity: 0.8; }
.filter-tag .fa-xmark:hover { opacity: 1; }

.btn {
  border: none; border-radius: var(--border-radius-sm); padding: 10px 18px; font-size: 13px; font-weight: 600;
  cursor: pointer; display: inline-flex; align-items: center; gap: 8px; transition: var(--transition);
  font-family: 'Inter', sans-serif; position: relative; overflow: hidden; outline: none;
}
.btn::after {
  content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0;
  background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0) 100%); opacity: 0; transition: opacity 0.3s;
}
.btn:hover::after { opacity: 1; }
.btn-primary {
  background: linear-gradient(135deg, var(--brand-orange) 0%, var(--brand-orange-light) 100%);
  color: #fff; box-shadow: 0 5px 15px rgba(255, 138, 61, 0.3);
}
.btn-primary:hover { transform: translateY(-3px); box-shadow: 0 8px 20px rgba(255, 138, 61, 0.4); }
.btn-secondary {
  background: linear-gradient(135deg, var(--brand-blue) 0%, var(--brand-blue-light) 100%);
  color: #fff; box-shadow: 0 5px 15px rgba(46, 90, 167, 0.25);
}
.btn-secondary:hover { transform: translateY(-3px); box-shadow: 0 8px 20px rgba(46, 90, 167, 0.35); }
.btn-ghost { background: transparent; border: 2px solid var(--border); color: var(--text-light); }
.btn-ghost:hover { background: rgba(46, 90, 167, 0.03); color: var(--brand-blue); border-color: var(--brand-blue-light); }
.btn-icon { width: 40px; height: 40px; padding: 0; justify-content: center; border-radius: 50%; }

.dark-theme .btn-ghost {
  background: rgba(255, 255, 255, 0.05);
  color: var(--text-light);
}

.dark-theme .btn-ghost:hover {
  background: rgba(46, 90, 167, 0.2);
}

.form-control {
  width: 100%; padding: 12px 16px; border: 2px solid var(--border); border-radius: var(--border-radius-sm);
  font-family: inherit; font-size: 13px; margin-bottom: 12px; outline: none; background-color: #fff;
  transition: var(--transition-fast); color: var(--text);
}
.form-control:focus { border-color: var(--brand-blue); box-shadow: 0 0 0 3px rgba(46, 90, 167, 0.15); }
.form-control::placeholder { color: #A0AEC0; }
.select-wrapper { position: relative; margin-bottom: 12px; }
.select-wrapper::after {
  content: '\f078'; font-family: 'Font Awesome 6 Free'; font-weight: 900; position: absolute; right: 16px; top: 50%;
  transform: translateY(-50%); color: var(--muted); pointer-events: none; font-size: 12px;
}
.select-wrapper select { appearance: none; cursor: pointer; padding-right: 40px; }

.dark-theme .form-control {
  background-color: rgba(255, 255, 255, 0.05);
  border-color: var(--border);
  color: var(--text);
}

.kpi-grid {
  display: grid; grid-template-columns: repeat(5, 1fr);
  gap: 18px; margin-bottom: 25px; position: relative; z-index: 10;
  background-color: transparent; padding-bottom: 10px;
}
.kpi-card {
  border-radius: var(--border-radius); padding: 20px; background: var(--card-gradient); box-shadow: var(--shadow);
  border: 1px solid var(--border-light); display: flex; justify-content: space-between; align-items: center;
  cursor: pointer; transition: var(--transition); position: relative; overflow: hidden; min-height: 120px; height: 100%;
}
.kpi-card::before {
  content: ''; position: absolute; top: 0; left: 0; right: 0; height: 4px;
  background: linear-gradient(90deg, var(--brand-blue), var(--brand-blue-light)); opacity: 0; transition: opacity 0.3s;
}
.kpi-card:hover { transform: translateY(-5px); box-shadow: var(--shadow-xl); }
.kpi-card:hover::before { opacity: 1; }
.kpi-card.active-filter { border: 2px solid var(--brand-orange); box-shadow: 0 0 0 4px rgba(255, 138, 61, 0.15); transform: translateY(-3px); }
.kpi-card.active-filter::before { background: linear-gradient(90deg, var(--brand-orange), var(--brand-orange-light)); opacity: 1; }
.kpi-content { display: flex; flex-direction: column; flex: 1; }
.kpi-val {
  font-size: 28px; font-weight: 900; color: var(--brand-blue); line-height: 1; margin-bottom: 6px;
  font-family: 'Montserrat', sans-serif; display: flex; align-items: baseline;
}
.kpi-val .unit { font-size: 16px; font-weight: 600; margin-left: 4px; color: var(--text-light); }
.kpi-lbl { font-size: 12px; color: var(--text-light); font-weight: 600; text-transform: uppercase; letter-spacing: 0.8px; margin-bottom: 4px; }
.kpi-helper { font-size: 10px; color: var(--muted); font-weight: 400; line-height: 1.3; }
.kpi-icon { font-size: 36px; opacity: 0.15; color: var(--brand-blue); margin-left: 15px; }
.kpi-card:hover .kpi-icon { opacity: 0.2; }

.kpi-card.avg-time-card .kpi-val {
  color: #8A4CAF;
}
.kpi-card.avg-time-card .kpi-icon {
  color: #8A4CAF; opacity: 0.2;
}
.kpi-card.avg-time-card:hover .kpi-icon {
  opacity: 0.3;
}
.kpi-card.avg-time-card.active-filter {
  border-color: #8A4CAF;
  box-shadow: 0 0 0 4px rgba(138, 76, 175, 0.15);
}
.kpi-card.avg-time-card.active-filter::before {
  background: linear-gradient(90deg, #8A4CAF, #A96CC9);
}

.dark-theme .kpi-card {
  background: var(--card-gradient);
  border-color: var(--border);
}

.card {
  background: var(--card-gradient); border-radius: var(--border-radius); padding: 24px; box-shadow: var(--shadow);
  border: 1px solid var(--border-light); transition: var(--transition); position: relative; overflow: hidden;
}
.card:hover { box-shadow: var(--shadow-lg); }
.card-header-row {
  display: flex; justify-content: space-between; align-items: flex-start; gap: 15px; margin-bottom: 20px;
}
.card-title {
  margin: 0; font-size: 18px; color: var(--brand-blue); font-weight: 700; display: flex; align-items: center;
  gap: 10px; font-family: 'Montserrat', sans-serif;
}
.card-subtitle { font-size: 13px; color: var(--text-light); margin-top: 5px; font-weight: 500; }

.dark-theme .card {
  background: var(--card-gradient);
  border-color: var(--border);
}

.charts-grid { 
  display: grid; 
  grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); 
  gap: 24px; 
  margin-bottom: 24px; 
}
.chart-container { position: relative; height: 300px; width: 100%; }
.chart-scroll-container { max-height: 340px; overflow-y: auto; height: 300px; padding-right: 5px; }
.chart-scroll-container::-webkit-scrollbar { width: 6px; }
.chart-scroll-container::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 3px; }
.chart-scroll-container::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 3px; }

.doughnut-center-info {
  position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center;
  pointer-events: none; width: 100%;
}
.doughnut-center-name {
  font-size: 15px; font-weight: 700; color: var(--brand-blue); margin-bottom: 5px; white-space: nowrap;
  overflow: hidden; text-overflow: ellipsis; max-width: 80%; margin: 0 auto;
}
.doughnut-center-value { font-size: 24px; font-weight: 900; color: var(--brand-orange); font-family: 'Montserrat', sans-serif; }

.table-container {
  max-height: 400px; overflow: auto; border-radius: var(--border-radius);
  border: 1px solid var(--border); box-shadow: var(--shadow-inset);
}
.table-container::-webkit-scrollbar { width: 8px; height: 8px; }
.table-container::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 4px; }
.table-container::-webkit-scrollbar-thumb { background: var(--brand-blue-light); border-radius: 4px; }
.table-container::-webkit-scrollbar-thumb:hover { background: var(--brand-blue); }
.table {
  width: 100%; border-collapse: separate; border-spacing: 0; font-size: 13px; min-width: 1200px;
}
.table thead {
  background: linear-gradient(135deg, #f8fafc 0%, #edf2f7 100%); position: sticky; top: 0; z-index: 10;
}
.table th {
  color: var(--brand-blue); font-weight: 700; padding: 16px 14px; text-align: left; cursor: pointer; user-select: none;
  border-bottom: 3px solid var(--brand-yellow); font-family: 'Montserrat', sans-serif; font-size: 13px; white-space: nowrap;
  transition: var(--transition-fast);
}
.table th:hover { background: rgba(46, 90, 167, 0.05); }
.table th span.sort-indicator { margin-left: 8px; font-size: 10px; opacity: 0.8; }
.table td { padding: 14px; border-bottom: 1px solid var(--border-light); transition: var(--transition-fast); }
.table tr:nth-child(even) { background-color: #fafbfc; }
.table tr:hover { background-color: #f0f7ff; cursor: pointer; }
.table tr.active-filter { background-color: #fff8e1; box-shadow: inset 0 0 0 2px var(--brand-yellow); }
.table td.filterable { cursor: pointer; }
.status-pill {
  padding: 6px 14px; border-radius: 50px; font-size: 11px; font-weight: 700; text-transform: uppercase; display: inline-block;
  letter-spacing: 0.5px; box-shadow: var(--shadow-sm);
}
.st-fechado { background: linear-gradient(135deg, #D6F0E6 0%, #b8e6d0 100%); color: #27ae60; }
.st-aberto { background: linear-gradient(135deg, #FEF0E1 0%, #fde2c4 100%); color: #e67e22; }
.truncated { max-width: 220px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; cursor: help; }
.table td.icon-cell { font-weight: 600; }
.table td.icon-cell i { font-size: 16px; margin-right: 8px; vertical-align: middle; }

.dark-theme .table thead {
  background: linear-gradient(135deg, #0f3460 0%, #1a1a2e 100%);
}

.dark-theme .table tr:nth-child(even) {
  background-color: rgba(255, 255, 255, 0.05);
}

.dark-theme .table tr:hover {
  background-color: rgba(46, 90, 167, 0.2);
}

.bar-chart-mini-container {
  height: 200px; width: 100%; position: relative; margin-top: 10px;
}

#loading {
  position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255, 255, 255, 0.95);
  display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 9999; backdrop-filter: blur(5px);
}
.loading-content {
  text-align: center; padding: 40px; background: white; border-radius: var(--border-radius);
  box-shadow: var(--shadow-xl); border: 1px solid var(--border-light); max-width: 400px; width: 90%;
}
.loading-spinner {
  width: 60px; height: 60px; border: 4px solid rgba(46, 90, 167, 0.1); border-radius: 50%;
  border-top-color: var(--brand-blue); animation: spin 1s linear infinite; margin: 0 auto 25px;
}
@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
.loading-text { font-size: 16px; font-weight: 600; color: var(--brand-blue); margin-bottom: 10px; }
.loading-subtext { font-size: 13px; color: var(--text-light); }

.dark-theme #loading {
  background: rgba(15, 52, 96, 0.95);
}

.dark-theme .loading-content {
  background: var(--card);
  border-color: var(--border);
}

.tooltip {
  position: absolute; background: rgba(0, 0, 0, 0.85); color: white; padding: 10px 15px; border-radius: 8px; font-size: 12px;
  z-index: 1000; max-width: 300px; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2); pointer-events: none; opacity: 0; transition: opacity 0.2s;
}

:focus-visible { outline: 3px solid var(--brand-orange); outline-offset: 2px; }

@keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
.fade-in { animation: fadeIn 0.5s ease-out forwards; }
@keyframes slideInLeft { from { opacity: 0; transform: translateX(-20px); } to { opacity: 1; transform: translateX(0); } }
.slide-in-left { animation: slideInLeft 0.4s ease-out forwards; }

@media (max-width: 1300px) {
  .kpi-grid { grid-template-columns: repeat(4, 1fr); }
}
@media (max-width: 1200px) {
  .charts-grid { grid-template-columns: 1fr; }
  .kpi-grid { grid-template-columns: repeat(3, 1fr); }
}
@media (max-width: 900px) {
  body { overflow: auto; min-width: auto; }
  .layout { flex-direction: column; height: auto; }
  .sidebar {
    width: 100%; height: auto; order: 2; box-shadow: none; border-right: none; border-top: 1px solid var(--border); padding: 20px;
  }
  .sidebar:hover { width: 100%; box-shadow: none; }
  .sb-icons { display: none; }
  .sb-content { opacity: 1; transform: none; width: 100%; padding: 0; }
  .main { order: 1; padding: 20px 20px 30px; }
  .header { padding: 0 20px; height: 70px; }
  .header-stats { display: none; }
  .kpi-grid { grid-template-columns: repeat(2, 1fr); }
  .card { padding: 20px; }
}
@media (max-width: 600px) {
  .header { flex-direction: column; height: auto; padding: 15px; gap: 15px; }
  .header-left, .header-right { width: 100%; justify-content: center; }
  .header-actions { justify-content: center; }
  .context-bar { flex-direction: column; align-items: flex-start; gap: 15px; }
  .context-actions { width: 100%; justify-content: space-between; }
  .btn { padding: 8px 14px; font-size: 12px; }
  .kpi-grid { grid-template-columns: 1fr; }
  .kpi-card { padding: 16px; }
  .kpi-val { font-size: 24px; }
}
</style>
</head>

<body>
<header class="header">
  <div class="header-left">
    <div class="header-logo">H</div>
    <div class="header-titles">
      <div class="header-title">HUB DE ATIVIDADES | TASKBOARD</div>
      <div class="header-subtitle">Torre de Expans√£o ‚Ä¢ Conectado ao GitHub ‚Ä¢ Dashboard Premium</div>
    </div>
  </div>
  <div class="header-right">
    <div class="header-stats">
      <div class="stat-item">
        <div class="stat-value" id="headerTotal">0</div>
        <div class="stat-label">Total Registros</div>
      </div>
      <div class="stat-item">
        <div class="stat-value" id="headerOpen" style="color:var(--brand-orange)">0</div>
        <div class="stat-label">Em Aberto</div>
      </div>
      <div class="stat-item">
        <div class="stat-value" id="headerClosed" style="color:var(--success-green)">0</div>
        <div class="stat-label">Conclu√≠dos</div>
      </div>
    </div>
    <div class="header-actions">
      <button onclick="exportCSV()" class="btn btn-secondary btn-icon" title="Exportar CSV"><i class="fa-solid fa-file-export"></i></button>
      <button onclick="toggleTheme()" class="btn btn-ghost btn-icon" title="Alternar Tema"><i class="fa-solid fa-moon"></i></button>
      <button onclick="initLoadFromGitHub()" class="btn btn-primary btn-icon" title="Recarregar Dados"><i class="fa-solid fa-rotate"></i></button>
    </div>
  </div>
</header>

<div class="layout">
  <aside class="sidebar" aria-label="Filtros e ranking de analistas">
    <div class="sb-icons">
      <i class="fa-brands fa-github sb-icon"></i>
      <i class="fa-solid fa-filter sb-icon"></i>
      <i class="fa-solid fa-trophy sb-icon"></i>
      <i class="fa-solid fa-chart-line sb-icon"></i>
    </div>
    <div class="sb-content">
      <div style="margin-bottom:25px">
        <div class="section-title">Fonte de Dados</div>
        <div id="connectionStatus" style="border:2px solid #bbdefb; background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); border-radius:var(--border-radius-sm); padding:18px; text-align:center; box-shadow: var(--shadow-sm);">
          <div style="font-size:13px; font-weight:700; color:var(--brand-blue); margin-bottom:8px; display:flex; align-items:center; justify-content:center; gap:8px;">
            <i class="fa-brands fa-github"></i> Conex√£o GitHub Ativa
          </div>
          <div style="font-size:11px; color:var(--brand-blue); margin-bottom:12px; font-weight:500;">
            Base: <strong>base_hub_github.xlsx</strong>
          </div>
          <button id="refreshBtn" class="btn btn-secondary" style="width:100%; justify-content:center; padding:10px; font-size:12px;">
            <i class="fa-solid fa-sync"></i> Recarregar Dados
          </button>
        </div>
      </div>

      <div style="margin-bottom:25px">
        <div class="section-title">Filtros principais</div>
        <input id="qSearch" class="form-control" placeholder="üîç Buscar (CNPJ, Raz√£o Social, Analista)..." aria-label="Busca r√°pida">
        <div style="font-size:12px; color:var(--text-light); margin-bottom:6px; font-weight:500;">Per√≠odo de an√°lise</div>
        <div class="select-wrapper">
          <select id="datePreset" class="form-control" style="margin-bottom:8px;" aria-label="Filtro de per√≠odo predefinido">
            <option value="">Per√≠odo Personalizado</option>
            <option value="last7">√öltimos 7 dias</option>
            <option value="last30">√öltimos 30 dias</option>
            <option value="currentMonth">M√™s Atual</option>
            <option value="lastMonth">M√™s Passado</option>
            <option value="currentYear">Ano Atual</option>
            <option value="fullRange">Per√≠odo Completo (Base)</option>
          </select>
        </div>
        <div style="display:flex; gap:8px; margin-bottom:12px">
          <input id="dateStart" type="date" class="form-control" style="margin:0; flex:1" aria-label="Data inicial">
          <input id="dateEnd" type="date" class="form-control" style="margin:0; flex:1" aria-label="Data final">
        </div>
        <div class="select-wrapper">
          <select id="motivoSelect" class="form-control" aria-label="Filtro de motivo">
            <option value="">Todos Motivos</option>
          </select>
        </div>
        <div class="select-wrapper">
          <select id="analistaSelect" class="form-control" aria-label="Filtro de analista">
            <option value="">Todos Analistas</option>
          </select>
        </div>
      </div>

      <div style="margin-bottom:25px">
        <div class="section-title">Filtros avan√ßados</div>
        <div class="select-wrapper">
          <select id="subSelect" class="form-control" aria-label="Filtro de subclassifica√ß√£o">
            <option value="">Todas Subclasses</option>
          </select>
        </div>
        <div class="select-wrapper">
          <select id="gnSelect" class="form-control" aria-label="Filtro de GN">
            <option value="">Todas GN</option>
          </select>
        </div>
        <div class="select-wrapper">
          <select id="tipoContatoSelect" class="form-control" aria-label="Filtro de tipo de contato">
            <option value="">Todos Tipos</option>
            <option value="Ativo">Ativo</option>
            <option value="Receptivo">Receptivo</option>
          </select>
        </div>
        <div style="display:flex; gap:10px; margin-top:12px;">
          <button id="applyBtn" class="btn btn-primary" type="button" style="flex:1">
            <i class="fa-solid fa-rotate-right"></i> Aplicar Filtros
          </button>
          <button id="clearBtn" class="btn btn-ghost" type="button" style="flex:1">
            <i class="fa-solid fa-eraser"></i> Limpar Tudo
          </button>
        </div>
      </div>

      <div>
        <div class="section-title">Ranking Analistas</div>
        <div id="gamificationBoard">
          <div style="font-size:13px; color:var(--muted); text-align:center; padding:15px;">Carregando ranking...</div>
        </div>
      </div>
    </div>
  </aside>

  <main class="main" id="main-content">
    <div class="context-bar fade-in">
      <div class="context-text" id="contextSummary">Iniciando download da base de dados...</div>
      <div class="context-actions">
        <div class="context-hint">
          <i class="fa-solid fa-lightbulb"></i>
          <span>Clique em gr√°ficos, c√©lulas ou KPIs para filtrar/desfiltrar</span>
        </div>
        <button onclick="toggleFullScreen()" class="btn btn-ghost" style="font-size:12px; padding:8px 12px;">
          <i class="fa-solid fa-expand"></i> Tela Cheia
        </button>
      </div>
    </div>

    <div id="activeFilters" aria-label="Filtros ativos"></div>

    <div class="kpi-grid">
      <div class="kpi-card slide-in-left" id="kpiTotal" data-filter="Total" style="animation-delay: 0.1s">
        <div class="kpi-content">
          <div class="kpi-val" id="kTotal">0</div>
          <div class="kpi-lbl">Total de registros</div>
          <div class="kpi-helper" id="kTotalHelper">Clique para limpar todos os filtros</div>
        </div>
        <div class="kpi-icon"><i class="fa-solid fa-layer-group"></i></div>
      </div>

      <div class="kpi-card slide-in-left" id="kpiOpen" data-filter="Aberto" style="animation-delay: 0.2s">
        <div class="kpi-content">
          <div class="kpi-val" id="kOpen" style="color:var(--brand-orange)">0</div>
          <div class="kpi-lbl">Em aberto</div>
          <div class="kpi-helper" id="kOpenHelper">Clique para filtrar/desfiltrar por status "Em Aberto"</div>
        </div>
        <div class="kpi-icon"><i class="fa-regular fa-clock"></i></div>
      </div>

      <div class="kpi-card slide-in-left" id="kpiClosed" data-filter="Fechado" style="animation-delay: 0.3s">
        <div class="kpi-content">
          <div class="kpi-val" id="kClosed" style="color:var(--success-green)">0</div>
          <div class="kpi-lbl">Conclu√≠dos</div>
          <div class="kpi-helper" id="kClosedHelper">Clique para filtrar/desfiltrar por status "Conclu√≠do"</div>
        </div>
        <div class="kpi-icon"><i class="fa-solid fa-check-circle"></i></div>
      </div>

      <div class="kpi-card slide-in-left" id="kpiFCR" data-filter="FCR" style="animation-delay: 0.4s">
        <div class="kpi-content">
          <div class="kpi-val" id="kFCR">0%</div>
          <div class="kpi-lbl">FCR (Resolu√ß√£o 1¬™)</div>
          <div class="kpi-helper" id="kFCRHelper">Clique para filtrar/desfiltrar por FCR = Sim</div>
        </div>
        <div class="kpi-icon"><i class="fa-solid fa-bullseye"></i></div>
      </div>

      <div class="kpi-card slide-in-left avg-time-card" id="kpiAvgTime" data-filter="AvgTime" style="animation-delay: 0.5s">
        <div class="kpi-content">
          <div class="kpi-val" id="kAvgTime">0h</div>
          <div class="kpi-lbl">Tempo M√©dio Resolu√ß√£o</div>
          <div class="kpi-helper" id="kAvgTimeHelper">Baseado apenas nos casos conclu√≠dos</div>
        </div>
        <div class="kpi-icon"><i class="fa-solid fa-hourglass-half"></i></div>
      </div>
    </div>

    <div class="charts-grid">
      <div class="card fade-in" style="animation-delay: 0.2s">
        <div class="card-header-row">
          <div>
            <h3 class="card-title"><i class="fa-solid fa-trophy" style="color:var(--brand-yellow)"></i> Performance por Analista</h3>
            <div class="card-subtitle">Volume total de atividades por respons√°vel</div>
          </div>
        </div>
        <div class="chart-container">
          <canvas id="chartAnal" role="img" aria-label="Gr√°fico de barras com atendimentos por analista"></canvas>
        </div>
        <div style="text-align:center; font-size:11px; color:var(--muted); margin-top:10px; font-weight:500;">
          <i class="fa-solid fa-mouse-pointer"></i> Clique em um analista para filtrar/desfiltrar
        </div>
      </div>

      <div class="card fade-in" style="animation-delay: 0.3s">
        <div class="card-header-row">
          <div>
            <h3 class="card-title"><i class="fa-solid fa-chart-pie" style="color:var(--brand-orange)"></i> Distribui√ß√£o de Atendimentos por GN</h3>
            <div class="card-subtitle">Percentual de ocorr√™ncias por Ger√™ncia de Neg√≥cio</div>
          </div>
          <button onclick="downloadChart('chartGNDistribution', 'distribuicao-gn.png')" class="btn btn-ghost" style="padding:6px 12px; font-size:11px;">
            <i class="fa-solid fa-download"></i> Exportar
          </button>
        </div>
        <div style="display:flex; height:300px; align-items:center;">
          <div style="flex:1; position:relative;">
            <canvas id="chartGNDistribution" role="img" aria-label="Gr√°fico de rosca com distribui√ß√£o de atendimentos por GN"></canvas>
            <div class="doughnut-center-info" id="chartGNCenter">
              <div class="doughnut-center-name">Total GN</div>
              <div class="doughnut-center-value">0</div>
            </div>
          </div>
          <div id="legendGN" style="width:200px; padding-left:15px; overflow-y:auto; max-height:100%;">
            <div style="font-size:13px; font-weight:600; color:var(--brand-blue); margin-bottom:10px; padding-bottom:5px; border-bottom:2px solid var(--border);">
              <i class="fa-solid fa-list"></i> Legenda GN
            </div>
            <div style="font-size:11px; color:var(--muted); text-align:center; padding:20px;">
              Carregando dados...
            </div>
          </div>
        </div>
        <div style="text-align:center; font-size:11px; color:var(--muted); margin-top:10px; font-weight:500;">
          <i class="fa-solid fa-mouse-pointer"></i> Clique em uma fatia para filtrar/desfiltrar por GN
        </div>
      </div>

      <div class="card fade-in" style="animation-delay: 0.4s">
        <div class="card-header-row">
          <div>
            <h3 class="card-title"><i class="fa-solid fa-headset" style="color:var(--brand-blue)"></i> Tipo de Atendimento</h3>
            <div class="card-subtitle">Distribui√ß√£o entre contatos Ativos e Receptivos</div>
          </div>
        </div>
        <div class="bar-chart-mini-container">
          <canvas id="chartTipoAtendimento" role="img" aria-label="Gr√°fico de barras para tipo de atendimento"></canvas>
        </div>
        <div style="display:flex; justify-content:center; gap:20px; margin-top:15px;">
          <div style="display:flex; align-items:center; gap:6px; font-size:11px;">
            <div style="width:12px; height:12px; background:#4A76C2; border-radius:2px;"></div>
            <span style="color:var(--text-light)">Ativo</span>
          </div>
          <div style="display:flex; align-items:center; gap:6px; font-size:11px;">
            <div style="width:12px; height:12px; background:#FFA971; border-radius:2px;"></div>
            <span style="color:var(--text-light)">Receptivo</span>
          </div>
        </div>
        <div style="text-align:center; font-size:11px; color:var(--muted); margin-top:10px; font-weight:500;">
          <i class="fa-solid fa-mouse-pointer"></i> Clique nas barras para filtrar/desfiltrar por tipo
        </div>
      </div>

      <div class="card fade-in" style="animation-delay: 0.45s">
        <div class="card-header-row">
          <div>
            <h3 class="card-title"><i class="fa-solid fa-comments" style="color:var(--success-green)"></i> Origem do Contato</h3>
            <div class="card-subtitle">Distribui√ß√£o dos canais de comunica√ß√£o</div>
          </div>
          <button onclick="downloadChart('chartOrigemContato', 'origem-contato.png')" class="btn btn-ghost" style="padding:6px 12px; font-size:11px;">
            <i class="fa-solid fa-download"></i> Exportar
          </button>
        </div>
        <div style="display:flex; height:300px; align-items:center;">
          <div style="flex:1; position:relative;">
            <canvas id="chartOrigemContato" role="img" aria-label="Gr√°fico de rosca com origem do contato"></canvas>
            <div class="doughnut-center-info" id="chartOrigemContatoCenter">
              <div class="doughnut-center-name">Total</div>
              <div class="doughnut-center-value">0</div>
            </div>
          </div>
          <div id="legendOrigemContato" style="width:180px; padding-left:15px; overflow-y:auto; max-height:100%;">
            <div style="font-size:13px; font-weight:600; color:var(--brand-blue); margin-bottom:10px; padding-bottom:5px; border-bottom:2px solid var(--border);">
              <i class="fa-solid fa-list"></i> Legenda
            </div>
            <div style="font-size:11px; color:var(--muted); text-align:center; padding:20px;">
              Carregando dados...
            </div>
          </div>
        </div>
        <div style="text-align:center; font-size:11px; color:var(--muted); margin-top:10px; font-weight:500;">
          <i class="fa-solid fa-mouse-pointer"></i> Clique em uma fatia para filtrar/desfiltrar por origem
        </div>
      </div>

      <div class="card fade-in" style="animation-delay: 0.5s">
        <div class="card-header-row">
          <div>
            <h3 class="card-title"><i class="fa-solid fa-sitemap" style="color:var(--brand-blue)"></i> Subclassifica√ß√£o</h3>
            <div class="card-subtitle">Distribui√ß√£o dos atendimentos por subclasse</div>
          </div>
        </div>
        <div style="display:flex; height:300px; align-items:center;">
          <div style="flex:1; position:relative;">
            <canvas id="chartSubclassificacao" role="img" aria-label="Gr√°fico de rosca por subclassifica√ß√£o"></canvas>
            <div class="doughnut-center-info" id="chartSubclassificacaoCenter"></div>
          </div>
          <div id="legendSubclassificacao" style="width:180px; padding-left:15px; overflow-y:auto; max-height:100%;"></div>
        </div>
      </div>
    </div>

    <div class="charts-grid">
      <div class="card fade-in" style="animation-delay: 0.6s">
        <div class="card-header-row">
          <div>
            <h3 class="card-title"><i class="fa-solid fa-chart-line" style="color:var(--brand-blue)"></i> Evolu√ß√£o Di√°ria</h3>
            <div class="card-subtitle">Volume de atividades por dia (Total vs Conclu√≠do)</div>
          </div>
          <div style="display:flex; gap:8px; align-items:center;">
            <div style="display:flex; align-items:center; gap:5px; font-size:11px;">
              <div style="width:10px; height:10px; background:var(--brand-blue); border-radius:2px;"></div>
              <span style="color:var(--text-light)">Total</span>
            </div>
            <div style="display:flex; align-items:center; gap:5px; font-size:11px;">
              <div style="width:10px; height:10px; background:var(--success-green); border-radius:2px; border:1px dashed var(--success-green);"></div>
              <span style="color:var(--text-light)">Conclu√≠do</span>
            </div>
          </div>
        </div>
        <div class="chart-container">
          <canvas id="chartEvo" role="img" aria-label="Gr√°fico de linha com evolu√ß√£o di√°ria de atendimentos"></canvas>
        </div>
        <div style="text-align:center; font-size:11px; color:var(--muted); margin-top:10px; font-weight:500;">
          <i class="fa-solid fa-mouse-pointer"></i> Clique em qualquer ponto para filtrar/desfiltrar por data espec√≠fica
        </div>
      </div>

      <div class="card fade-in" style="animation-delay: 0.7s">
        <div class="card-header-row">
          <div>
            <h3 class="card-title"><i class="fa-solid fa-folder-open" style="color:var(--brand-orange)"></i> Distribui√ß√£o por Motivo</h3>
            <div class="card-subtitle">Temas mais recorrentes (Ordenado)</div>
          </div>
          <button onclick="downloadChart('chartMot', 'distribuicao-motivo.png')" class="btn btn-ghost" style="padding:6px 12px; font-size:11px;">
            <i class="fa-solid fa-download"></i> Exportar
          </button>
        </div>
        <div class="chart-scroll-container">
          <canvas id="chartMot" role="img" aria-label="Gr√°fico de barra horizontal por motivo"></canvas>
        </div>
        <div style="text-align:center; font-size:11px; color:var(--muted); margin-top:10px; font-weight:500;">
          <i class="fa-solid fa-mouse-pointer"></i> Clique em qualquer barra para filtrar/desfiltrar por motivo
        </div>
      </div>
    </div>

    <div class="card fade-in" style="margin-top:20px; animation-delay: 0.8s">
      <div class="card-header-row">
        <div>
          <h3 class="card-title" style="margin-bottom:5px;"><i class="fa-solid fa-table" style="color:var(--brand-blue)"></i> Detalhamento das Atividades</h3>
          <div class="card-subtitle">Clique em uma linha para filtrar/desfiltrar por caso espec√≠fico ‚Ä¢ Clique no cabe√ßalho para ordenar</div>
        </div>
        <div style="display:flex; align-items:center; gap:12px;">
          <div class="pagination">
            <div class="pagination-info" id="paginationInfo">0-0</div>
            <button id="prevPage" class="pagination-btn" type="button">‚óÄ</button>
            <button id="nextPage" class="pagination-btn" type="button">‚ñ∂</button>
          </div>
          <button onclick="exportCSV()" class="btn btn-secondary" type="button">
            <i class="fa-solid fa-download"></i> Exportar CSV
          </button>
        </div>
      </div>

      <div class="table-container" aria-label="Tabela detalhada das atividades">
        <table class="table" id="dataTable">
          <thead>
            <tr>
              <th data-key="status">Status <span class="sort-indicator"></span></th>
              <th data-key="dtStart">Data In√≠cio <span class="sort-indicator"></span></th>
              <th data-key="dtEnd">Data Fim <span class="sort-indicator"></span></th>
              <th data-key="tempoResolucaoDias">Tempo Resolu√ß√£o <span class="sort-indicator"></span></th>
              <th data-key="fcr">FCR <span class="sort-indicator"></span></th>
              <th data-key="analista">Analista <span class="sort-indicator"></span></th>
              <th data-key="gn">GN <span class="sort-indicator"></span></th>
              <th data-key="motivo">Motivo <span class="sort-indicator"></span></th>
              <th data-key="sub">Sub Classifica√ß√£o <span class="sort-indicator"></span></th>
              <th data-key="solicitante">Raz√£o Social <span class="sort-indicator"></span></th>
              <th data-key="tipoContato">Tipo Atendimento <span class="sort-indicator"></span></th>
              <th data-key="origemContato">Origem Contato <span class="sort-indicator"></span></th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td colspan="12" style="text-align:center; padding:30px; color:var(--muted); font-weight:500;">
                <i class="fa-solid fa-spinner fa-spin" style="margin-right:10px;"></i>
                Aguardando dados...
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <div style="text-align:center; margin-top:15px;">
        <div style="font-size:12px; color:var(--text-light); display:inline-flex; align-items:center; gap:8px; padding:8px 16px; background:rgba(46,90,167,0.05); border-radius:8px;">
          <i class="fa-solid fa-info-circle" style="color:var(--brand-blue)"></i>
          <span>Use <kbd style="background:var(--brand-blue); color:white; padding:2px 8px; border-radius:4px; font-weight:600;">F</kbd> para focar na busca r√°pida</span>
        </div>
      </div>
    </div>

    <div style="text-align:center; margin-top:30px; padding:20px; font-size:12px; color:var(--muted); border-top:1px solid var(--border-light);">
      <div style="display:flex; justify-content:center; align-items:center; gap:20px; flex-wrap:wrap;">
        <div>Dashboard desenvolvido por <strong>Thiago Jr</strong></div>
        <div>‚Ä¢</div>
        <div>√öltima atualiza√ß√£o: <span id="lastUpdateTime">--:--</span></div>
        <div>‚Ä¢</div>
        <div><i class="fa-brands fa-github"></i> <a href="https://github.com/thiccoipp/Ipp" style="color:var(--brand-blue); text-decoration:none; font-weight:500;" target="_blank">Reposit√≥rio GitHub</a></div>
      </div>
    </div>
  </main>
</div>

<div id="loading">
  <div class="loading-content">
    <div class="loading-spinner"></div>
    <div class="loading-text" id="loadingText">Conectando ao GitHub...</div>
    <div class="loading-subtext">Baixando e processando dados da planilha</div>
    <div style="margin-top:20px; width:100%; height:6px; background:rgba(46,90,167,0.1); border-radius:3px; overflow:hidden;">
      <div id="loadingProgress" style="width:0%; height:100%; background:linear-gradient(90deg, var(--brand-blue), var(--brand-blue-light)); transition:width 0.3s;"></div>
    </div>
  </div>
</div>

<script>
Chart.register(ChartDataLabels);

const DATA_URL = "http://127.0.0.1:5000/api/data";

const GN_PALETTE = [
  '#4A76C2',
  '#FFA971',
  '#8A4CAF',
  '#5BBF8A',
  '#FFDB8A',
  '#2E9D64',
  '#A96CC9',
  '#FFC843',
  '#6B8FD4',
  '#FF8A3D',
  '#7DB37D',
  '#D3A15F',
  '#9C7BC9',
  '#5AA9E6',
  '#FF9A76',
  '#6EC5B8'
];

const BRAND_BLUE = '#2E5AA7';
const BRAND_BLUE_LIGHT = '#4A76C2';
const BRAND_YELLOW = '#FFC843';
const BRAND_ORANGE = '#FF8A3D';
const BRAND_ORANGE_LIGHT = '#FFA971';
const SUCCESS_GREEN = '#2E9D64';
const SUCCESS_GREEN_LIGHT = '#5BBF8A';
const PURPLE = '#8A4CAF';

let RAW = [], FILTERED = [], CURRENT_PAGE = 1, ITEMS_PER_PAGE = 15;
let CHART_FILTERS = { 
  'Table Row': null, 
  'Evo Date': null, 
  'Status': null, 
  'FCR_Sim': null, 
  'Date Preset': null, 
  'Doughnut Selection': {},
  'Motivo': null,
  'Analista': null,
  'GN': null,
  'Subclassifica√ß√£o': null,
  'TipoContato': null,
  'AvgTime': null,
  'Origem': null
};
let CURRENT_SORT = { key: 'dtStart', direction: 'desc' };
let BASE_FILTERED_LENGTH = 0;
let LAST_UPDATE_TIME = null;
let charts = {};
let loadingProgressInterval = null;

const $ = id => document.getElementById(id);

window.onload = function() {
  document.querySelectorAll('.btn').forEach(button => button.addEventListener('click', addRippleEffect));
  if (localStorage.getItem('dashboard-theme') === 'dark') document.body.classList.add('dark-theme');
  updateLastUpdateTime();
  initLoadFromGitHub();
  setupListeners();
};

function setupListeners() {
  $('refreshBtn').addEventListener('click', () => { showToast('Recarregando...', 'info'); initLoadFromGitHub(); });
  $('applyBtn').addEventListener('click', applyAllFilters);
  $('clearBtn').addEventListener('click', clearAllFilters);
  $('qSearch').addEventListener('input', () => { CURRENT_PAGE=1; applyAllFilters(); });
  $('motivoSelect').addEventListener('change', applyAllFilters);
  $('analistaSelect').addEventListener('change', applyAllFilters);
  $('gnSelect').addEventListener('change', applyAllFilters);
  $('subSelect').addEventListener('change', applyAllFilters);
  $('tipoContatoSelect').addEventListener('change', applyAllFilters);
  $('datePreset').addEventListener('change', handleDatePreset);
  $('dateStart').addEventListener('change', () => { $('datePreset').value=''; applyAllFilters(); });
  $('dateEnd').addEventListener('change', () => { $('datePreset').value=''; applyAllFilters(); });
  $('prevPage').addEventListener('click', () => changePage(-1));
  $('nextPage').addEventListener('click', () => changePage(1));

  $('kpiTotal').addEventListener('click', () => filterByKPI('Total'));
  $('kpiOpen').addEventListener('click', () => filterByKPI('Aberto'));
  $('kpiClosed').addEventListener('click', () => filterByKPI('Fechado'));
  $('kpiFCR').addEventListener('click', () => filterByKPI('FCR'));
  $('kpiAvgTime').addEventListener('click', () => filterByKPI('AvgTime'));

  document.addEventListener('click', function(e) {
    if (e.target.matches('#dataTable th[data-key]') || e.target.closest('#dataTable th[data-key]')) {
      const th = e.target.closest('#dataTable th[data-key]');
      const key = th.getAttribute('data-key');
      sortTable(key);
    }
  });

  document.addEventListener('keydown', (e) => {
    if (e.key === 'f' || e.key === 'F') {
      if (!e.ctrlKey && !e.metaKey) {
        e.preventDefault();
        $('qSearch').focus();
        $('qSearch').select();
        showToast('Campo de busca ativado. Digite para filtrar.', 'info');
      }
    }
  });
}

async function initLoadFromGitHub() {
  showLoading(true, "Conectando ao GitHub...");
  resetLoadingProgress();
  
  try {
    const noCacheUrl = DATA_URL + "?t=" + new Date().getTime();
    startLoadingProgress();
    
    const response = await fetch(noCacheUrl);
    if (!response.ok) throw new Error(`Erro HTTP: ${response.status}`);
    
    const arrayBuffer = await response.arrayBuffer();
    completeLoadingProgress();
    processExcelData(arrayBuffer);
    
  } catch (error) {
    console.error(error);
    completeLoadingProgress();
    showToast(`Falha ao carregar dados: ${error.message}`, 'error');
    setTimeout(() => {
      showLoading(false);
    }, 500);
    $('contextSummary').innerHTML = `<span style="color:var(--error-red)">Erro ao conectar: ${error.message}</span>`;
  }
}

function startLoadingProgress() {
  clearInterval(loadingProgressInterval);
  let progress = 0;
  loadingProgressInterval = setInterval(() => {
    progress += Math.random() * 10 + 5;
    if (progress > 90) {
      progress = 90;
    }
    $('loadingProgress').style.width = progress + '%';
  }, 200);
}

function completeLoadingProgress() {
  clearInterval(loadingProgressInterval);
  $('loadingProgress').style.width = '100%';
}

function resetLoadingProgress() {
  clearInterval(loadingProgressInterval);
  $('loadingProgress').style.width = '0%';
}

function processExcelData(arrayBuffer) {
  try {
    const wb = XLSX.read(arrayBuffer, { type: 'array' });
    const sheetName = wb.SheetNames[0];
    const json = XLSX.utils.sheet_to_json(wb.Sheets[sheetName], { defval: "" });

    const excelDateToJS = (n) => {
      const date = new Date((n - 25568) * 86400 * 1000);
      return new Date(date.getFullYear(), date.getMonth(), date.getDate());
    };
    
    RAW = json.map((row, index) => {
      let dataInicioRaw = row["Data Inicio"];
      let dataInicioObj = null;
      if(typeof dataInicioRaw === 'number') dataInicioObj = excelDateToJS(dataInicioRaw);
      else if(dataInicioRaw) dataInicioObj = new Date(dataInicioRaw);

      let dataFimRaw = row["Data Fim"];
      let dataFimObj = null;
      if(typeof dataFimRaw === 'number') dataFimObj = excelDateToJS(dataFimRaw);
      else if(dataFimRaw) dataFimObj = new Date(dataFimRaw);

      let statusNorm = "Aberto";
      if (dataFimObj && !isNaN(dataFimObj.getTime())) statusNorm = "Fechado";
      let statusDisplay = row["Status de libera√ß√£o"] || statusNorm;

      let fcrValue = row["FCR"] || "N√£o";
      if (typeof fcrValue === 'string') {
        fcrValue = fcrValue.trim().toUpperCase();
        if (fcrValue === 'SIM') fcrValue = 'Sim';
        if (fcrValue === 'N√ÉO' || fcrValue === 'NAO') fcrValue = 'N√£o';
      }

      let tempoResolucao = null, tempoResolucaoDias = null, tempoResolucaoHoras = null, tempoResolucaoFormatado = "-";
      if (dataInicioObj && dataFimObj && !isNaN(dataInicioObj.getTime()) && !isNaN(dataFimObj.getTime()) && statusNorm === "Fechado" && dataFimObj >= dataInicioObj) {
        const diffMs = dataFimObj.getTime() - dataInicioObj.getTime();
        tempoResolucao = diffMs;
        tempoResolucaoDias = diffMs / (1000 * 60 * 60 * 24);
        tempoResolucaoHoras = diffMs / (1000 * 60 * 60);
        tempoResolucaoFormatado = tempoResolucaoHoras < 24 ? `${Math.round(tempoResolucaoHoras)}h` : `${tempoResolucaoDias.toFixed(1)} dias`;
      }

      let gn = row["GN"] || "N√£o Informado";
      gn = gn.toString().trim();
      if (!gn || gn === "") gn = "N√£o Informado";

      let tipoContato = String(row["Tipo de contato"] || "").trim();
      if (!tipoContato || tipoContato === "") tipoContato = "N√£o Informado";
      if (tipoContato.toLowerCase().includes("ativo")) tipoContato = "Ativo";
      if (tipoContato.toLowerCase().includes("receptivo")) tipoContato = "Receptivo";

      let origemContato = row["Origem do contato"] || "N√£o Informado";
      origemContato = origemContato.toString().trim();

      return {
        uid: index,
        status: statusDisplay,
        statusNorm,
        dtStart: dataInicioObj,
        dtEnd: dataFimObj,
        fcr: fcrValue,
        analista: row["Analista"] || "N√£o Atribu√≠do",
        gn: gn,
        motivo: row["Motivo"] || "Outros",
        sub: row["Sub Classifica√ß√£o"] || "Geral",
        solicitante: row["Raz√£o Social"] || row["CNPJ"] || "",
        descricao: row["Descri√ß√£o"] || "",
        cnpj: row["CNPJ"] || "",
        tipoContato: tipoContato,
        origemContato: origemContato,
        tempoResolucao,
        tempoResolucaoDias,
        tempoResolucaoHoras,
        tempoResolucaoFormatado
      };
    });

    RAW = RAW.filter(r => r.dtStart && !isNaN(r.dtStart.getTime()));
    FILTERED = [...RAW];
    BASE_FILTERED_LENGTH = FILTERED.length;

    populateFilters();
    applyAllFilters();

    setTimeout(() => {
      showLoading(false);
      showToast('Dados carregados com sucesso!', 'success');
      updateLastUpdateTime();
    }, 300);
    
  } catch (err) {
    console.error('Erro processamento:', err);
    showToast('Erro ao ler planilha. Verifique console.', 'error');
    showLoading(false);
  }
}

function populateFilters() {
  const unique = (key) => [...new Set(RAW.map(item => item[key]))]
    .filter(x => (typeof x === 'string' ? x.trim() !== '' : x != null))
    .sort();

  const fillSelect = (id, list, defaultText) => {
    const sel = $(id);
    sel.innerHTML = `<option value="">${defaultText}</option>`;
    list.forEach(val => {
      const opt = document.createElement('option');
      opt.value = val;
      opt.innerText = val.length > 40 ? val.substring(0, 40) + '...' : val;
      opt.title = val;
      sel.appendChild(opt);
    });
  };

  fillSelect('motivoSelect', unique('motivo'), 'Todos Motivos');
  fillSelect('analistaSelect', unique('analista'), 'Todos Analistas');
  fillSelect('subSelect', unique('sub'), 'Todas Subclasses');
  fillSelect('gnSelect', unique('gn'), 'Todas GN');
  fillSelect('tipoContatoSelect', unique('tipoContato'), 'Todos Tipos');
}

function applyAllFilters() {
  const q = $('qSearch').value.toLowerCase();
  const fMotivo = $('motivoSelect').value;
  const fAnalista = $('analistaSelect').value;
  const fSub = $('subSelect').value;
  const fGN = $('gnSelect').value;
  const fTipoContato = $('tipoContatoSelect').value;
  const fOrigem = CHART_FILTERS['Origem'];

  let dStart = $('dateStart').value ? new Date($('dateStart').value) : null;
  let dEnd = $('dateEnd').value ? new Date($('dateEnd').value) : null;
  
  // CORRE√á√ÉO: Se houver filtro de data do gr√°fico, sobrep√µe com tratamento correto
  if (CHART_FILTERS['Evo Date']) {
    const filterDate = new Date(CHART_FILTERS['Evo Date']);
    // Criar data de in√≠cio e fim para o dia completo
    dStart = new Date(filterDate.getFullYear(), filterDate.getMonth(), filterDate.getDate(), 0, 0, 0);
    dEnd = new Date(filterDate.getFullYear(), filterDate.getMonth(), filterDate.getDate(), 23, 59, 59);
  } else if (dEnd) {
    // Apenas ajusta hora para filtros normais
    dEnd.setHours(23,59,59);
  }

  FILTERED = RAW.filter(item => {
    const textMatch = !q ||
      (item.analista && item.analista.toLowerCase().includes(q)) ||
      (item.solicitante && item.solicitante.toLowerCase().includes(q)) ||
      (item.motivo && item.motivo.toLowerCase().includes(q)) ||
      (item.cnpj && item.cnpj.toString().includes(q)) ||
      (item.gn && item.gn.toLowerCase().includes(q));

    const motivoMatch = !fMotivo || item.motivo === fMotivo;
    const analistaMatch = !fAnalista || item.analista === fAnalista;
    const subMatch = !fSub || item.sub === fSub;
    const gnMatch = !fGN || item.gn === fGN;
    const tipoContatoMatch = !fTipoContato || item.tipoContato === fTipoContato;
    const origemMatch = !fOrigem || item.origemContato === fOrigem;

    // CORRE√á√ÉO: Verifica√ß√£o de data corrigida
    let dateMatch = true;
    if (dStart || dEnd) {
      const itemDate = item.dtStart;
      if (!itemDate) dateMatch = false;
      else {
        if (dStart && itemDate < dStart) dateMatch = false;
        if (dateMatch && dEnd && itemDate > dEnd) dateMatch = false;
      }
    }

    const kpiStatusMatch = !CHART_FILTERS['Status'] ||
      (CHART_FILTERS['Status'] === 'Fechado' ? item.statusNorm === 'Fechado' : item.statusNorm === 'Aberto');

    const kpiFcrMatch = !CHART_FILTERS['FCR_Sim'] || item.fcr === 'Sim';
    
    const kpiAvgTimeMatch = !CHART_FILTERS['AvgTime'] || (item.statusNorm === 'Fechado' && item.tempoResolucao !== null);
    
    const chartAnalistaMatch = !CHART_FILTERS['Doughnut Selection']['Analista'] || item.analista === CHART_FILTERS['Doughnut Selection']['Analista'];
    const chartGNMatch = !CHART_FILTERS['Doughnut Selection']['GN'] || item.gn === CHART_FILTERS['Doughnut Selection']['GN'];

    return textMatch && motivoMatch && analistaMatch && subMatch && gnMatch && tipoContatoMatch && origemMatch && dateMatch && 
           kpiStatusMatch && kpiFcrMatch && kpiAvgTimeMatch && chartAnalistaMatch && chartGNMatch;
  });

  renderKPIs();
  renderCharts();
  renderTable();
  updateActiveFiltersDisplay();
  generateGamification();
}

function renderKPIs() {
  const total = FILTERED.length;
  const closed = FILTERED.filter(d => d.statusNorm === 'Fechado').length;
  const open = total - closed;
  const fcrCount = FILTERED.filter(d => (d.fcr || '').toUpperCase() === 'SIM').length;
  const fcrPerc = total > 0 ? Math.round((fcrCount / total) * 100) : 0;
  
  const closedWithTime = FILTERED.filter(d => d.statusNorm === 'Fechado' && d.tempoResolucao !== null);
  let avgTimeHours = 0;
  let avgTimeDisplay = "0h";
  
  if (closedWithTime.length > 0) {
    const totalMs = closedWithTime.reduce((acc, d) => acc + d.tempoResolucao, 0);
    avgTimeHours = totalMs / closedWithTime.length / (1000 * 60 * 60);
    
    if (avgTimeHours < 24) {
      avgTimeDisplay = `${Math.round(avgTimeHours)}h`;
    } else {
      const avgDays = (avgTimeHours / 24).toFixed(1);
      avgTimeDisplay = `${avgDays}d`;
    }
  }

  $('kTotal').innerText = total;
  $('kOpen').innerText = open;
  $('kClosed').innerText = closed;
  $('kFCR').innerText = fcrPerc + '%';
  $('kAvgTime').innerText = avgTimeDisplay;

  $('headerTotal').innerText = total;
  $('headerOpen').innerText = open;
  $('headerClosed').innerText = closed;

  $('contextSummary').innerHTML = `Exibindo <span>${total}</span> registros filtrados de <span>${RAW.length}</span> totais.`;

  $('kTotalHelper').innerText = (CHART_FILTERS['Status'] || CHART_FILTERS['FCR_Sim'] || CHART_FILTERS['AvgTime']) ? 
    'Clique para limpar todos os filtros' : 'Clique para limpar todos os filtros';

  $('kOpenHelper').innerText = CHART_FILTERS['Status'] === 'Aberto' ? 
    'Clique para remover filtro "Em Aberto"' : 'Clique para filtrar por status "Em Aberto"';

  $('kClosedHelper').innerText = (CHART_FILTERS['Status'] === 'Fechado' && !CHART_FILTERS['FCR_Sim'] && !CHART_FILTERS['AvgTime']) ? 
    'Clique para remover filtro "Conclu√≠do"' : 'Clique para filtrar por status "Conclu√≠do"';

  $('kFCRHelper').innerText = CHART_FILTERS['FCR_Sim'] === 'Sim' ? 
    'Clique para remover filtro FCR' : 'Clique para filtrar por FCR = Sim';

  $('kAvgTimeHelper').innerText = CHART_FILTERS['AvgTime'] ? 
    'Clique para remover filtro Tempo M√©dio' : 'Baseado apenas nos casos conclu√≠dos';

  ['kpiTotal', 'kpiOpen', 'kpiClosed', 'kpiFCR', 'kpiAvgTime'].forEach(id => $(id).classList.remove('active-filter'));
  
  if (CHART_FILTERS['Status'] === 'Aberto') $('kpiOpen').classList.add('active-filter');
  else if (CHART_FILTERS['Status'] === 'Fechado' && CHART_FILTERS['FCR_Sim'] !== 'Sim' && !CHART_FILTERS['AvgTime']) $('kpiClosed').classList.add('active-filter');
  else if (CHART_FILTERS['FCR_Sim'] === 'Sim') $('kpiFCR').classList.add('active-filter');
  else if (CHART_FILTERS['AvgTime']) $('kpiAvgTime').classList.add('active-filter');
}

function filterByKPI(filterType) {
  if (filterType === 'Total') {
    if (CHART_FILTERS['Status'] === null && CHART_FILTERS['FCR_Sim'] === null && CHART_FILTERS['AvgTime'] === null) return;
    CHART_FILTERS['Status'] = null;
    CHART_FILTERS['FCR_Sim'] = null;
    CHART_FILTERS['AvgTime'] = null;
  } else if (filterType === 'Aberto') {
    if (CHART_FILTERS['Status'] === 'Aberto') {
      CHART_FILTERS['Status'] = null;
    } else {
      CHART_FILTERS['Status'] = 'Aberto';
      CHART_FILTERS['FCR_Sim'] = null;
      CHART_FILTERS['AvgTime'] = null;
    }
  } else if (filterType === 'Fechado') {
    if (CHART_FILTERS['Status'] === 'Fechado' && CHART_FILTERS['FCR_Sim'] !== 'Sim' && !CHART_FILTERS['AvgTime']) {
      CHART_FILTERS['Status'] = null;
    } else {
      CHART_FILTERS['Status'] = 'Fechado';
      CHART_FILTERS['FCR_Sim'] = null;
      CHART_FILTERS['AvgTime'] = null;
    }
  } else if (filterType === 'FCR') {
    if (CHART_FILTERS['FCR_Sim'] === 'Sim') {
      CHART_FILTERS['FCR_Sim'] = null;
      CHART_FILTERS['Status'] = null;
      CHART_FILTERS['AvgTime'] = null;
    } else {
      CHART_FILTERS['FCR_Sim'] = 'Sim';
      CHART_FILTERS['Status'] = 'Fechado';
      CHART_FILTERS['AvgTime'] = null;
    }
  } else if (filterType === 'AvgTime') {
    if (CHART_FILTERS['AvgTime']) {
      CHART_FILTERS['AvgTime'] = null;
      CHART_FILTERS['Status'] = null;
    } else {
      CHART_FILTERS['AvgTime'] = 'Sim';
      CHART_FILTERS['Status'] = 'Fechado';
      CHART_FILTERS['FCR_Sim'] = null;
    }
  }
  
  applyAllFilters();
}

function filterByGN(gn) {
  if (CHART_FILTERS['GN'] === gn) {
    CHART_FILTERS['GN'] = null;
    delete CHART_FILTERS['Doughnut Selection']['GN'];
    $('gnSelect').value = '';
    showToast('Filtro de GN removido', 'info');
  } else {
    CHART_FILTERS['GN'] = gn;
    CHART_FILTERS['Doughnut Selection']['GN'] = gn;
    $('gnSelect').value = gn;
    showToast(`Filtrando por GN: ${gn}`, 'success');
  }
  applyAllFilters();
}

function filterByOrigem(origem) {
  if (CHART_FILTERS['Origem'] === origem) {
    CHART_FILTERS['Origem'] = null;
    showToast(`Filtro de origem "${origem}" removido`, 'info');
  } else {
    CHART_FILTERS['Origem'] = origem;
    showToast(`Filtrando por origem: ${origem}`, 'success');
  }
  applyAllFilters();
}

function renderCharts() {
  const countsAnalista = {};
  FILTERED.forEach(d => countsAnalista[d.analista] = (countsAnalista[d.analista]||0)+1);
  const sortedAnalista = Object.entries(countsAnalista).sort((a,b)=>b[1]-a[1]).slice(0, 15);
  createBarChart('chartAnal', sortedAnalista.map(x=>x[0]), sortedAnalista.map(x=>x[1]), 'Analista');

  createGNDistributionChart();

  createTipoAtendimentoChart();

  createOrigemContatoChart();

  const countsSub = {};
  FILTERED.forEach(d => {
    const sub = d.sub || 'N√£o informado';
    countsSub[sub] = (countsSub[sub]||0)+1;
  });
  createDoughnutChart('chartSubclassificacao', countsSub, 'chartSubclassificacaoCenter', 'legendSubclassificacao', 'Subclasse');

  const timelineData = {};
  FILTERED.forEach(d => {
    if (!d.dtStart) return;
    const dateKey = moment(d.dtStart).format('YYYY-MM-DD');
    if(!timelineData[dateKey]) timelineData[dateKey] = { total: 0, closed: 0 };
    timelineData[dateKey].total++;
    if(d.statusNorm === 'Fechado') timelineData[dateKey].closed++;
  });
  
  const allDates = [];
  if (FILTERED.length > 0) {
    const minDate = new Date(Math.min(...FILTERED.map(d => d.dtStart).filter(d => d)));
    const maxDate = new Date(Math.max(...FILTERED.map(d => d.dtStart).filter(d => d)));
    
    let currentDate = new Date(minDate);
    while (currentDate <= maxDate) {
      allDates.push(moment(currentDate).format('YYYY-MM-DD'));
      currentDate.setDate(currentDate.getDate() + 1);
    }
  }
  
  const sortedDates = allDates.sort();
  const totalPoints = sortedDates.map(d => ({ 
    x: moment(d, 'YYYY-MM-DD').toDate(), 
    y: timelineData[d] ? timelineData[d].total : 0 
  }));
  const closedPoints = sortedDates.map(d => ({ 
    x: moment(d, 'YYYY-MM-DD').toDate(), 
    y: timelineData[d] ? timelineData[d].closed : 0 
  }));
  createLineChart('chartEvo', totalPoints, closedPoints);

  const countsMotivo = {};
  FILTERED.forEach(d => {
    const motivo = d.motivo || 'N√£o informado';
    countsMotivo[motivo] = (countsMotivo[motivo]||0)+1;
  });
  const sortedMotivo = Object.entries(countsMotivo).sort((a,b)=>b[1]-a[1]);
  createHorizontalBarChart('chartMot', sortedMotivo.map(x=>x[0]), sortedMotivo.map(x=>x[1]));
}

function createOrigemContatoChart() {
  const ctx = $('chartOrigemContato').getContext('2d');
  if(charts.chartOrigemContato) charts.chartOrigemContato.destroy();

  const origemCounts = {};
  FILTERED.forEach(d => {
    const origem = d.origemContato || 'N√£o Informado';
    origemCounts[origem] = (origemCounts[origem] || 0) + 1;
  });

  let origemArray = Object.entries(origemCounts).map(([origem, count]) => ({origem, count}));
  origemArray.sort((a, b) => b.count - a.count);

  let topOrigem = [];
  let othersCount = 0;
  
  if (origemArray.length > 8) {
    topOrigem = origemArray.slice(0, 7);
    othersCount = origemArray.slice(7).reduce((sum, item) => sum + item.count, 0);
    if (othersCount > 0) {
      topOrigem.push({origem: 'Outros', count: othersCount});
    }
  } else {
    topOrigem = origemArray;
  }

  const labels = topOrigem.map(item => item.origem);
  const data = topOrigem.map(item => item.count);
  const total = data.reduce((a, b) => a + b, 0);

  $('chartOrigemContatoCenter').innerHTML = `
    <div class="doughnut-center-name">Total</div>
    <div class="doughnut-center-value">${total}</div>
  `;

  const legendDiv = $('legendOrigemContato');
  let legendHtml = `
    <div style="font-size:13px; font-weight:600; color:var(--brand-blue); margin-bottom:10px; padding-bottom:5px; border-bottom:2px solid var(--border);">
      <i class="fa-solid fa-list"></i> Legenda (Top ${topOrigem.length})
    </div>
  `;
  
  topOrigem.forEach((item, index) => {
    const perc = total > 0 ? Math.round((item.count/total)*100) : 0;
    legendHtml += `
      <div style="display:flex;align-items:center;font-size:11px;margin-bottom:8px;color:var(--text);padding:8px 0;border-bottom:1px solid var(--border-light); cursor:pointer;"
           onclick="filterByOrigem('${item.origem}')">
        <span style="width:10px;height:10px;border-radius:50%;background:${GN_PALETTE[index%GN_PALETTE.length]};margin-right:8px;"></span>
        <span class="truncated" style="flex:1;max-width:100px" title="${item.origem}">${item.origem}</span>
        <span style="margin-left:auto;font-weight:600;color:var(--brand-blue)">${item.count} (${perc}%)</span>
      </div>
    `;
  });
  
  legendDiv.innerHTML = legendHtml;

  charts.chartOrigemContato = new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: labels,
      datasets: [{
        data: data,
        backgroundColor: labels.map((_, i) => GN_PALETTE[i % GN_PALETTE.length]),
        borderWidth: 2,
        borderColor: '#fff',
        hoverBorderWidth: 3
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      cutout: '70%',
      plugins: {
        legend: { display: false },
        datalabels: {
          display: true,
          color: '#fff',
          font: { weight: 'bold', size: 11 },
          formatter: (value, context) => {
            const total = context.dataset.data.reduce((a, b) => a + b, 0);
            const percentage = Math.round((value / total) * 100);
            return `${percentage}%`;
          }
        }
      },
      onClick: (e, els) => {
        if(!els.length) return;
        const idx = els[0].index;
        const origem = labels[idx];
        if (origem !== 'Outros') {
          filterByOrigem(origem);
        }
      }
    },
    plugins: [ChartDataLabels]
  });
}

function createTipoAtendimentoChart() {
  const ctx = $('chartTipoAtendimento').getContext('2d');
  if(charts.chartTipoAtendimento) charts.chartTipoAtendimento.destroy();

  const tipoCounts = {};
  FILTERED.forEach(d => {
    const tipo = d.tipoContato || 'N√£o Informado';
    tipoCounts[tipo] = (tipoCounts[tipo] || 0) + 1;
  });

  const tiposArray = Object.entries(tipoCounts);
  tiposArray.sort((a, b) => b[1] - a[1]);

  const labels = tiposArray.map(item => item[0]);
  const data = tiposArray.map(item => item[1]);
  const total = data.reduce((a, b) => a + b, 0);

  const backgroundColors = labels.map(label => {
    if (label === 'Ativo') return '#4A76C2';
    if (label === 'Receptivo') return '#FFA971';
    if (label === 'N√£o Informado') return '#7B8793';
    return GN_PALETTE[labels.indexOf(label) % GN_PALETTE.length];
  });

  charts.chartTipoAtendimento = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: labels,
      datasets: [{
        label: 'Quantidade',
        data: data,
        backgroundColor: backgroundColors,
        borderColor: backgroundColors.map(color => color.replace('0.8', '1')),
        borderWidth: 1,
        borderRadius: 6,
        barPercentage: 0.6
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      onClick: (e, elements) => {
        if (elements.length > 0) {
          const index = elements[0].index;
          const tipo = labels[index];
          
          if (CHART_FILTERS['TipoContato'] === tipo || $('tipoContatoSelect').value === tipo) {
            CHART_FILTERS['TipoContato'] = null;
            $('tipoContatoSelect').value = '';
            showToast(`Filtro de tipo "${tipo}" removido`, 'info');
          } else {
            CHART_FILTERS['TipoContato'] = tipo;
            $('tipoContatoSelect').value = tipo;
            showToast(`Filtrando por tipo: ${tipo}`, 'success');
          }
          
          applyAllFilters();
        }
      },
      plugins: {
        legend: { display: false },
        datalabels: {
          color: '#fff',
          anchor: 'end',
          align: 'top',
          font: { weight: 'bold', size: 11 },
          formatter: (value, context) => {
            const percentage = ((value / total) * 100).toFixed(1);
            return `${value} (${percentage}%)`;
          }
        },
        tooltip: {
          callbacks: {
            label: function(context) {
              const label = context.dataset.label || '';
              const value = context.parsed.y;
              const percentage = ((value / total) * 100).toFixed(1);
              return `${label}: ${value} (${percentage}%)`;
            }
          }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          grid: { color: '#e8eef5' },
          ticks: { 
            stepSize: 1,
            font: { size: 11 }
          }
        },
        x: {
          grid: { display: false },
          ticks: { 
            font: { size: 11 },
            maxRotation: 45
          }
        }
      }
    },
    plugins: [ChartDataLabels]
  });
}

function createBarChart(id, labels, data, type) {
  const ctx = $(id).getContext('2d');
  if(charts[id]) charts[id].destroy();

  charts[id] = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: labels,
      datasets: [{
        label: 'Volume', 
        data: data, 
        backgroundColor: labels.map((_, index) => 
          GN_PALETTE[index % GN_PALETTE.length]
        ),
        borderRadius: 4
      }]
    },
    options: {
      responsive: true, 
      maintainAspectRatio: false,
      onClick: (e, els) => {
        if(els.length > 0) {
          const idx = els[0].index;
          const val = labels[idx];
          
          if (CHART_FILTERS['Analista'] === val) {
            CHART_FILTERS['Analista'] = null;
            delete CHART_FILTERS['Doughnut Selection']['Analista'];
            $('analistaSelect').value = '';
            showToast(`Filtro do analista "${val}" removido`, 'info');
          } else {
            CHART_FILTERS['Analista'] = val;
            CHART_FILTERS['Doughnut Selection']['Analista'] = val;
            $('analistaSelect').value = val;
            showToast(`Filtrando por analista: ${val}`, 'success');
          }
          
          applyAllFilters();
        }
      },
      plugins: {
        legend: { display: false },
        datalabels: {
          color: '#fff', 
          anchor: 'end', 
          align: 'top', 
          formatter: (value) => value, 
          font: { weight: 'bold', size: 12 }
        }
      },
      scales: {
        y: { 
          beginAtZero: true, 
          grid: { color: '#e8eef5' }, 
          ticks: { stepSize: 1 } 
        },
        x: { 
          grid: { display: false }, 
          ticks: { 
            autoSkip: false, 
            maxRotation: 45, 
            minRotation: 0, 
            font: { size: 11 } 
          } 
        }
      }
    },
    plugins: [ChartDataLabels]
  });
}

function createGNDistributionChart() {
  const ctx = $('chartGNDistribution').getContext('2d');
  if(charts.chartGNDistribution) charts.chartGNDistribution.destroy();

  const gnCounts = {};
  FILTERED.forEach(d => {
    const gn = d.gn || 'N√£o Informado';
    gnCounts[gn] = (gnCounts[gn] || 0) + 1;
  });

  let gnArray = Object.entries(gnCounts).map(([gn, count]) => ({gn, count}));
  gnArray.sort((a, b) => b.count - a.count);

  let topGN = [];
  let othersCount = 0;
  
  if (gnArray.length > 10) {
    topGN = gnArray.slice(0, 9);
    othersCount = gnArray.slice(9).reduce((sum, item) => sum + item.count, 0);
    if (othersCount > 0) {
      topGN.push({gn: 'Outros', count: othersCount});
    }
  } else {
    topGN = gnArray;
  }

  const labels = topGN.map(item => {
    let displayName = item.gn;
    displayName = displayName.replace(/^G\.N\.\s*/i, '');
    return displayName;
  });
  
  const data = topGN.map(item => item.count);
  
  const total = data.reduce((a, b) => a + b, 0);
  const percentages = data.map(value => ((value / total) * 100).toFixed(1));
  
  const backgroundColors = topGN.map((item, index) => {
    if (item.gn === 'Outros') return '#95A5A6';
    return index === 0 ? BRAND_ORANGE : GN_PALETTE[index % GN_PALETTE.length];
  });

  const centerDiv = $('chartGNCenter');
  centerDiv.innerHTML = `
    <div class="doughnut-center-name">Total</div>
    <div class="doughnut-center-value">${total}</div>
  `;

  const legendDiv = $('legendGN');
  let legendHtml = `
    <div style="font-size:13px; font-weight:600; color:var(--brand-blue); margin-bottom:10px; padding-bottom:5px; border-bottom:2px solid var(--border);">
      <i class="fa-solid fa-list"></i> Legenda GN (Top ${topGN.length})
    </div>
  `;
  
  topGN.forEach((item, index) => {
    const perc = percentages[index];
    const isHighlighted = index === 0 && item.gn !== 'Outros';
    
    legendHtml += `
      <div style="display:flex; align-items:center; font-size:11px; margin-bottom:8px; padding:6px 8px; border-radius:6px; 
                  background: ${isHighlighted ? 'rgba(255, 138, 61, 0.1)' : 'transparent'}; 
                  border-left: 3px solid ${backgroundColors[index]};
                  cursor: pointer;"
           onclick="filterByGN('${item.gn === 'Outros' ? '' : item.gn}')">
        <div style="display:flex; align-items:center; flex:1;">
          <div style="width:12px; height:12px; border-radius:50%; background:${backgroundColors[index]}; margin-right:10px; 
                      ${isHighlighted ? 'box-shadow: 0 0 0 2px rgba(255, 138, 61, 0.2);' : ''}"></div>
          <div style="flex:1; font-weight:${isHighlighted ? '700' : '500'}; color:${isHighlighted ? 'var(--brand-orange)' : 'var(--text)'}">
            ${labels[index]}
          </div>
        </div>
        <div style="text-align:right; font-weight:600; color:var(--brand-blue); min-width: 70px;">
          ${item.count} (${perc}%)
        </div>
      </div>
    `;
  });
  
  legendDiv.innerHTML = legendHtml;

  charts.chartGNDistribution = new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: labels,
      datasets: [{
        data: data,
        backgroundColor: backgroundColors,
        borderWidth: 2,
        borderColor: '#fff',
        hoverBorderWidth: 3,
        hoverBorderColor: '#fff'
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      cutout: '70%',
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            label: function(context) {
              const label = context.label || '';
              const value = context.raw || 0;
              const total = context.dataset.data.reduce((a, b) => a + b, 0);
              const percentage = ((value / total) * 100).toFixed(1);
              return `${label}: ${value} (${percentage}%)`;
            }
          }
        },
        datalabels: {
          display: true,
          color: '#fff',
          font: { weight: 'bold', size: 11 },
          formatter: (value, context) => {
            const total = context.dataset.data.reduce((a, b) => a + b, 0);
            const percentage = ((value / total) * 100).toFixed(1);
            return `${percentage}%`;
          }
        }
      },
      onClick: (e, elements) => {
        if (elements.length > 0) {
          const index = elements[0].index;
          const gn = topGN[index].gn;
          if (gn !== 'Outros') {
            filterByGN(gn);
          }
        }
      }
    },
    plugins: [ChartDataLabels]
  });
}

function createDoughnutChart(id, dataObj, centerId, legendId, title) {
  let processed = [];
  for (let key in dataObj) {
    processed.push({ keyNorm: key, keyDisplay: key, count: dataObj[key] });
  }

  processed.sort((a,b)=>b.count-a.count);
  let top = processed.slice(0,7);
  let othersCount = processed.slice(7).reduce((acc, cur)=>acc+cur.count, 0);
  if (othersCount>0) top.push({ keyNorm: 'Outros', keyDisplay: 'Outros', count: othersCount });

  const labels = top.map(x=>x.keyDisplay);
  const data = top.map(x=>x.count);

  const ctx = $(id).getContext('2d');
  if(charts[id]) charts[id].destroy();

  const total = data.reduce((a,b)=>a+b,0);
  $(centerId).innerHTML = `<div class="doughnut-center-name">${title}</div><div class="doughnut-center-value">${total}</div>`;

  let legendHtml = '';
  top.forEach((item, i) => {
    const perc = total > 0 ? Math.round((item.count/total)*100) : 0;
    legendHtml += `<div style="display:flex;align-items:center;font-size:11px;margin-bottom:4px;color:var(--text);padding:4px 0;border-bottom:1px solid var(--border-light);">
      <span style="width:10px;height:10px;border-radius:50%;background:${GN_PALETTE[i%GN_PALETTE.length]};margin-right:8px;"></span>
      <span class="truncated" style="flex:1;max-width:100px" title="${item.keyDisplay}">${item.keyDisplay}</span>
      <span style="margin-left:auto;font-weight:600;color:var(--brand-blue)">${item.count} (${perc}%)</span>
    </div>`;
  });
  $(legendId).innerHTML = legendHtml;

  charts[id] = new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: labels,
      datasets: [{
        data: data,
        backgroundColor: labels.map((_, i) => GN_PALETTE[i % GN_PALETTE.length]),
        borderWidth: 2,
        borderColor: '#fff'
      }]
    },
    options: {
      responsive: true, 
      maintainAspectRatio: false, 
      cutout: '70%',
      plugins: {
        legend: { display: false },
        datalabels: {
          display: true, 
          color: '#fff', 
          font: { weight: 'bold', size: 11 },
          formatter: (value, context) => {
            const total = context.dataset.data.reduce((a, b) => a + b, 0);
            const percentage = Math.round((value / total) * 100);
            return `${percentage}%`;
          }
        }
      },
      onClick: (e, els) => {
        if(!els.length) return;
        const idx = els[0].index;
        const displayVal = labels[idx];
        if (displayVal === 'Outros') return;
        if (title === 'Subclasse') {
          if ($('subSelect').value === displayVal) {
            $('subSelect').value = '';
            showToast(`Filtro de subclasse removido`, 'info');
          } else {
            $('subSelect').value = displayVal;
            showToast(`Filtrando por subclasse: ${displayVal}`, 'success');
          }
          applyAllFilters();
        }
      }
    },
    plugins: [ChartDataLabels]
  });
}

// CORRE√á√ÉO: Fun√ß√£o createLineChart atualizada
function createLineChart(id, totalPoints, closedPoints) {
  const ctx = $(id).getContext('2d');
  if(charts[id]) charts[id].destroy();

  const labels = totalPoints.map(p => moment(p.x).format('YYYY-MM-DD'));
  const totalData = totalPoints.map(p => p.y);
  const closedData = closedPoints.map(p => p.y);

  const isDateFiltered = CHART_FILTERS['Evo Date'] !== null;
  
  let gradient;
  if (!isDateFiltered) {
    gradient = ctx.createLinearGradient(0, 0, 0, 280);
    gradient.addColorStop(0, 'rgba(46, 90, 167, 0.3)');
    gradient.addColorStop(1, 'rgba(46, 90, 167, 0)');
  }

  charts[id] = new Chart(ctx, {
    type: 'line',
    data: {
      labels: labels,
      datasets: [
        {
          label: 'Total',
          data: totalData,
          borderColor: BRAND_BLUE,
          backgroundColor: isDateFiltered ? 'transparent' : gradient,
          fill: !isDateFiltered,
          tension: 0.4,
          pointRadius: labels.map(d => d === CHART_FILTERS['Evo Date'] ? 8 : 4),
          pointHoverRadius: 8,
          pointBackgroundColor: labels.map(d => d === CHART_FILTERS['Evo Date'] ? BRAND_ORANGE : BRAND_YELLOW),
          pointBorderColor: BRAND_BLUE,
          pointBorderWidth: 2,
          borderWidth: isDateFiltered ? 1 : 3
        },
        {
          label: 'Conclu√≠do',
          data: closedData,
          borderColor: SUCCESS_GREEN,
          backgroundColor: 'transparent',
          borderWidth: 2,
          borderDash: [5, 5],
          tension: 0.4,
          pointRadius: 3,
          pointHoverRadius: 6,
          pointBackgroundColor: SUCCESS_GREEN,
          pointBorderColor: '#fff',
          pointBorderWidth: 1,
          pointStyle: 'rect'
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: { mode: 'nearest', intersect: true },
      plugins: {
        legend: { 
          display: true, 
          position: 'top', 
          labels: { 
            usePointStyle: true, 
            padding: 20,
            font: { size: 12 }
          } 
        },
        tooltip: {
          callbacks: {
            title: (items) => {
              return moment(items[0].label).format('ddd, DD/MM/YYYY');
            },
            label: (ctx) => `${ctx.dataset.label}: ${ctx.parsed.y}`
          }
        }
      },
      scales: {
        x: {
          type: 'time',
          time: { 
            unit: 'day', 
            parser: 'YYYY-MM-DD',
            displayFormats: { day: 'DD/MM' }, 
            tooltipFormat: 'DD/MM/YYYY'
          },
          distribution: 'series',
          bounds: 'ticks',
          grid: { display: false },
          ticks: { 
            maxRotation: 45,
            font: { size: 11 },
            autoSkip: true
          }
        },
        y: { 
          beginAtZero: true, 
          grid: { color: '#e8eef5' }, 
          ticks: { stepSize: 1 } 
        }
      },
      onClick: (e, elements) => {
        if (!elements.length) return;
        const element = elements[0];
        const datasetIndex = element.datasetIndex;
        const index = element.index;
        
        if (datasetIndex === 0) {
          const dateLabel = labels[index];
          const dateISO = dateLabel;
          
          // CORRE√á√ÉO: Toggle do filtro de data
          if (CHART_FILTERS['Evo Date'] === dateISO) {
            CHART_FILTERS['Evo Date'] = null;
            // Limpa os inputs de data se eles tiverem a mesma data
            if ($('dateStart').value === dateISO && $('dateEnd').value === dateISO) {
              $('dateStart').value = '';
              $('dateEnd').value = '';
            }
            $('datePreset').value = '';
            showToast(`Filtro de data removido`, 'info');
          } else {
            CHART_FILTERS['Evo Date'] = dateISO;
            // Define apenas a data no formato correto para os inputs
            $('dateStart').value = dateISO;
            $('dateEnd').value = dateISO;
            $('datePreset').value = '';
            showToast(`Filtrando por data: ${moment(dateISO).format('DD/MM/YYYY')}`, 'success');
          }
          
          applyAllFilters();
        }
      }
    }
  });
}

function createHorizontalBarChart(id, labels, data) {
  const ctx = $(id).getContext('2d');
  if(charts[id]) charts[id].destroy();

  const barHeight = 25;
  const minHeight = 300;
  const calculatedHeight = Math.max(minHeight, labels.length * barHeight + 50);
  
  const container = ctx.canvas.parentNode;
  container.style.height = calculatedHeight + 'px';

  charts[id] = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: labels,
      datasets: [{
        label: 'Ocorr√™ncias',
        data: data,
        backgroundColor: labels.map((_, index) => 
          GN_PALETTE[index % GN_PALETTE.length]
        ),
        barThickness: 20,
        borderRadius: 6
      }]
    },
    options: {
      indexAxis: 'y',
      responsive: true,
      maintainAspectRatio: false,
      onClick: (e, els) => {
        if(els.length > 0) {
          const idx = els[0].index;
          const val = labels[idx];
          
          if (CHART_FILTERS['Motivo'] === val || $('motivoSelect').value === val) {
            CHART_FILTERS['Motivo'] = null;
            $('motivoSelect').value = '';
            showToast(`Filtro do motivo "${val}" removido`, 'info');
          } else {
            CHART_FILTERS['Motivo'] = val;
            $('motivoSelect').value = val;
            showToast(`Filtrando por motivo: ${val}`, 'success');
          }
          
          applyAllFilters();
        }
      },
      plugins: {
        legend: { display: false },
        datalabels: {
          color: '#000', 
          anchor: 'end', 
          align: 'right', 
          formatter: (val) => val, 
          font: { weight: 'bold', size: 12 }
        }
      },
      scales: {
        x: { 
          beginAtZero: true, 
          grid: { display: false }, 
          ticks: { stepSize: 1 } 
        },
        y: { 
          grid: { display: false }, 
          ticks: { 
            font: { size: 12 },
            autoSkip: false
          } 
        }
      }
    },
    plugins: [ChartDataLabels]
  });
}

function renderTable() {
  const tbody = document.querySelector('#dataTable tbody');
  tbody.innerHTML = '';

  const sortedData = [...FILTERED].sort((a,b) => {
    let valA = a[CURRENT_SORT.key];
    let valB = b[CURRENT_SORT.key];

    if (CURRENT_SORT.key === 'dtStart' || CURRENT_SORT.key === 'dtEnd') {
      valA = valA ? new Date(valA).getTime() : 0;
      valB = valB ? new Date(valB).getTime() : 0;
    } else {
      if(valA == null) valA = "";
      if(valB == null) valB = "";
      if (typeof valA === 'string') valA = valA.toLowerCase();
      if (typeof valB === 'string') valB = valB.toLowerCase();
    }

    if (valA < valB) return CURRENT_SORT.direction === 'asc' ? -1 : 1;
    if (valA > valB) return CURRENT_SORT.direction === 'asc' ? 1 : -1;
    return 0;
  });

  const totalPages = Math.ceil(sortedData.length / ITEMS_PER_PAGE);
  if(CURRENT_PAGE > totalPages) CURRENT_PAGE = 1;

  const start = (CURRENT_PAGE - 1) * ITEMS_PER_PAGE;
  const end = start + ITEMS_PER_PAGE;
  const pageData = sortedData.slice(start, end);

  $('paginationInfo').innerText = `${sortedData.length ? start+1 : 0}-${Math.min(end, sortedData.length)} de ${sortedData.length}`;
  $('prevPage').disabled = CURRENT_PAGE === 1;
  $('nextPage').disabled = CURRENT_PAGE >= totalPages || totalPages === 0;

  if(pageData.length === 0) {
    tbody.innerHTML = `<tr><td colspan="12" style="text-align:center;padding:20px;color:var(--muted)">Nenhum dado encontrado</td></tr>`;
    return;
  }

  pageData.forEach((row, index) => {
    const tr = document.createElement('tr');
    tr.style.animation = `fadeIn 0.3s ease-out ${index * 0.05}s forwards`;
    tr.style.opacity = '0';

    let statusClass = row.statusNorm === 'Fechado' ? 'st-fechado' : 'st-aberto';
    let statusText = row.statusNorm === 'Fechado' ? 'Conclu√≠do' : 'Em Aberto';

    const dtStart = row.dtStart ? moment(row.dtStart).format('DD/MM/YYYY') : '-';
    const dtEnd = row.dtEnd ? moment(row.dtEnd).format('DD/MM/YYYY') : '-';

    const fcrColor = row.fcr === 'Sim' ? 'color:var(--success-green);font-weight:700;' : 'color:var(--text-light);';

    let tempoCor = 'color:var(--text-light);';
    if (row.tempoResolucaoDias !== null) {
      if (row.tempoResolucaoDias > 7) tempoCor = 'color:var(--error-red);font-weight:700;';
      else if (row.tempoResolucaoDias > 3) tempoCor = 'color:var(--brand-orange);font-weight:600;';
      else if (row.tempoResolucaoDias > 0) tempoCor = 'color:var(--success-green);font-weight:600;';
    }

    let tipoCor = 'color:var(--text-light);';
    if (row.tipoContato === 'Ativo') tipoCor = 'color:#4A76C2;font-weight:600;';
    else if (row.tipoContato === 'Receptivo') tipoCor = 'color:#FFA971;font-weight:600;';

    let origemCor = 'color:var(--text-light);';
    if (row.origemContato === 'Whatsapp') origemCor = 'color:#25D366;font-weight:600;';
    else if (row.origemContato === 'Telefone') origemCor = 'color:#34B7F1;font-weight:600;';
    else if (row.origemContato === 'E-mail') origemCor = 'color:#EA4335;font-weight:600;';
    else if (row.origemContato === 'Teams') origemCor = 'color:#7B83EB;font-weight:600;';

    tr.innerHTML = `
      <td><span class="status-pill ${statusClass}">${statusText}</span></td>
      <td>${dtStart}</td>
      <td>${dtEnd}</td>
      <td style="${tempoCor}">${row.tempoResolucaoFormatado}</td>
      <td style="${fcrColor}">${row.fcr}</td>
      <td style="font-weight:600;color:var(--brand-blue)">${row.analista}</td>
      <td class="truncated" title="${row.gn}">${row.gn}</td>
      <td class="truncated" title="${row.motivo}">${row.motivo}</td>
      <td class="truncated" title="${row.sub}">${row.sub}</td>
      <td class="truncated" title="${row.solicitante}">${row.solicitante}</td>
      <td style="${tipoCor}">${row.tipoContato}</td>
      <td style="${origemCor}">${row.origemContato}</td>
    `;
    
    tr.addEventListener('click', () => {
      if (CHART_FILTERS['Table Row'] === row.uid) {
        CHART_FILTERS['Table Row'] = null;
        tr.classList.remove('active-filter');
        showToast('Filtro de linha espec√≠fica removido', 'info');
      } else {
        CHART_FILTERS['Table Row'] = row.uid;
        document.querySelectorAll('#dataTable tr.active-filter').forEach(r => {
          r.classList.remove('active-filter');
        });
        tr.classList.add('active-filter');
        showToast(`Filtrando por caso espec√≠fico`, 'success');
      }
      applyAllFilters();
    });
    
    if (CHART_FILTERS['Table Row'] === row.uid) {
      tr.classList.add('active-filter');
    }
    
    tbody.appendChild(tr);
  });

  document.querySelectorAll('#dataTable th .sort-indicator').forEach(el => el.innerHTML = '');
  const activeHeader = document.querySelector(`#dataTable th[data-key="${CURRENT_SORT.key}"] .sort-indicator`);
  if(activeHeader) activeHeader.innerHTML = CURRENT_SORT.direction === 'asc' ? '‚ñ≤' : '‚ñº';
}

function sortTable(key) {
  if (CURRENT_SORT.key === key) {
    CURRENT_SORT.direction = CURRENT_SORT.direction === 'asc' ? 'desc' : 'asc';
  } else {
    CURRENT_SORT.key = key;
    CURRENT_SORT.direction = 'asc';
  }
  
  document.querySelectorAll('#dataTable th .sort-indicator').forEach(el => {
    el.innerHTML = '';
  });
  
  const activeHeader = document.querySelector(`#dataTable th[data-key="${key}"] .sort-indicator`);
  if (activeHeader) {
    activeHeader.innerHTML = CURRENT_SORT.direction === 'asc' ? '‚ñ≤' : '‚ñº';
  }
  
  renderTable();
}

function changePage(delta) {
  CURRENT_PAGE += delta;
  renderTable();
}

function handleDatePreset() {
  const val = $('datePreset').value;
  const today = new Date();
  let start = new Date();

  if(!val) return;

  // CORRE√á√ÉO: Limpar filtro do gr√°fico quando usar preset
  CHART_FILTERS['Evo Date'] = null;

  switch(val) {
    case 'last7': start.setDate(today.getDate()-7); break;
    case 'last30': start.setDate(today.getDate()-30); break;
    case 'currentMonth': start = new Date(today.getFullYear(), today.getMonth(), 1); break;
    case 'lastMonth':
      start = new Date(today.getFullYear(), today.getMonth()-1, 1);
      today.setDate(0);
      break;
    case 'currentYear': start = new Date(today.getFullYear(), 0, 1); break;
    case 'fullRange':
      $('dateStart').value = '';
      $('dateEnd').value = '';
      applyAllFilters();
      return;
  }

  $('dateStart').value = start.toISOString().split('T')[0];
  $('dateEnd').value = new Date().toISOString().split('T')[0];
  applyAllFilters();
}

function updateActiveFiltersDisplay() {
  const container = $('activeFilters');
  container.innerHTML = '';

  const addTag = (label, onClick, color) => {
    const tag = document.createElement('div');
    tag.className = 'filter-tag';
    tag.innerHTML = `${label} <i class="fa-solid fa-xmark"></i>`;
    if (color) tag.style.background = color;
    tag.onclick = onClick;
    container.appendChild(tag);
  };

  if($('qSearch').value) addTag(`Busca: "${$('qSearch').value}"`, () => { $('qSearch').value=''; applyAllFilters(); });
  if($('motivoSelect').value) addTag(`Motivo: ${$('motivoSelect').value}`, () => { $('motivoSelect').value=''; applyAllFilters(); });
  if($('analistaSelect').value) addTag(`Analista: ${$('analistaSelect').value}`, () => { $('analistaSelect').value=''; applyAllFilters(); });
  if($('subSelect').value) addTag(`Subclasse: ${$('subSelect').value}`, () => { $('subSelect').value=''; applyAllFilters(); });
  if($('gnSelect').value) addTag(`GN: ${$('gnSelect').value}`, () => { $('gnSelect').value=''; applyAllFilters(); });
  if($('tipoContatoSelect').value) addTag(`Tipo: ${$('tipoContatoSelect').value}`, () => { $('tipoContatoSelect').value=''; applyAllFilters(); });

  if(CHART_FILTERS['Status']) {
    const color = CHART_FILTERS['Status'] === 'Aberto' ? 'linear-gradient(135deg, var(--brand-orange), var(--brand-orange-light))' : 'linear-gradient(135deg, var(--success-green), var(--success-green-light))';
    addTag(`Status: ${CHART_FILTERS['Status']}`, () => { $('kpiTotal').click(); }, color);
  }
  if(CHART_FILTERS['FCR_Sim']) {
    addTag(`FCR: Sim`, () => { CHART_FILTERS['FCR_Sim'] = null; $('kpiTotal').click(); });
  }
  if(CHART_FILTERS['AvgTime']) {
    addTag(`Tempo M√©dio: Ativo`, () => { CHART_FILTERS['AvgTime'] = null; $('kpiTotal').click(); }, 'linear-gradient(135deg, var(--purple), var(--purple-light))');
  }
  if(CHART_FILTERS['Doughnut Selection']['Analista']) {
    addTag(`Analista: ${CHART_FILTERS['Doughnut Selection']['Analista']}`, () => { delete CHART_FILTERS['Doughnut Selection']['Analista']; $('analistaSelect').value=''; applyAllFilters(); });
  }
  if(CHART_FILTERS['Doughnut Selection']['GN']) {
    addTag(`GN: ${CHART_FILTERS['Doughnut Selection']['GN']}`, () => { delete CHART_FILTERS['Doughnut Selection']['GN']; $('gnSelect').value=''; applyAllFilters(); });
  }

  // CORRE√á√ÉO: Exibi√ß√£o do filtro de data do gr√°fico
  if(CHART_FILTERS['Evo Date']) {
    addTag(`Data: ${moment(CHART_FILTERS['Evo Date']).format('DD/MM/YYYY')}`, () => { 
      CHART_FILTERS['Evo Date'] = null;
      // S√≥ limpa os inputs se eles tiverem a mesma data do filtro
      if ($('dateStart').value === CHART_FILTERS['Evo Date'] && $('dateEnd').value === CHART_FILTERS['Evo Date']) {
        $('dateStart').value = '';
        $('dateEnd').value = '';
      }
      applyAllFilters(); 
    }, 'linear-gradient(135deg, var(--brand-blue), var(--brand-blue-light))');
  } else if($('dateStart').value || $('dateEnd').value) {
    const dateLabel = `${$('dateStart').value ? moment($('dateStart').value).format('DD/MM/YYYY') : 'In√≠cio'} a ${$('dateEnd').value ? moment($('dateEnd').value).format('DD/MM/YYYY') : 'Fim'}`;
    addTag(`Per√≠odo: ${dateLabel}`, () => {
      $('dateStart').value = '';
      $('dateEnd').value = '';
      $('datePreset').value = '';
      // Garantir que filtro do gr√°fico tamb√©m seja limpo
      CHART_FILTERS['Evo Date'] = null;
      applyAllFilters();
    });
  } else if($('datePreset').value) {
    const presetText = $('datePreset').options[$('datePreset').selectedIndex].text;
    addTag(`Per√≠odo: ${presetText}`, () => { 
      $('datePreset').value = '';
      // Garantir que filtro do gr√°fico tamb√©m seja limpo
      CHART_FILTERS['Evo Date'] = null;
      applyAllFilters(); 
    });
  }

  if(CHART_FILTERS['Origem']) {
    addTag(`Origem: ${CHART_FILTERS['Origem']}`, () => { 
      CHART_FILTERS['Origem'] = null; 
      applyAllFilters(); 
    });
  }
}

function clearAllFilters() {
  $('qSearch').value = '';
  $('motivoSelect').value = '';
  $('analistaSelect').value = '';
  $('subSelect').value = '';
  $('gnSelect').value = '';
  $('tipoContatoSelect').value = '';
  $('dateStart').value = '';
  $('dateEnd').value = '';
  $('datePreset').value = '';
  CHART_FILTERS = { 
    'Table Row': null, 
    'Evo Date': null, 
    'Status': null, 
    'FCR_Sim': null, 
    'Date Preset': null, 
    'Doughnut Selection': {},
    'Motivo': null,
    'Analista': null,
    'GN': null,
    'Subclassifica√ß√£o': null,
    'TipoContato': null,
    'AvgTime': null,
    'Origem': null
  };
  CURRENT_SORT = { key: 'dtStart', direction: 'desc' };
  CURRENT_PAGE = 1;
  applyAllFilters();
  showToast('Todos os filtros foram limpos', 'info');
}

function generateGamification() {
  const board = $('gamificationBoard');
  const counts = {};
  FILTERED.forEach(d => counts[d.analista] = (counts[d.analista]||0)+1);
  const sorted = Object.entries(counts).sort((a,b)=>b[1]-a[1]).slice(0, 10);

  if(sorted.length === 0) {
    board.innerHTML = '<div style="padding:15px;text-align:center;color:var(--muted)">Sem dados para exibir o ranking</div>';
    return;
  }

  let html = '<div style="max-height:300px;overflow-y:auto;">';
  const maxCount = sorted[0][1];
  sorted.forEach((item, index) => {
    const medal = index === 0 ? 'ü•á' : (index === 1 ? 'ü•à' : (index === 2 ? 'ü•â' : ''));
    const percentage = maxCount > 0 ? Math.round((item[1]/maxCount)*100) : 0;
    const barWidth = Math.max(20, percentage);
    html += `
      <div style="display:flex;align-items:center;padding:12px 15px;border-bottom:1px solid var(--border-light);transition:var(--transition-fast);cursor:pointer;"
      onclick="filterByChartSegment('Analista', '${item[0]}')">
        <div style="font-weight:900;color:var(--brand-blue);width:25px;font-size:14px;">${index+1}</div>
        <div style="flex:1;margin-left:10px;">
          <div style="font-weight:700;font-size:13px">${item[0]} ${medal}</div>
          <div style="font-size:11px;color:var(--text-light)">${item[1]} solicita√ß√µes</div>
        </div>
        <div style="width:80px;height:6px;background:#e8eef5;border-radius:3px;overflow:hidden;margin-left:10px;">
          <div style="width:${barWidth}%;height:100%;background:linear-gradient(90deg, var(--brand-blue), var(--brand-blue-light));transition:width 0.5s;"></div>
        </div>
        <div style="font-weight:700;color:var(--brand-blue);margin-left:10px;font-size:12px;">${item[1]}</div>
      </div>`;
  });
  html += '</div>';
  board.innerHTML = html;
}

function filterByChartSegment(filterKey, filterValue) {
  if (filterKey === 'Analista') {
    if(CHART_FILTERS['Doughnut Selection']['Analista'] === filterValue) {
      delete CHART_FILTERS['Doughnut Selection']['Analista'];
      $('analistaSelect').value = '';
      showToast(`Filtro do analista "${filterValue}" removido`, 'info');
    } else {
      CHART_FILTERS['Doughnut Selection']['Analista'] = filterValue;
      $('analistaSelect').value = filterValue;
      showToast(`Filtrando por analista: ${filterValue}`, 'success');
    }
    applyAllFilters();
  }
}

function showLoading(show, text) {
  $('loading').style.display = show ? 'flex' : 'none';
  if(text) $('loadingText').innerText = text;
  if (!show) {
    resetLoadingProgress();
  }
}

function showToast(msg, type) {
  document.querySelectorAll('.toast').forEach(t => t.remove());
  const t = document.createElement('div');
  t.className = 'toast';
  t.style.cssText = `
    position: fixed; top: 100px; right: 30px;
    background: ${type === 'success' ? 'linear-gradient(135deg, var(--success-green), var(--success-green-light))' :
    type === 'error' ? 'linear-gradient(135deg, var(--error-red), #FF6B6B)' :
    type === 'info' ? 'linear-gradient(135deg, var(--brand-blue), var(--brand-blue-light))' :
    type === 'purple' ? 'linear-gradient(135deg, var(--purple), var(--purple-light))' :
    'linear-gradient(135deg, var(--warning), #F1C40F)'};
    color: white; padding: 15px 20px; border-radius: var(--border-radius-sm);
    box-shadow: var(--shadow-xl); z-index: 10000; display: flex; align-items: center; gap: 12px;
    transform: translateX(400px); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); max-width: 350px;
  `;
  const icon = type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : type === 'info' ? 'fa-info-circle' : type === 'purple' ? 'fa-hourglass-half' : 'fa-lightbulb';
  t.innerHTML = `<i class="fa-solid ${icon}" style="font-size:20px;"></i><div style="flex:1;font-weight:600;font-size:13px;">${msg}</div>`;
  document.body.appendChild(t);
  setTimeout(() => t.style.transform = 'translateX(0)', 10);
  setTimeout(() => { t.style.transform = 'translateX(400px)'; setTimeout(() => t.remove(), 300); }, 4000);
}

function addRippleEffect(e) {
  const btn = e.currentTarget;
  const circle = document.createElement('span');
  const d = Math.max(btn.clientWidth, btn.clientHeight);
  const rect = btn.getBoundingClientRect();
  circle.style.width = circle.style.height = d + 'px';
  circle.style.left = e.clientX - rect.left - d/2 + 'px';
  circle.style.top = e.clientY - rect.top - d/2 + 'px';
  circle.style.position = 'absolute';
  circle.style.borderRadius = '50%';
  circle.style.backgroundColor = 'rgba(255, 255, 255, 0.7)';
  circle.style.transform = 'scale(0)';
  circle.style.animation = 'ripple 0.6s linear';
  circle.style.pointerEvents = 'none';
  btn.style.overflow = 'hidden';
  btn.style.position = 'relative';
  btn.appendChild(circle);
  setTimeout(()=>{
    circle.remove();
    btn.style.overflow = '';
  }, 600);
}

const style = document.createElement('style');
style.textContent = `
@keyframes ripple {
  to { transform: scale(4); opacity: 0; }
}
.pagination {
  display: flex; align-items: center; gap: 8px;
}
.pagination-info {
  font-size: 12px; color: var(--text-light); font-weight: 500;
}
.pagination-btn {
  width: 32px; height: 32px; border-radius: 6px;
  border: 1px solid var(--border); background: white;
  color: var(--brand-blue); cursor: pointer; display: flex;
  align-items: center; justify-content: center; transition: var(--transition-fast);
}
.pagination-btn:hover {
  background: var(--brand-blue); color: white; border-color: var(--brand-blue);
}
.pagination-btn:disabled {
  opacity: 0.5; cursor: not-allowed; background: #f5f5f5;
}
`;
document.head.appendChild(style);

function updateLastUpdateTime() {
  const now = new Date();
  $('lastUpdateTime').innerText = now.toLocaleTimeString('pt-BR', {hour:'2-digit', minute:'2-digit'});
  LAST_UPDATE_TIME = now;
}

function toggleTheme() {
  document.body.classList.toggle('dark-theme');
  localStorage.setItem('dashboard-theme', document.body.classList.contains('dark-theme')?'dark':'light');
  showToast(`Tema ${document.body.classList.contains('dark-theme')?'escuro':'claro'} ativado`, 'info');
}

function toggleFullScreen() {
  if(!document.fullscreenElement) {
    document.documentElement.requestFullscreen().catch(err => {
      showToast(`Erro ao entrar em tela cheia: ${err.message}`, 'error');
    });
  } else {
    document.exitFullscreen();
  }
}

function exportCSV() {
  if(FILTERED.length === 0) {
    showToast('N√£o h√° dados para exportar', 'warning');
    return;
  }
  try {
    const exportData = FILTERED.map(item => ({
      'Analista': item.analista,
      'Sub Classifica√ß√£o': item.sub,
      'Motivo': item.motivo,
      'Data Inicio': item.dtStart ? moment(item.dtStart).format('DD/MM/YYYY HH:mm') : '',
      'Data Fim': item.dtEnd ? moment(item.dtEnd).format('DD/MM/YYYY HH:mm') : '',
      'Tempo Resolu√ß√£o': item.tempoResolucaoFormatado,
      'CNPJ': item.cnpj,
      'Raz√£o Social': item.solicitante,
      'FCR': item.fcr,
      'GN': item.gn,
      'Status': item.status,
      'Tipo de Contato': item.tipoContato,
      'Origem do Contato': item.origemContato
    }));
    const ws = XLSX.utils.json_to_sheet(exportData);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "DadosExportados");
    const dateStr = moment().format('YYYY-MM-DD_HH-mm');
    XLSX.writeFile(wb, `Dashboard_Export_${dateStr}.xlsx`);
    showToast(`Exportado ${FILTERED.length} registros com sucesso`, 'success');
  } catch (err) {
    console.error('Erro na exporta√ß√£o:', err);
    showToast(`Erro ao exportar: ${err.message}`, 'error');
  }
}

function downloadChart(id, name) {
  try {
    const canvas = $(id);
    const link = document.createElement('a');
    link.download = name;
    link.href = canvas.toDataURL('image/png', 1.0);
    link.click();
    showToast(`Gr√°fico "${name}" exportado com sucesso`, 'success');
  } catch (err) {
    showToast('Erro ao exportar gr√°fico', 'error');
  }
}

setInterval(() => {
  if (LAST_UPDATE_TIME) {
    const now = new Date();
    const diff = (now - LAST_UPDATE_TIME) / 1000 / 60;
    if (diff >= 5) {
      showToast('Atualizando dados automaticamente...', 'info');
      initLoadFromGitHub();
    }
  }
}, 30000);

document.addEventListener('mouseover', (e) => {
  if (e.target.classList.contains('truncated') && e.target.offsetWidth < e.target.scrollWidth) {
    const tooltip = document.createElement('div');
    tooltip.className = 'tooltip';
    tooltip.textContent = e.target.title || e.target.textContent;
    document.body.appendChild(tooltip);
    const rect = e.target.getBoundingClientRect();
    tooltip.style.left = rect.left + 'px';
    tooltip.style.top = (rect.top - tooltip.offsetHeight - 10) + 'px';
    tooltip.style.opacity = '1';
    e.target.addEventListener('mouseleave', () => {
      tooltip.style.opacity = '0';
      setTimeout(() => tooltip.remove(), 200);
    }, { once: true });
  }
});
</script>
</body>
</html>